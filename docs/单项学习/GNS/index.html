<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GNS å›¾ç½‘ç»œæ¨¡æ‹Ÿå™¨ â€” è¶…è¯¦ç»†å­¦ä¹ æ•™ç¨‹</title>

<!-- KaTeX for math rendering -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"
  onload="renderMathInElement(document.body, {
    delimiters: [
      {left: '$$', right: '$$', display: true},
      {left: '$', right: '$', display: false}
    ],
    throwOnError: false
  });"></script>

<style>
/* ===== CSS Variables ===== */
:root {
  --bg-primary: #ffffff;
  --bg-secondary: #f8f9fa;
  --bg-code: #f4f5f7;
  --bg-sidebar: #f0f2f5;
  --text-primary: #1a1a2e;
  --text-secondary: #4a4a6a;
  --text-muted: #8888aa;
  --border-color: #e0e0e8;
  --accent: #4361ee;
  --accent-light: #e8edff;
  --link: #4361ee;
  --shadow: 0 2px 12px rgba(0,0,0,0.06);
  --shadow-hover: 0 4px 20px rgba(0,0,0,0.1);
  --radius: 12px;
  --sidebar-width: 300px;
  --def-bg: #e8f4fd;
  --def-border: #3b82f6;
  --thm-bg: #ecfdf5;
  --thm-border: #10b981;
  --example-bg: #fefce8;
  --example-border: #f59e0b;
  --warn-bg: #fef2f2;
  --warn-border: #ef4444;
  --code-keyword: #d73a49;
  --code-string: #032f62;
  --code-comment: #6a737d;
  --code-function: #6f42c1;
  --code-number: #005cc5;
  --code-class: #e36209;
  --code-builtin: #005cc5;
  --code-decorator: #6f42c1;
  --code-self: #d73a49;
}

[data-theme="dark"] {
  --bg-primary: #0d1117;
  --bg-secondary: #161b22;
  --bg-code: #1c2333;
  --bg-sidebar: #0d1117;
  --text-primary: #e6edf3;
  --text-secondary: #8b949e;
  --text-muted: #6e7681;
  --border-color: #30363d;
  --accent: #58a6ff;
  --accent-light: #1c2d4a;
  --link: #58a6ff;
  --shadow: 0 2px 12px rgba(0,0,0,0.3);
  --shadow-hover: 0 4px 20px rgba(0,0,0,0.4);
  --def-bg: #0d1f3c;
  --def-border: #58a6ff;
  --thm-bg: #0d2818;
  --thm-border: #3fb950;
  --example-bg: #2d2000;
  --example-border: #d29922;
  --warn-bg: #2d0000;
  --warn-border: #f85149;
  --code-keyword: #ff7b72;
  --code-string: #a5d6ff;
  --code-comment: #8b949e;
  --code-function: #d2a8ff;
  --code-number: #79c0ff;
  --code-class: #ffa657;
  --code-builtin: #79c0ff;
  --code-decorator: #d2a8ff;
  --code-self: #ff7b72;
}

/* ===== Reset & Base ===== */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

html {
  scroll-behavior: smooth;
  scroll-padding-top: 80px;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans SC", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
  background: var(--bg-primary);
  color: var(--text-primary);
  line-height: 1.8;
  font-size: 16px;
  transition: background 0.3s, color 0.3s;
}

/* ===== Sidebar ===== */
.sidebar {
  position: fixed;
  left: 0;
  top: 0;
  width: var(--sidebar-width);
  height: 100vh;
  background: var(--bg-sidebar);
  border-right: 1px solid var(--border-color);
  overflow-y: auto;
  z-index: 100;
  padding: 20px 0;
  transition: transform 0.3s ease, background 0.3s;
}

.sidebar-header {
  padding: 10px 20px 20px;
  border-bottom: 1px solid var(--border-color);
  margin-bottom: 10px;
}

.sidebar-header h2 {
  font-size: 18px;
  color: var(--accent);
  margin-bottom: 4px;
}

.sidebar-header p {
  font-size: 12px;
  color: var(--text-muted);
}

.sidebar nav {
  padding: 0 12px;
}

.sidebar nav a {
  display: block;
  padding: 6px 12px;
  color: var(--text-secondary);
  text-decoration: none;
  font-size: 13px;
  border-radius: 6px;
  transition: all 0.2s;
  line-height: 1.5;
}

.sidebar nav a:hover {
  background: var(--accent-light);
  color: var(--accent);
}

.sidebar nav a.active {
  background: var(--accent-light);
  color: var(--accent);
  font-weight: 600;
}

.sidebar nav .chapter-title {
  font-weight: 700;
  color: var(--text-primary);
  font-size: 14px;
  padding: 12px 12px 4px;
  margin-top: 6px;
}

.sidebar nav .chapter-title:first-child {
  margin-top: 0;
}

/* ===== Main Content ===== */
.main-content {
  margin-left: var(--sidebar-width);
  max-width: 900px;
  padding: 30px 50px 80px;
}

/* ===== Top Bar ===== */
.top-bar {
  position: fixed;
  top: 0;
  left: var(--sidebar-width);
  right: 0;
  height: 56px;
  background: var(--bg-primary);
  border-bottom: 1px solid var(--border-color);
  display: flex;
  align-items: center;
  justify-content: flex-end;
  padding: 0 30px;
  z-index: 99;
  transition: background 0.3s;
  gap: 12px;
}

.top-bar .btn-theme {
  background: var(--bg-secondary);
  border: 1px solid var(--border-color);
  color: var(--text-primary);
  padding: 6px 14px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.2s;
}

.top-bar .btn-theme:hover {
  background: var(--accent-light);
  color: var(--accent);
}

.menu-toggle {
  display: none;
  background: var(--bg-secondary);
  border: 1px solid var(--border-color);
  color: var(--text-primary);
  padding: 6px 12px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 18px;
}

/* ===== Hero Section ===== */
.hero {
  margin-top: 56px;
  padding: 60px 0 40px;
  text-align: center;
}

.hero h1 {
  font-size: 2.8em;
  font-weight: 800;
  margin-bottom: 16px;
  background: linear-gradient(135deg, var(--accent), #7c3aed);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.hero .subtitle {
  font-size: 1.2em;
  color: var(--text-secondary);
  max-width: 700px;
  margin: 0 auto 30px;
}

.hero .badges {
  display: flex;
  gap: 10px;
  justify-content: center;
  flex-wrap: wrap;
}

.badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 14px;
  background: var(--bg-secondary);
  border: 1px solid var(--border-color);
  border-radius: 20px;
  font-size: 13px;
  color: var(--text-secondary);
}

/* ===== Headings ===== */
h2 {
  font-size: 2em;
  font-weight: 700;
  margin-top: 60px;
  margin-bottom: 20px;
  padding-bottom: 10px;
  border-bottom: 3px solid var(--accent);
  color: var(--text-primary);
}

h3 {
  font-size: 1.5em;
  font-weight: 600;
  margin-top: 40px;
  margin-bottom: 14px;
  color: var(--text-primary);
}

h4 {
  font-size: 1.2em;
  font-weight: 600;
  margin-top: 30px;
  margin-bottom: 10px;
  color: var(--text-primary);
}

p { margin-bottom: 14px; }

/* ===== Highlight Boxes ===== */
.box {
  padding: 20px 24px;
  border-radius: var(--radius);
  margin: 20px 0;
  border-left: 4px solid;
}

.box-title {
  font-weight: 700;
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.box.definition {
  background: var(--def-bg);
  border-color: var(--def-border);
}

.box.theorem {
  background: var(--thm-bg);
  border-color: var(--thm-border);
}

.box.example {
  background: var(--example-bg);
  border-color: var(--example-border);
}

.box.warning {
  background: var(--warn-bg);
  border-color: var(--warn-border);
}

/* ===== Code Blocks ===== */
.code-container {
  position: relative;
  margin: 16px 0;
  border-radius: var(--radius);
  overflow: hidden;
  border: 1px solid var(--border-color);
}

.code-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 16px;
  background: var(--bg-secondary);
  border-bottom: 1px solid var(--border-color);
  font-size: 12px;
  color: var(--text-muted);
}

.code-header .copy-btn {
  background: transparent;
  border: 1px solid var(--border-color);
  color: var(--text-secondary);
  padding: 3px 10px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 12px;
  transition: all 0.2s;
}

.code-header .copy-btn:hover {
  background: var(--accent-light);
  color: var(--accent);
}

pre {
  background: var(--bg-code);
  padding: 16px 20px;
  overflow-x: auto;
  font-size: 13.5px;
  line-height: 1.6;
  margin: 0;
}

code {
  font-family: "SF Mono", "Fira Code", "JetBrains Mono", Menlo, Consolas, monospace;
}

p code, li code {
  background: var(--bg-code);
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 0.9em;
  border: 1px solid var(--border-color);
}

/* ===== Syntax Highlighting ===== */
.kw { color: var(--code-keyword); font-weight: 600; }
.str { color: var(--code-string); }
.cmt { color: var(--code-comment); font-style: italic; }
.fn { color: var(--code-function); }
.num { color: var(--code-number); }
.cls { color: var(--code-class); }
.bi { color: var(--code-builtin); }
.dec { color: var(--code-decorator); }
.sf { color: var(--code-self); font-weight: 600; }

/* ===== Tables ===== */
table {
  width: 100%;
  border-collapse: collapse;
  margin: 20px 0;
  font-size: 14px;
}

th, td {
  padding: 12px 16px;
  border: 1px solid var(--border-color);
  text-align: left;
}

th {
  background: var(--bg-secondary);
  font-weight: 600;
}

tr:nth-child(even) {
  background: var(--bg-secondary);
}

/* ===== SVG Diagrams ===== */
.diagram {
  text-align: center;
  margin: 30px 0;
}

.diagram svg {
  max-width: 100%;
}

.diagram figcaption {
  font-size: 13px;
  color: var(--text-muted);
  margin-top: 8px;
}

/* ===== Lists ===== */
ul, ol {
  padding-left: 24px;
  margin-bottom: 14px;
}

li { margin-bottom: 6px; }

/* ===== Responsive ===== */
@media (max-width: 960px) {
  .sidebar {
    transform: translateX(-100%);
  }
  .sidebar.open {
    transform: translateX(0);
  }
  .main-content {
    margin-left: 0;
    padding: 30px 20px 80px;
  }
  .top-bar {
    left: 0;
  }
  .menu-toggle {
    display: block;
  }
  .hero h1 {
    font-size: 2em;
  }
}

/* ===== Scrollbar ===== */
.sidebar::-webkit-scrollbar { width: 6px; }
.sidebar::-webkit-scrollbar-thumb {
  background: var(--border-color);
  border-radius: 3px;
}

/* ===== Progress Bar ===== */
.progress-bar {
  position: fixed;
  top: 56px;
  left: var(--sidebar-width);
  right: 0;
  height: 3px;
  background: var(--border-color);
  z-index: 98;
}
.progress-bar .fill {
  height: 100%;
  background: var(--accent);
  width: 0%;
  transition: width 0.1s;
}

@media (max-width: 960px) {
  .progress-bar { left: 0; }
}

/* ===== Flow Diagram ===== */
.flow-diagram {
  display: flex;
  align-items: center;
  justify-content: center;
  flex-wrap: wrap;
  gap: 8px;
  margin: 20px 0;
}

.flow-box {
  background: var(--accent-light);
  border: 2px solid var(--accent);
  color: var(--accent);
  padding: 10px 18px;
  border-radius: 10px;
  font-weight: 600;
  font-size: 14px;
  text-align: center;
}

.flow-arrow {
  font-size: 20px;
  color: var(--accent);
}

/* ===== Comparison Grid ===== */
.compare-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
  margin: 20px 0;
}

.compare-card {
  padding: 20px;
  border-radius: var(--radius);
  border: 1px solid var(--border-color);
  background: var(--bg-secondary);
}

.compare-card h4 {
  margin-top: 0;
  color: var(--accent);
}

@media (max-width: 600px) {
  .compare-grid { grid-template-columns: 1fr; }
}

/* ===== Anchor link ===== */
h2[id], h3[id], h4[id] {
  scroll-margin-top: 80px;
}

/* ===== Inline Math ===== */
.katex-display { margin: 20px 0; }

/* ===== Back to top ===== */
.back-to-top {
  position: fixed;
  bottom: 30px;
  right: 30px;
  width: 44px;
  height: 44px;
  border-radius: 50%;
  background: var(--accent);
  color: #fff;
  border: none;
  font-size: 20px;
  cursor: pointer;
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 90;
  box-shadow: var(--shadow);
  transition: opacity 0.3s;
}

.back-to-top.visible {
  display: flex;
}
</style>
</head>
<body>

<!-- Sidebar -->
<aside class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <h2>ğŸ“Š GNS æ•™ç¨‹</h2>
    <p>Graph Network Simulator å®Œå…¨æŒ‡å—</p>
  </div>
  <nav id="sidebar-nav">
    <div class="chapter-title">ç¬¬ä¸€ç« ï¼šå›¾çš„åŸºç¡€</div>
    <a href="#ch1-graph">1.1 ä»€ä¹ˆæ˜¯å›¾</a>
    <a href="#ch1-directed">1.2 æœ‰å‘å›¾ vs æ— å‘å›¾</a>
    <a href="#ch1-repr">1.3 å›¾çš„è¡¨ç¤ºæ–¹æ³•</a>
    <a href="#ch1-physics">1.4 å›¾åœ¨ç‰©ç†ç³»ç»Ÿä¸­çš„åº”ç”¨</a>
    <a href="#ch1-pushbox">1.5 æˆ‘ä»¬çš„ PushBox å›¾</a>

    <div class="chapter-title">ç¬¬äºŒç« ï¼šå›¾ç¥ç»ç½‘ç»œåŸºç¡€</div>
    <a href="#ch2-why">2.1 ä¸ºä»€ä¹ˆéœ€è¦ GNN</a>
    <a href="#ch2-mp">2.2 æ¶ˆæ¯ä¼ é€’èŒƒå¼</a>
    <a href="#ch2-gcn">2.3 GCN å›¾å·ç§¯ç½‘ç»œ</a>
    <a href="#ch2-gat">2.4 GAT å›¾æ³¨æ„åŠ›ç½‘ç»œ</a>
    <a href="#ch2-sage">2.5 GraphSAGE</a>
    <a href="#ch2-pyg">2.6 PyTorch Geometric å…¥é—¨</a>

    <div class="chapter-title">ç¬¬ä¸‰ç« ï¼šGNS è¯¦è§£</div>
    <a href="#ch3-bg">3.1 GNS è®ºæ–‡èƒŒæ™¯</a>
    <a href="#ch3-epd">3.2 Encode-Process-Decode</a>
    <a href="#ch3-node">3.3 èŠ‚ç‚¹ç‰¹å¾è®¾è®¡</a>
    <a href="#ch3-edge">3.4 è¾¹ç‰¹å¾è®¾è®¡</a>
    <a href="#ch3-impl">3.5 æ¶ˆæ¯ä¼ é€’å±‚å®ç°</a>
    <a href="#ch3-multi">3.6 å¤šè½®æ¶ˆæ¯ä¼ é€’</a>
    <a href="#ch3-global">3.7 å…¨å±€ç‰¹å¾</a>

    <div class="chapter-title">ç¬¬å››ç« ï¼šEdge Frame</div>
    <a href="#ch4-what">4.1 ä»€ä¹ˆæ˜¯ Edge Frame</a>
    <a href="#ch4-why">4.2 ä¸ºä»€ä¹ˆé‡è¦</a>
    <a href="#ch4-math">4.3 æ•°å­¦æ¨å¯¼</a>
    <a href="#ch4-code">4.4 ä»£ç è§£æ</a>
    <a href="#ch4-compare">4.5 æœ‰æ— å¯¹æ¯”</a>

    <div class="chapter-title">ç¬¬äº”ç« ï¼šDynami-CAL GNN</div>
    <a href="#ch5-what">5.1 ä»€ä¹ˆæ˜¯ Dynami-CAL</a>
    <a href="#ch5-pmp">5.2 PhysicsMessagePassing</a>
    <a href="#ch5-arch">5.3 å®Œæ•´æ¶æ„</a>
    <a href="#ch5-conservation">5.4 å®ˆæ’å®šå¾‹ç¼–ç </a>
    <a href="#ch5-symplectic">5.5 è¾›ç§¯åˆ†å™¨</a>
    <a href="#ch5-force">5.6 åŠ›é¢„æµ‹ vs åŠ é€Ÿåº¦é¢„æµ‹</a>

    <div class="chapter-title">ç¬¬å…­ç« ï¼šPushBox åº”ç”¨</div>
    <a href="#ch6-build">6.1 å›¾æ„å»ºè¿‡ç¨‹</a>
    <a href="#ch6-gns">6.2 GNSFeaturesExtractor</a>
    <a href="#ch6-phys">6.3 PhysRobotFeaturesExtractor</a>
    <a href="#ch6-train">6.4 è®­ç»ƒæµç¨‹</a>
    <a href="#ch6-compare">6.5 ä¸çº¯ PPO å¯¹æ¯”</a>

    <div class="chapter-title">ç¬¬ä¸ƒç« ï¼šé«˜çº§ä¸»é¢˜</div>
    <a href="#ch7-multi">7.1 å¤šä½“ç³»ç»Ÿ</a>
    <a href="#ch7-dynamic">7.2 åŠ¨æ€å›¾</a>
    <a href="#ch7-hier">7.3 å±‚æ¬¡åŒ–å›¾</a>
    <a href="#ch7-attn">7.4 æ³¨æ„åŠ› + GNN</a>
    <a href="#ch7-limit">7.5 GNN çš„å±€é™æ€§</a>
    <a href="#ch7-recent">7.6 æœ€æ–°è¿›å±•</a>

    <div class="chapter-title">ç¬¬å…«ç« ï¼šå®è·µç»ƒä¹ </div>
    <a href="#ch8-scratch">8.1 ä»é›¶æ„å»º GNN</a>
    <a href="#ch8-pyg">8.2 ç”¨ PyG æ„å»º GNS</a>
    <a href="#ch8-pushbox">8.3 PushBox è®­ç»ƒè„šæœ¬</a>
    <a href="#ch8-viz">8.4 å¯è§†åŒ–æ¶ˆæ¯ä¼ é€’</a>
    <a href="#ch8-hyper">8.5 è¶…å‚æ•°å®éªŒ</a>

    <div class="chapter-title">é™„å½•</div>
    <a href="#appendix-formula">å…¬å¼é€ŸæŸ¥è¡¨</a>
    <a href="#appendix-pyg">PyG å¸¸ç”¨ API</a>
    <a href="#appendix-papers">å…³é”®è®ºæ–‡</a>
    <a href="#appendix-compare">æ–¹æ³•å¯¹æ¯”è¡¨</a>
  </nav>
</aside>

<!-- Top Bar -->
<div class="top-bar">
  <button class="menu-toggle" onclick="document.getElementById('sidebar').classList.toggle('open')">â˜°</button>
  <button class="btn-theme" onclick="toggleTheme()">ğŸŒ“ åˆ‡æ¢ä¸»é¢˜</button>
</div>

<!-- Progress Bar -->
<div class="progress-bar"><div class="fill" id="progress-fill"></div></div>

<!-- Main Content -->
<div class="main-content">

<!-- Hero -->
<div class="hero">
  <h1>GNS å›¾ç½‘ç»œæ¨¡æ‹Ÿå™¨</h1>
  <p class="subtitle">ä»é›¶å¼€å§‹æŒæ¡ Graph Network Simulator â€” ç”¨å›¾ç»“æ„ä¸ºç‰©ç†ä¸–ç•Œå»ºæ¨¡ï¼Œä»¥ PushBox æœºå™¨äººä¸ºä¾‹è´¯ç©¿å…¨æ–‡</p>
  <div class="badges">
    <span class="badge">ğŸ“Š 8 ç« æ·±åº¦å†…å®¹</span>
    <span class="badge">ğŸ å®Œæ•´ Python ä»£ç </span>
    <span class="badge">ğŸ¤– PushBox å®æˆ˜æ¡ˆä¾‹</span>
    <span class="badge">ğŸ“ æ•°å­¦å…¬å¼æ¨å¯¼</span>
  </div>
</div>

<!-- ================================================================ -->
<!-- ç¬¬ä¸€ç«  -->
<!-- ================================================================ -->
<h2 id="ch1">ç¬¬ä¸€ç« ï¼šå›¾çš„åŸºç¡€</h2>

<h3 id="ch1-graph">1.1 ä»€ä¹ˆæ˜¯å›¾</h3>

<div class="box definition">
  <div class="box-title">ğŸ“˜ å®šä¹‰ï¼šå›¾ (Graph)</div>
  <p>å›¾ $G = (V, E)$ æ˜¯ç”± <strong>èŠ‚ç‚¹</strong>ï¼ˆvertices / nodesï¼‰é›†åˆ $V$ å’Œ <strong>è¾¹</strong>ï¼ˆedgesï¼‰é›†åˆ $E$ ç»„æˆçš„æ•°å­¦ç»“æ„ã€‚æ¯æ¡è¾¹è¿æ¥ä¸€å¯¹èŠ‚ç‚¹ï¼Œè¡¨ç¤ºå®ƒä»¬ä¹‹é—´çš„å…³ç³»ã€‚</p>
</div>

<p>å›¾æ˜¯ä¸€ç§éå¸¸å¼ºå¤§çš„æ•°æ®ç»“æ„ï¼Œèƒ½å¤Ÿè¡¨ç¤ºå„ç§å…³ç³»å‹æ•°æ®ã€‚ä¸è§„åˆ™æ’åˆ—çš„ç½‘æ ¼ï¼ˆå¦‚å›¾åƒçš„åƒç´ ï¼‰æˆ–çº¿æ€§åºåˆ—ï¼ˆå¦‚æ–‡æœ¬çš„è¯è¯­ï¼‰ä¸åŒï¼Œå›¾çš„æ‹“æ‰‘ç»“æ„å¯ä»¥æ˜¯ä»»æ„çš„ã€‚</p>

<p>å½¢å¼åŒ–åœ°ï¼Œä¸€ä¸ªå›¾åŒ…å«ï¼š</p>
<ul>
  <li><strong>èŠ‚ç‚¹é›† $V = \{v_1, v_2, \ldots, v_N\}$</strong>ï¼š$N$ ä¸ªå®ä½“ï¼Œæ¯ä¸ªèŠ‚ç‚¹å¯ä»¥æœ‰è‡ªèº«çš„ç‰¹å¾å‘é‡ $\mathbf{x}_i \in \mathbb{R}^d$</li>
  <li><strong>è¾¹é›† $E \subseteq V \times V$</strong>ï¼šèŠ‚ç‚¹ä¹‹é—´çš„è¿æ¥å…³ç³»ï¼Œæ¯æ¡è¾¹ä¹Ÿå¯ä»¥æœ‰ç‰¹å¾å‘é‡ $\mathbf{e}_{ij} \in \mathbb{R}^k$</li>
  <li><strong>é‚»æ¥çŸ©é˜µ $\mathbf{A} \in \{0,1\}^{N \times N}$</strong>ï¼š$A_{ij} = 1$ å½“ä¸”ä»…å½“èŠ‚ç‚¹ $i$ å’ŒèŠ‚ç‚¹ $j$ ä¹‹é—´æœ‰è¾¹</li>
</ul>

<div class="box example">
  <div class="box-title">ğŸ’¡ ä¾‹å­ï¼šç¤¾äº¤ç½‘ç»œ</div>
  <p>åœ¨ç¤¾äº¤ç½‘ç»œä¸­ï¼Œæ¯ä¸ª <strong>äºº</strong> æ˜¯ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆèŠ‚ç‚¹ç‰¹å¾å¯èƒ½åŒ…å«å¹´é¾„ã€å…´è¶£ç­‰ï¼‰ï¼Œ<strong>å‹è°Šå…³ç³»</strong> æ˜¯ä¸€æ¡è¾¹ã€‚èŠ‚ç‚¹æ•° $N$ å¯ä»¥ä¸Šäº¿ï¼Œè€Œæ¯ä¸ªäººçš„æœ‹å‹æ•°ï¼ˆè¾¹æ•°ï¼‰é€šå¸¸åœ¨å‡ ç™¾ä»¥å†…ã€‚</p>
</div>

<p>åœ¨ç‰©ç†æ¨¡æ‹Ÿä¸­ï¼ŒèŠ‚ç‚¹é€šå¸¸ä»£è¡¨ç‰©ç†å®ä½“ï¼ˆç²’å­ã€åˆšä½“ã€å…³èŠ‚ï¼‰ï¼Œè¾¹ä»£è¡¨å®ƒä»¬ä¹‹é—´çš„äº¤äº’å…³ç³»ï¼ˆåŠ›ã€çº¦æŸã€æ¥è§¦ï¼‰ã€‚è¿™æ­£æ˜¯ GNS çš„æ ¸å¿ƒæ€æƒ³ã€‚</p>

<h4>é‚»æ¥çŸ©é˜µç¤ºä¾‹</h4>
<p>å¯¹äºä¸€ä¸ªæœ‰ 3 ä¸ªèŠ‚ç‚¹ã€3 æ¡è¾¹çš„ç®€å•å›¾ï¼š</p>

$$
\mathbf{A} = \begin{pmatrix} 0 & 1 & 1 \\ 1 & 0 & 1 \\ 1 & 1 & 0 \end{pmatrix}
$$

<p>$A_{01} = 1$ è¡¨ç¤ºèŠ‚ç‚¹ 0 å’ŒèŠ‚ç‚¹ 1 ä¹‹é—´æœ‰è¾¹è¿æ¥ã€‚</p>

<!-- ===== 1.2 ===== -->
<h3 id="ch1-directed">1.2 æœ‰å‘å›¾ vs æ— å‘å›¾</h3>

<div class="box definition">
  <div class="box-title">ğŸ“˜ å®šä¹‰ï¼šæœ‰å‘å›¾ä¸æ— å‘å›¾</div>
  <p><strong>æ— å‘å›¾</strong>ï¼šè¾¹æ²¡æœ‰æ–¹å‘ï¼Œ$(i, j) \in E \Leftrightarrow (j, i) \in E$ï¼Œé‚»æ¥çŸ©é˜µå¯¹ç§° $A_{ij} = A_{ji}$ã€‚</p>
  <p><strong>æœ‰å‘å›¾</strong>ï¼šè¾¹æœ‰æ–¹å‘ï¼Œ$(i, j) \in E$ ä¸ä¸€å®šæ„å‘³ç€ $(j, i) \in E$ï¼Œé‚»æ¥çŸ©é˜µä¸ä¸€å®šå¯¹ç§°ã€‚</p>
</div>

<table>
  <thead>
    <tr><th>ç‰¹æ€§</th><th>æ— å‘å›¾</th><th>æœ‰å‘å›¾</th></tr>
  </thead>
  <tbody>
    <tr><td>è¾¹çš„æ–¹å‘</td><td>åŒå‘/æ— æ–¹å‘</td><td>å•å‘</td></tr>
    <tr><td>é‚»æ¥çŸ©é˜µ</td><td>å¯¹ç§°</td><td>ä¸ä¸€å®šå¯¹ç§°</td></tr>
    <tr><td>ç‰©ç†ä¾‹å­</td><td>å¼¹ç°§è¿æ¥ã€è·ç¦»çº¦æŸ</td><td>å› æœå…³ç³»ã€ä¿¡æ¯æµ</td></tr>
    <tr><td>åœ¨ GNS ä¸­</td><td>åŒå‘æ¶ˆæ¯ä¼ é€’</td><td>å•å‘æ¶ˆæ¯ä¼ é€’</td></tr>
  </tbody>
</table>

<div class="box warning">
  <div class="box-title">âš ï¸ æ³¨æ„</div>
  <p>åœ¨ GNS å’Œå¤§å¤šæ•° GNN å®ç°ä¸­ï¼Œå³ä½¿è¡¨ç¤ºæ— å‘å…³ç³»ï¼Œä¹Ÿé€šå¸¸ä½¿ç”¨ <strong>ä¸¤æ¡æœ‰å‘è¾¹</strong> æ¥å®ç°ã€‚å³å¯¹äºæ— å‘è¾¹ $(i, j)$ï¼Œä¼šåŒæ—¶æ·»åŠ  $(i \to j)$ å’Œ $(j \to i)$ã€‚è¿™æ˜¯ PyTorch Geometric (PyG) çš„æ ‡å‡†åšæ³•ã€‚</p>
</div>

<!-- ===== 1.3 ===== -->
<h3 id="ch1-repr">1.3 å›¾çš„è¡¨ç¤ºæ–¹æ³•</h3>

<h4>æ–¹æ³• 1ï¼šé‚»æ¥çŸ©é˜µ</h4>
<p>ç”¨ä¸€ä¸ª $N \times N$ çš„çŸ©é˜µ $\mathbf{A}$ å­˜å‚¨æ‰€æœ‰è¿æ¥å…³ç³»ã€‚</p>

$$
A_{ij} = \begin{cases} 1, & \text{if } (i, j) \in E \\ 0, & \text{otherwise} \end{cases}
$$

<p><strong>ä¼˜ç‚¹</strong>ï¼šæŸ¥è¯¢ä»»æ„ä¸¤èŠ‚ç‚¹é—´æ˜¯å¦æœ‰è¾¹æ˜¯ $O(1)$ã€‚<br>
<strong>ç¼ºç‚¹</strong>ï¼šç©ºé—´å¤æ‚åº¦ $O(N^2)$ï¼Œå½“å›¾ç¨€ç–æ—¶æå…¶æµªè´¹ã€‚</p>

<h4>æ–¹æ³• 2ï¼šé‚»æ¥åˆ—è¡¨</h4>
<p>æ¯ä¸ªèŠ‚ç‚¹ç»´æŠ¤ä¸€ä¸ªé‚»å±…åˆ—è¡¨ã€‚</p>

<div class="code-container">
  <div class="code-header"><span>Python â€” é‚»æ¥åˆ—è¡¨</span><button class="copy-btn" onclick="copyCode(this)">å¤åˆ¶</button></div>
  <pre><code><span class="cmt"># é‚»æ¥åˆ—è¡¨è¡¨ç¤º</span>
adj_list = {
    <span class="num">0</span>: [<span class="num">1</span>, <span class="num">2</span>],      <span class="cmt"># èŠ‚ç‚¹0çš„é‚»å±…æ˜¯1å’Œ2</span>
    <span class="num">1</span>: [<span class="num">0</span>, <span class="num">2</span>],      <span class="cmt"># èŠ‚ç‚¹1çš„é‚»å±…æ˜¯0å’Œ2</span>
    <span class="num">2</span>: [<span class="num">0</span>, <span class="num">1</span>],      <span class="cmt"># èŠ‚ç‚¹2çš„é‚»å±…æ˜¯0å’Œ1</span>
}</code></pre>
</div>

<h4>æ–¹æ³• 3ï¼šedge_indexï¼ˆPyG æ ¼å¼ï¼‰â­</h4>
<p>è¿™æ˜¯ PyTorch Geometric çš„æ ‡å‡†æ ¼å¼ï¼Œä¹Ÿæ˜¯ GNS ä¸­æœ€å¸¸ç”¨çš„ã€‚å®ƒç”¨ä¸¤ä¸ªåˆ—è¡¨åˆ†åˆ«å­˜å‚¨è¾¹çš„ <strong>æºèŠ‚ç‚¹</strong> å’Œ <strong>ç›®æ ‡èŠ‚ç‚¹</strong>ã€‚</p>

<div class="code-container">
  <div class="code-header"><span>Python â€” edge_index (PyG)</span><button class="copy-btn" onclick="copyCode(this)">å¤åˆ¶</button></div>
  <pre><code><span class="kw">import</span> torch

<span class="cmt"># edge_index å½¢çŠ¶: [2, E]</span>
<span class="cmt"># ç¬¬ä¸€è¡Œ: æºèŠ‚ç‚¹ (source)</span>
<span class="cmt"># ç¬¬äºŒè¡Œ: ç›®æ ‡èŠ‚ç‚¹ (target)</span>
edge_index = torch.tensor([
    [<span class="num">0</span>, <span class="num">0</span>, <span class="num">1</span>, <span class="num">1</span>, <span class="num">2</span>, <span class="num">2</span>],  <span class="cmt"># source</span>
    [<span class="num">1</span>, <span class="num">2</span>, <span class="num">0</span>, <span class="num">2</span>, <span class="num">0</span>, <span class="num">1</span>],  <span class="cmt"># target</span>
], dtype=torch.long)
<span class="cmt"># è¿™è¡¨ç¤º 6 æ¡æœ‰å‘è¾¹:  0â†’1, 0â†’2, 1â†’0, 1â†’2, 2â†’0, 2â†’1</span>
<span class="cmt"># ç­‰ä»·äº 3 ä¸ªèŠ‚ç‚¹çš„å…¨è¿æ¥æ— å‘å›¾</span>

<span class="bi">print</span>(edge_index.shape)  <span class="cmt"># torch.Size([2, 6])</span></code></pre>
</div>

<div class="box theorem">
  <div class="box-title">ğŸ“— è¦ç‚¹ï¼šä¸ºä»€ä¹ˆ edge_index é«˜æ•ˆï¼Ÿ</div>
  <p>edge_index åªå­˜å‚¨ <strong>å®é™…å­˜åœ¨çš„è¾¹</strong>ï¼Œç©ºé—´å¤æ‚åº¦ $O(E)$ï¼Œå¯¹ç¨€ç–å›¾éå¸¸å‹å¥½ã€‚åŒæ—¶å®ƒå¤©ç„¶æ”¯æŒæ‰¹é‡æ“ä½œï¼ˆåªéœ€è¦åšèŠ‚ç‚¹ç¼–å·åç§»ï¼‰ï¼Œæ˜¯ GPU åŠ é€Ÿçš„å…³é”®ã€‚</p>
</div>

<!-- ===== 1.4 ===== -->
<h3 id="ch1-physics">1.4 å›¾åœ¨ç‰©ç†ç³»ç»Ÿä¸­çš„åº”ç”¨</h3>

<p>å›¾æ˜¯æè¿°ç‰©ç†ç³»ç»Ÿäº¤äº’å…³ç³»çš„å¤©ç„¶å·¥å…·ã€‚å‡ ä¹æ‰€æœ‰ç‰©ç†ç³»ç»Ÿéƒ½å¯ä»¥å»ºæ¨¡ä¸ºå›¾ï¼š</p>

<table>
  <thead>
    <tr><th>ç‰©ç†ç³»ç»Ÿ</th><th>èŠ‚ç‚¹</th><th>è¾¹</th><th>äº¤äº’ç±»å‹</th></tr>
  </thead>
  <tbody>
    <tr><td>ç²’å­ç³»ç»Ÿ</td><td>ç²’å­</td><td>ç²’å­å¯¹ï¼ˆè·ç¦»é˜ˆå€¼å†…ï¼‰</td><td>å¼•åŠ›ã€ç¢°æ’</td></tr>
    <tr><td>åˆšä½“ç³»ç»Ÿ</td><td>åˆšä½“</td><td>æ¥è§¦ç‚¹</td><td>æ¥è§¦åŠ›ã€æ‘©æ“¦</td></tr>
    <tr><td>æœºå™¨äººå…³èŠ‚</td><td>é“¾æ¥ï¼ˆlinkï¼‰</td><td>å…³èŠ‚ï¼ˆjointï¼‰</td><td>æ‰­çŸ©ã€çº¦æŸ</td></tr>
    <tr><td>å¼¹ç°§è´¨ç‚¹</td><td>è´¨ç‚¹</td><td>å¼¹ç°§</td><td>å¼¹åŠ›ã€é˜»å°¼</td></tr>
    <tr><td>æµä½“ (SPH)</td><td>æµä½“ç²’å­</td><td>é‚»è¿‘ç²’å­</td><td>å‹åŠ›ã€ç²˜æ€§</td></tr>
    <tr><td>å¸ƒæ–™æ¨¡æ‹Ÿ</td><td>ç½‘æ ¼èŠ‚ç‚¹</td><td>ç»“æ„/å‰ªåˆ‡/å¼¯æ›²å¼¹ç°§</td><td>å¼¹æ€§åŠ›</td></tr>
  </tbody>
</table>

<div class="box example">
  <div class="box-title">ğŸ’¡ æ ¸å¿ƒæ´å¯Ÿ</div>
  <p>ç‰©ç†äº¤äº’å…·æœ‰ <strong>å±€éƒ¨æ€§</strong>â€”â€”åŠ›é€šå¸¸åªåœ¨ç©ºé—´ä¸Šç›¸è¿‘çš„ç‰©ä½“ä¹‹é—´ä¼ é€’ã€‚è¿™ä¸å›¾çš„ <strong>æ¶ˆæ¯ä¼ é€’</strong> èŒƒå¼å®Œç¾åŒ¹é…ï¼šæ¯ä¸ªèŠ‚ç‚¹åªéœ€è¦å…³æ³¨å®ƒçš„ <strong>é‚»å±…</strong>ï¼</p>
</div>

<!-- ===== 1.5 ===== -->
<h3 id="ch1-pushbox">1.5 æˆ‘ä»¬çš„ PushBox å›¾</h3>

<p>åœ¨æˆ‘ä»¬çš„ PushBox æœºå™¨äººæ¨ç®±å­ä»»åŠ¡ä¸­ï¼Œç‰©ç†ç³»ç»Ÿç”±ä»¥ä¸‹ç»„ä»¶æ„æˆï¼š</p>

<div class="diagram">
  <svg width="500" height="200" viewBox="0 0 500 200">
    <!-- Node 0: End-effector -->
    <circle cx="120" cy="100" r="40" fill="none" stroke="currentColor" stroke-width="2.5"/>
    <text x="120" y="95" text-anchor="middle" fill="currentColor" font-size="13" font-weight="bold">Node 0</text>
    <text x="120" y="112" text-anchor="middle" fill="currentColor" font-size="11">æœ«ç«¯æ‰§è¡Œå™¨</text>

    <!-- Node 1: Box -->
    <rect x="340" y="60" width="80" height="80" rx="8" fill="none" stroke="currentColor" stroke-width="2.5"/>
    <text x="380" y="95" text-anchor="middle" fill="currentColor" font-size="13" font-weight="bold">Node 1</text>
    <text x="380" y="112" text-anchor="middle" fill="currentColor" font-size="11">ç›’å­</text>

    <!-- Edge 0â†’1 -->
    <line x1="160" y1="88" x2="340" y2="88" stroke="currentColor" stroke-width="2" marker-end="url(#arrowhead)"/>
    <text x="250" y="80" text-anchor="middle" fill="currentColor" font-size="11">edge 0â†’1</text>

    <!-- Edge 1â†’0 -->
    <line x1="340" y1="112" x2="160" y2="112" stroke="currentColor" stroke-width="2" marker-end="url(#arrowhead)"/>
    <text x="250" y="132" text-anchor="middle" fill="currentColor" font-size="11">edge 1â†’0</text>

    <defs>
      <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
        <polygon points="0 0, 10 3.5, 0 7" fill="currentColor" />
      </marker>
    </defs>
  </svg>
  <figcaption>å›¾ 1.1ï¼šPushBox ä»»åŠ¡çš„å›¾è¡¨ç¤º â€” 2 èŠ‚ç‚¹ã€2 æ¡åŒå‘è¾¹</figcaption>
</div>

<p><strong>å›¾ç»“æ„è¯¦ç»†è¯´æ˜ï¼š</strong></p>

<table>
  <thead>
    <tr><th>ç»„ä»¶</th><th>å†…å®¹</th><th>ç»´åº¦</th></tr>
  </thead>
  <tbody>
    <tr><td>Node 0 (æœ«ç«¯æ‰§è¡Œå™¨)</td><td>ee_pos (3D), ee_vel (3D)</td><td>6</td></tr>
    <tr><td>Node 1 (ç›’å­)</td><td>box_pos (3D), box_vel (3D)</td><td>6</td></tr>
    <tr><td>Edge 0â†’1</td><td>rel_pos = box_pos - ee_pos (3D), distance (1D)</td><td>4</td></tr>
    <tr><td>Edge 1â†’0</td><td>rel_pos = ee_pos - box_pos (3D), distance (1D)</td><td>4</td></tr>
    <tr><td>edge_index</td><td>[[0, 1], [1, 0]]</td><td>[2, 2]</td></tr>
  </tbody>
</table>

<div class="code-container">
  <div class="code-header"><span>Python â€” PushBox å›¾æ„å»º</span><button class="copy-btn" onclick="copyCode(this)">å¤åˆ¶</button></div>
  <pre><code><span class="kw">import</span> torch
<span class="kw">from</span> torch_geometric.data <span class="kw">import</span> Data

<span class="kw">def</span> <span class="fn">build_pushbox_graph</span>(obs):
    <span class="str">"""
    ä» 16 ç»´è§‚æµ‹æ„å»º PushBox å›¾
    
    obs å¸ƒå±€:
      [0:2]   joint_pos   (2)  â€” å…³èŠ‚è§’åº¦
      [2:4]   joint_vel   (2)  â€” å…³èŠ‚é€Ÿåº¦
      [4:7]   ee_pos      (3)  â€” æœ«ç«¯æ‰§è¡Œå™¨ä½ç½®
      [7:10]  box_pos     (3)  â€” ç›’å­ä½ç½®
      [10:13] box_vel     (3)  â€” ç›’å­é€Ÿåº¦
      [13:16] goal_pos    (3)  â€” ç›®æ ‡ä½ç½®
    """</span>
    <span class="cmt"># æå–ç‰©ç†é‡</span>
    ee_pos  = obs[<span class="num">4</span>:<span class="num">7</span>]
    ee_vel  = torch.zeros(<span class="num">3</span>)   <span class="cmt"># ç®€åŒ–ï¼šä»è§‚æµ‹ä¸­è¿‘ä¼¼ä¸ºé›¶</span>
    box_pos = obs[<span class="num">7</span>:<span class="num">10</span>]
    box_vel = obs[<span class="num">10</span>:<span class="num">13</span>]
    
    <span class="cmt"># èŠ‚ç‚¹ç‰¹å¾: [pos(3), vel(3)] = 6D</span>
    node_features = torch.stack([
        torch.cat([ee_pos, ee_vel]),    <span class="cmt"># Node 0: æœ«ç«¯æ‰§è¡Œå™¨</span>
        torch.cat([box_pos, box_vel]),  <span class="cmt"># Node 1: ç›’å­</span>
    ])  <span class="cmt"># shape: [2, 6]</span>
    
    <span class="cmt"># è¾¹: åŒå‘è¿æ¥</span>
    edge_index = torch.tensor([
        [<span class="num">0</span>, <span class="num">1</span>],  <span class="cmt"># source</span>
        [<span class="num">1</span>, <span class="num">0</span>],  <span class="cmt"># target</span>
    ], dtype=torch.long)
    
    <span class="cmt"># è¾¹ç‰¹å¾: [ç›¸å¯¹ä½ç½®(3), è·ç¦»(1)] = 4D</span>
    rel_01 = box_pos - ee_pos
    rel_10 = ee_pos - box_pos
    d_01 = torch.norm(rel_01).unsqueeze(<span class="num">0</span>)
    d_10 = torch.norm(rel_10).unsqueeze(<span class="num">0</span>)
    
    edge_attr = torch.stack([
        torch.cat([rel_01, d_01]),  <span class="cmt"># Edge 0â†’1</span>
        torch.cat([rel_10, d_10]),  <span class="cmt"># Edge 1â†’0</span>
    ])  <span class="cmt"># shape: [2, 4]</span>
    
    graph = Data(
        x=node_features,          <span class="cmt"># [2, 6]</span>
        edge_index=edge_index,    <span class="cmt"># [2, 2]</span>
        edge_attr=edge_attr,      <span class="cmt"># [2, 4]</span>
    )
    <span class="kw">return</span> graph</code></pre>
</div>

<div class="box theorem">
  <div class="box-title">ğŸ“— å…³é”®ç†è§£</div>
  <p>è™½ç„¶ PushBox åªæœ‰ 2 ä¸ªèŠ‚ç‚¹ã€2 æ¡è¾¹â€”â€”çœ‹èµ·æ¥æå…¶ç®€å•â€”â€”ä½†å®ƒåŒ…å«äº† GNS çš„ <strong>æ‰€æœ‰æ ¸å¿ƒæ¦‚å¿µ</strong>ï¼šèŠ‚ç‚¹ç¼–ç ã€è¾¹ç¼–ç ã€æ¶ˆæ¯ä¼ é€’ã€åŠ¨åŠ›å­¦é¢„æµ‹ã€‚æŒæ¡äº†è¿™ä¸ªç®€å•ä¾‹å­ï¼Œæ‰©å±•åˆ° 100+ èŠ‚ç‚¹çš„å¤æ‚ç³»ç»Ÿåªæ˜¯å¢åŠ èŠ‚ç‚¹æ•°é‡è€Œå·²ã€‚</p>
</div>


<!-- ================================================================ -->
<!-- ç¬¬äºŒç«  -->
<!-- ================================================================ -->
<h2 id="ch2">ç¬¬äºŒç« ï¼šå›¾ç¥ç»ç½‘ç»œ (GNN) åŸºç¡€</h2>

<h3 id="ch2-why">2.1 ä¸ºä»€ä¹ˆéœ€è¦ GNN</h3>

<p>ä¼ ç»Ÿçš„å¤šå±‚æ„ŸçŸ¥æœºï¼ˆMLPï¼‰å°†æ‰€æœ‰è¾“å…¥æ‹¼æ¥æˆä¸€ä¸ªæ‰å¹³å‘é‡æ¥å¤„ç†ã€‚è¿™å­˜åœ¨å‡ ä¸ªæ ¹æœ¬é—®é¢˜ï¼š</p>

<div class="compare-grid">
  <div class="compare-card">
    <h4>âŒ MLP çš„é—®é¢˜</h4>
    <ul>
      <li><strong>ç½®æ¢ä¸å˜æ€§ç¼ºå¤±</strong>ï¼šäº¤æ¢ä¸¤ä¸ªç²’å­çš„é¡ºåº â†’ è¾“å‡ºå®Œå…¨æ”¹å˜</li>
      <li><strong>ç»´åº¦å›ºå®š</strong>ï¼šè¾“å…¥ç»´åº¦å›ºå®šï¼Œæ— æ³•å¤„ç†ä¸åŒæ•°é‡çš„ç‰©ä½“</li>
      <li><strong>å…³ç³»éšå¼</strong>ï¼šç‰©ä½“é—´çš„å…³ç³»éœ€è¦ç½‘ç»œè‡ªå·±å­¦ä¹ å‘ç°</li>
      <li><strong>æ³›åŒ–å·®</strong>ï¼šè®­ç»ƒ 3 ä¸ªç‰©ä½“ï¼Œæ— æ³•æ³›åŒ–åˆ° 5 ä¸ª</li>
    </ul>
  </div>
  <div class="compare-card">
    <h4>âœ… GNN çš„ä¼˜åŠ¿</h4>
    <ul>
      <li><strong>ç½®æ¢ç­‰å˜</strong>ï¼šäº¤æ¢èŠ‚ç‚¹é¡ºåº â†’ è¾“å‡ºè·Ÿç€äº¤æ¢</li>
      <li><strong>å¤§å°å¯å˜</strong>ï¼šåŒä¸€ç½‘ç»œå¤„ç†ä»»æ„æ•°é‡çš„èŠ‚ç‚¹</li>
      <li><strong>å…³ç³»æ˜¾å¼</strong>ï¼šè¾¹ç›´æ¥ç¼–ç ç‰©ä½“é—´å…³ç³»</li>
      <li><strong>å¼ºæ³›åŒ–</strong>ï¼šè®­ç»ƒ 3 èŠ‚ç‚¹ï¼Œæ³›åŒ–åˆ° 100 èŠ‚ç‚¹</li>
    </ul>
  </div>
</div>

<div class="box example">
  <div class="box-title">ğŸ’¡ ç›´è§‰</div>
  <p>æƒ³è±¡ä½ æœ‰ 100 ä¸ªç²’å­ï¼ŒMLP éœ€è¦ä¸€ä¸ª $100 \times 6 = 600$ ç»´è¾“å…¥å‘é‡ï¼Œè€Œä¸” <strong>ç¬¬ 1 ä¸ªç²’å­å¿…é¡»å§‹ç»ˆæ”¾åœ¨å‰ 6 ä¸ªä½ç½®</strong>ã€‚å¦‚æœä½ äº¤æ¢ç¬¬ 1 å’Œç¬¬ 50 ä¸ªç²’å­çš„ä½ç½®ï¼ŒMLP ä¼šç»™å‡ºå®Œå…¨ä¸åŒçš„ç­”æ¡ˆã€‚</p>
  <p>GNN åˆ™å®Œå…¨ä¸åŒï¼šæ¯ä¸ªç²’å­éƒ½æ˜¯ä¸€ä¸ª "èŠ‚ç‚¹"ï¼ŒåŒä¸€ä¸ªæ¶ˆæ¯ä¼ é€’å‡½æ•°ä½œç”¨äºæ¯ä¸€å¯¹é‚»å±…ã€‚æ— è®ºç²’å­ç¼–å·æ€ä¹ˆå˜åŒ–ï¼Œç‰©ç†è§„å¾‹ä¸å˜â€”â€”è¿™å°±æ˜¯ <strong>ç­‰å˜æ€§</strong>ã€‚</p>
</div>

<!-- ===== 2.2 ===== -->
<h3 id="ch2-mp">2.2 æ¶ˆæ¯ä¼ é€’èŒƒå¼ (Message Passing)</h3>

<div class="box definition">
  <div class="box-title">ğŸ“˜ å®šä¹‰ï¼šæ¶ˆæ¯ä¼ é€’ç¥ç»ç½‘ç»œ (MPNN)</div>
  <p>æ¶ˆæ¯ä¼ é€’æ˜¯ GNN çš„ç»Ÿä¸€æ¡†æ¶ï¼ˆGilmer et al., 2017ï¼‰ï¼ŒåŒ…å«ä¸‰ä¸ªæ­¥éª¤ï¼š</p>
  <ol>
    <li><strong>æ¶ˆæ¯å‡½æ•° (Message)</strong>ï¼šè®¡ç®—æ¯æ¡è¾¹ä¸Šçš„æ¶ˆæ¯</li>
    <li><strong>èšåˆå‡½æ•° (Aggregate)</strong>ï¼šå°†æ‰€æœ‰å…¥è¾¹æ¶ˆæ¯èšåˆ</li>
    <li><strong>æ›´æ–°å‡½æ•° (Update)</strong>ï¼šç”¨èšåˆç»“æœæ›´æ–°èŠ‚ç‚¹ç‰¹å¾</li>
  </ol>
</div>

<p>å½¢å¼åŒ–åœ°ï¼Œç¬¬ $l$ è½®æ¶ˆæ¯ä¼ é€’çš„è¿‡ç¨‹ä¸ºï¼š</p>

<p><strong>ç¬¬ 1 æ­¥ï¼šæ¶ˆæ¯å‡½æ•° (Message)</strong></p>
$$
\mathbf{m}_{ij}^{(l)} = \phi\left(\mathbf{x}_i^{(l)}, \mathbf{x}_j^{(l)}, \mathbf{e}_{ij}\right)
$$
<p>å…¶ä¸­ $\mathbf{x}_i^{(l)}$ æ˜¯èŠ‚ç‚¹ $i$ åœ¨ç¬¬ $l$ å±‚çš„ç‰¹å¾ï¼Œ$\mathbf{x}_j^{(l)}$ æ˜¯é‚»å±… $j$ çš„ç‰¹å¾ï¼Œ$\mathbf{e}_{ij}$ æ˜¯è¾¹ç‰¹å¾ï¼Œ$\phi$ æ˜¯å¯å­¦ä¹ çš„å‡½æ•°ï¼ˆé€šå¸¸æ˜¯ MLPï¼‰ã€‚</p>

<p><strong>ç¬¬ 2 æ­¥ï¼šèšåˆå‡½æ•° (Aggregate)</strong></p>
$$
\mathbf{M}_i^{(l)} = \bigoplus_{j \in \mathcal{N}(i)} \mathbf{m}_{ij}^{(l)}
$$
<p>$\bigoplus$ æ˜¯ä¸€ä¸ª <strong>ç½®æ¢ä¸å˜</strong> çš„èšåˆæ“ä½œï¼Œå¸¸ç”¨çš„æœ‰ï¼š</p>
<ul>
  <li><strong>æ±‚å’Œ (Sum)</strong>ï¼š$\mathbf{M}_i = \sum_{j \in \mathcal{N}(i)} \mathbf{m}_{ij}$ â€” ä¿ç•™é‚»å±…æ•°é‡ä¿¡æ¯</li>
  <li><strong>å‡å€¼ (Mean)</strong>ï¼š$\mathbf{M}_i = \frac{1}{|\mathcal{N}(i)|} \sum_{j} \mathbf{m}_{ij}$ â€” å½’ä¸€åŒ–ï¼Œå¯¹å¯†åº¦ä¸æ•æ„Ÿ</li>
  <li><strong>æœ€å¤§å€¼ (Max)</strong>ï¼š$\mathbf{M}_i = \max_{j \in \mathcal{N}(i)} \mathbf{m}_{ij}$ â€” åªä¿ç•™æœ€æ˜¾è‘—çš„æ¶ˆæ¯</li>
</ul>

<p><strong>ç¬¬ 3 æ­¥ï¼šæ›´æ–°å‡½æ•° (Update)</strong></p>
$$
\mathbf{x}_i^{(l+1)} = \gamma\left(\mathbf{x}_i^{(l)}, \mathbf{M}_i^{(l)}\right)
$$
<p>$\gamma$ ç»“åˆæ—§ç‰¹å¾å’Œèšåˆæ¶ˆæ¯äº§ç”Ÿæ–°ç‰¹å¾ã€‚</p>

<div class="diagram">
  <svg width="600" height="280" viewBox="0 0 600 280">
    <!-- Central node -->
    <circle cx="300" cy="140" r="30" fill="var(--accent-light)" stroke="var(--accent)" stroke-width="2.5"/>
    <text x="300" y="145" text-anchor="middle" fill="var(--accent)" font-size="14" font-weight="bold">$x_i$</text>
    
    <!-- Neighbor nodes -->
    <circle cx="150" cy="60" r="24" fill="var(--bg-secondary)" stroke="currentColor" stroke-width="2"/>
    <text x="150" y="65" text-anchor="middle" fill="currentColor" font-size="12">$x_{j_1}$</text>
    
    <circle cx="450" cy="60" r="24" fill="var(--bg-secondary)" stroke="currentColor" stroke-width="2"/>
    <text x="450" y="65" text-anchor="middle" fill="currentColor" font-size="12">$x_{j_2}$</text>
    
    <circle cx="150" cy="220" r="24" fill="var(--bg-secondary)" stroke="currentColor" stroke-width="2"/>
    <text x="150" y="225" text-anchor="middle" fill="currentColor" font-size="12">$x_{j_3}$</text>
    
    <circle cx="450" cy="220" r="24" fill="var(--bg-secondary)" stroke="currentColor" stroke-width="2"/>
    <text x="450" y="225" text-anchor="middle" fill="currentColor" font-size="12">$x_{j_4}$</text>
    
    <!-- Arrows with messages -->
    <line x1="174" y1="72" x2="275" y2="125" stroke="currentColor" stroke-width="1.5" stroke-dasharray="5,3" marker-end="url(#arrowhead)"/>
    <text x="210" y="88" fill="currentColor" font-size="11">$m_{j_1 i}$</text>
    
    <line x1="426" y1="72" x2="325" y2="125" stroke="currentColor" stroke-width="1.5" stroke-dasharray="5,3" marker-end="url(#arrowhead)"/>
    <text x="385" y="88" fill="currentColor" font-size="11">$m_{j_2 i}$</text>
    
    <line x1="174" y1="210" x2="275" y2="158" stroke="currentColor" stroke-width="1.5" stroke-dasharray="5,3" marker-end="url(#arrowhead)"/>
    <text x="210" y="200" fill="currentColor" font-size="11">$m_{j_3 i}$</text>
    
    <line x1="426" y1="210" x2="325" y2="158" stroke="currentColor" stroke-width="1.5" stroke-dasharray="5,3" marker-end="url(#arrowhead)"/>
    <text x="385" y="200" fill="currentColor" font-size="11">$m_{j_4 i}$</text>
    
    <text x="300" y="270" text-anchor="middle" fill="var(--text-muted)" font-size="12">å›¾ 2.1ï¼šæ¶ˆæ¯ä¼ é€’ â€” é‚»å±…å°†æ¶ˆæ¯å‘é€åˆ°ä¸­å¿ƒèŠ‚ç‚¹ï¼Œèšåˆåæ›´æ–°</text>
  </svg>
</div>

<div class="box warning">
  <div class="box-title">âš ï¸ å…³é”®æ¦‚å¿µï¼šæ„Ÿå—é‡ (Receptive Field)</div>
  <p>1 å±‚æ¶ˆæ¯ä¼ é€’ â†’ æ¯ä¸ªèŠ‚ç‚¹åªèƒ½ "çœ‹åˆ°" ç›´æ¥é‚»å±…ï¼ˆ1-hopï¼‰<br>
  2 å±‚æ¶ˆæ¯ä¼ é€’ â†’ å¯ä»¥ "çœ‹åˆ°" 2-hop é‚»å±…<br>
  $K$ å±‚æ¶ˆæ¯ä¼ é€’ â†’ å¯ä»¥ "çœ‹åˆ°" $K$-hop é‚»å±…</p>
  <p>è¿™ç±»ä¼¼äº CNN ä¸­å †å å·ç§¯å±‚å¢å¤§æ„Ÿå—é‡ã€‚åœ¨ç‰©ç†ç³»ç»Ÿä¸­ï¼Œå¤šå±‚æ¶ˆæ¯ä¼ é€’è®© <strong>è¿œè·ç¦»äº¤äº’</strong> çš„ä¿¡æ¯å¯ä»¥ä¼ æ’­åˆ°ä½ã€‚</p>
</div>

<!-- ===== 2.3 ===== -->
<h3 id="ch2-gcn">2.3 GCN (å›¾å·ç§¯ç½‘ç»œ)</h3>

<div class="box definition">
  <div class="box-title">ğŸ“˜ GCN â€” Graph Convolutional Network (Kipf & Welling, 2017)</div>
  <p>GCN æ˜¯æœ€ç»å…¸çš„ GNN ä¹‹ä¸€ï¼Œå®ƒçš„æ›´æ–°è§„åˆ™æ˜¯ï¼š</p>
  $$\mathbf{X}^{(l+1)} = \sigma\left(\hat{\mathbf{D}}^{-\frac{1}{2}} \hat{\mathbf{A}} \hat{\mathbf{D}}^{-\frac{1}{2}} \mathbf{X}^{(l)} \mathbf{W}^{(l)}\right)$$
  <p>å…¶ä¸­ $\hat{\mathbf{A}} = \mathbf{A} + \mathbf{I}$ï¼ˆåŠ è‡ªç¯ï¼‰ï¼Œ$\hat{\mathbf{D}}_{ii} = \sum_j \hat{A}_{ij}$ï¼ˆåº¦çŸ©é˜µï¼‰ï¼Œ$\mathbf{W}^{(l)}$ æ˜¯å¯å­¦ä¹ æƒé‡ã€‚</p>
</div>

<p>é€èŠ‚ç‚¹æ¥çœ‹ï¼ŒGCN çš„æ›´æ–°å¯ä»¥å†™æˆï¼š</p>
$$
\mathbf{x}_i^{(l+1)} = \sigma\left(\sum_{j \in \mathcal{N}(i) \cup \{i\}} \frac{1}{\sqrt{\hat{d}_i \hat{d}_j}} \mathbf{W}^{(l)} \mathbf{x}_j^{(l)}\right)
$$

<p>ç›´è§‰ä¸Šï¼šå¯¹æ¯ä¸ªèŠ‚ç‚¹ï¼Œå–é‚»å±…ç‰¹å¾çš„ <strong>åŠ æƒå¹³å‡</strong>ï¼ˆæŒ‰åº¦å½’ä¸€åŒ–ï¼‰ï¼Œç„¶åé€šè¿‡çº¿æ€§å˜æ¢å’Œéçº¿æ€§æ¿€æ´»ã€‚</p>

<div class="code-container">
  <div class="code-header"><span>Python â€” ç®€å• GCN å±‚å®ç°</span><button class="copy-btn" onclick="copyCode(this)">å¤åˆ¶</button></div>
  <pre><code><span class="kw">import</span> torch
<span class="kw">import</span> torch.nn <span class="kw">as</span> nn

<span class="kw">class</span> <span class="cls">SimpleGCNLayer</span>(nn.Module):
    <span class="str">"""æœ€ç®€å•çš„ GCN å±‚"""</span>
    <span class="kw">def</span> <span class="fn">__init__</span>(<span class="sf">self</span>, in_dim, out_dim):
        <span class="bi">super</span>().__init__()
        <span class="sf">self</span>.linear = nn.Linear(in_dim, out_dim)
    
    <span class="kw">def</span> <span class="fn">forward</span>(<span class="sf">self</span>, x, adj):
        <span class="str">"""
        x:   èŠ‚ç‚¹ç‰¹å¾ [N, in_dim]
        adj: é‚»æ¥çŸ©é˜µ [N, N] (å¸¦è‡ªç¯, å½’ä¸€åŒ–)
        """</span>
        <span class="cmt"># 1. çº¿æ€§å˜æ¢</span>
        h = <span class="sf">self</span>.linear(x)       <span class="cmt"># [N, out_dim]</span>
        <span class="cmt"># 2. é‚»å±…èšåˆ (çŸ©é˜µä¹˜æ³• = åŠ æƒæ±‚å’Œ)</span>
        out = torch.matmul(adj, h)  <span class="cmt"># [N, out_dim]</span>
        <span class="cmt"># 3. æ¿€æ´»</span>
        <span class="kw">return</span> torch.relu(out)</code></pre>
</div>

<!-- ===== 2.4 ===== -->
<h3 id="ch2-gat">2.4 GAT (å›¾æ³¨æ„åŠ›ç½‘ç»œ)</h3>

<div class="box definition">
  <div class="box-title">ğŸ“˜ GAT â€” Graph Attention Network (VeliÄkoviÄ‡ et al., 2018)</div>
  <p>GAT å¼•å…¥ <strong>æ³¨æ„åŠ›æœºåˆ¶</strong> æ¥å­¦ä¹ é‚»å±…çš„é‡è¦æ€§æƒé‡ï¼ˆè€Œéä½¿ç”¨å›ºå®šçš„åº¦å½’ä¸€åŒ–ï¼‰ï¼š</p>
  $$\alpha_{ij} = \frac{\exp\left(\text{LeakyReLU}\left(\mathbf{a}^T [\mathbf{W}\mathbf{x}_i \| \mathbf{W}\mathbf{x}_j]\right)\right)}{\sum_{k \in \mathcal{N}(i)} \exp\left(\text{LeakyReLU}\left(\mathbf{a}^T [\mathbf{W}\mathbf{x}_i \| \mathbf{W}\mathbf{x}_k]\right)\right)}$$
  $$\mathbf{x}_i^{(l+1)} = \sigma\left(\sum_{j \in \mathcal{N}(i)} \alpha_{ij} \mathbf{W} \mathbf{x}_j^{(l)}\right)$$
</div>

<p>æ³¨æ„åŠ›ç³»æ•° $\alpha_{ij}$ çš„å«ä¹‰ï¼šèŠ‚ç‚¹ $j$ å¯¹èŠ‚ç‚¹ $i$ çš„ "é‡è¦æ€§"ã€‚è¿™ä½¿å¾— GNN å¯ä»¥ <strong>åŠ¨æ€åœ°</strong> æ ¹æ®ç‰¹å¾å†³å®šå…³æ³¨å“ªäº›é‚»å±…â€”â€”åœ¨ç‰©ç†ç³»ç»Ÿä¸­ï¼Œè¿™æ„å‘³ç€å¯ä»¥å­¦ä¹ åˆ° "å“ªä¸ªç‰©ä½“å¯¹æˆ‘çš„å½±å“æœ€å¤§"ã€‚</p>

<!-- ===== 2.5 ===== -->
<h3 id="ch2-sage">2.5 GraphSAGE</h3>

<div class="box definition">
  <div class="box-title">ğŸ“˜ GraphSAGE â€” Sample and Aggregate (Hamilton et al., 2017)</div>
  <p>GraphSAGE çš„æ›´æ–°è§„åˆ™ï¼š</p>
  $$\mathbf{h}_{\mathcal{N}(i)} = \text{AGG}\left(\{\mathbf{x}_j, \forall j \in \mathcal{N}(i)\}\right)$$
  $$\mathbf{x}_i^{(l+1)} = \sigma\left(\mathbf{W} \cdot [\mathbf{x}_i^{(l)} \| \mathbf{h}_{\mathcal{N}(i)}]\right)$$
  <p>å…³é”®åˆ›æ–°ï¼š<strong>æ‹¼æ¥ (concatenate)</strong> è‡ªèº«ç‰¹å¾å’Œé‚»å±…èšåˆï¼Œè€ŒéåªåšåŠ æƒæ±‚å’Œã€‚é‡‡æ ·å›ºå®šæ•°é‡é‚»å±…ä½¿å…¶å¯æ‰©å±•åˆ°å¤§è§„æ¨¡å›¾ã€‚</p>
</div>

<table>
  <thead>
    <tr><th>æ–¹æ³•</th><th>èšåˆæ–¹å¼</th><th>è¾¹æƒé‡</th><th>ç‰¹ç‚¹</th></tr>
  </thead>
  <tbody>
    <tr><td>GCN</td><td>åŠ æƒæ±‚å’Œ</td><td>æŒ‰åº¦å›ºå®š</td><td>ç®€å•é«˜æ•ˆ</td></tr>
    <tr><td>GAT</td><td>åŠ æƒæ±‚å’Œ</td><td>æ³¨æ„åŠ›å­¦ä¹ </td><td>è‡ªé€‚åº”æƒé‡</td></tr>
    <tr><td>GraphSAGE</td><td>æ‹¼æ¥ + å˜æ¢</td><td>å‡åŒ€/é‡‡æ ·</td><td>å¯æ‰©å±•åˆ°å¤§å›¾</td></tr>
    <tr><td>GNS (æ¶ˆæ¯ä¼ é€’)</td><td>ä»»æ„ MLP</td><td>å­¦ä¹ è¾¹å‡½æ•°</td><td>æœ€é€šç”¨çµæ´»</td></tr>
  </tbody>
</table>

<!-- ===== 2.6 ===== -->
<h3 id="ch2-pyg">2.6 PyTorch Geometric å…¥é—¨</h3>

<p>PyTorch Geometric (PyG) æ˜¯æœ€æµè¡Œçš„å›¾ç¥ç»ç½‘ç»œåº“ï¼Œå®ƒæä¾›äº†ä¸‰ä¸ªæ ¸å¿ƒæŠ½è±¡ï¼š</p>

<h4>å®‰è£…</h4>
<div class="code-container">
  <div class="code-header"><span>Shell</span><button class="copy-btn" onclick="copyCode(this)">å¤åˆ¶</button></div>
  <pre><code>pip install torch-geometric
<span class="cmt"># æˆ–è€…ç”¨ conda:</span>
conda install pyg -c pyg</code></pre>
</div>

<h4>Data â€” å›¾æ•°æ®å¯¹è±¡</h4>
<div class="code-container">
  <div class="code-header"><span>Python â€” PyG Data å¯¹è±¡</span><button class="copy-btn" onclick="copyCode(this)">å¤åˆ¶</button></div>
  <pre><code><span class="kw">from</span> torch_geometric.data <span class="kw">import</span> Data
<span class="kw">import</span> torch

<span class="cmt"># åˆ›å»ºä¸€ä¸ªç®€å•çš„å›¾</span>
graph = Data(
    x=torch.randn(<span class="num">4</span>, <span class="num">16</span>),         <span class="cmt"># 4 ä¸ªèŠ‚ç‚¹ï¼Œæ¯ä¸ª 16 ç»´ç‰¹å¾</span>
    edge_index=torch.tensor([       <span class="cmt"># è¾¹è¿æ¥</span>
        [<span class="num">0</span>, <span class="num">1</span>, <span class="num">1</span>, <span class="num">2</span>, <span class="num">2</span>, <span class="num">3</span>],
        [<span class="num">1</span>, <span class="num">0</span>, <span class="num">2</span>, <span class="num">1</span>, <span class="num">3</span>, <span class="num">2</span>],
    ], dtype=torch.long),
    edge_attr=torch.randn(<span class="num">6</span>, <span class="num">8</span>),   <span class="cmt"># 6 æ¡è¾¹ï¼Œæ¯ä¸ª 8 ç»´ç‰¹å¾</span>
)

<span class="bi">print</span>(graph)
<span class="cmt"># Data(x=[4, 16], edge_index=[2, 6], edge_attr=[6, 8])</span>
<span class="bi">print</span>(graph.num_nodes)  <span class="cmt"># 4</span>
<span class="bi">print</span>(graph.num_edges)  <span class="cmt"># 6</span></code></pre>
</div>

<h4>Batch â€” æ‰¹é‡å›¾</h4>
<div class="code-container">
  <div class="code-header"><span>Python â€” PyG Batch</span><button class="copy-btn" onclick="copyCode(this)">å¤åˆ¶</button></div>
  <pre><code><span class="kw">from</span> torch_geometric.data <span class="kw">import</span> Batch

<span class="cmt"># å°†å¤šä¸ªå›¾åˆå¹¶æˆä¸€ä¸ª batch</span>
graph1 = Data(x=torch.randn(<span class="num">2</span>, <span class="num">6</span>), edge_index=torch.tensor([[<span class="num">0</span>,<span class="num">1</span>],[<span class="num">1</span>,<span class="num">0</span>]]))
graph2 = Data(x=torch.randn(<span class="num">3</span>, <span class="num">6</span>), edge_index=torch.tensor([[<span class="num">0</span>,<span class="num">1</span>,<span class="num">2</span>],[<span class="num">1</span>,<span class="num">2</span>,<span class="num">0</span>]]))

batch = Batch.from_data_list([graph1, graph2])
<span class="bi">print</span>(batch)
<span class="cmt"># DataBatch(x=[5, 6], edge_index=[2, 5], batch=[5])</span>
<span class="cmt"># PyG è‡ªåŠ¨è°ƒæ•´ edge_index çš„ç¼–å·åç§»!</span></code></pre>
</div>

<h4>MessagePassing â€” è‡ªå®šä¹‰æ¶ˆæ¯ä¼ é€’å±‚</h4>
<div class="code-container">
  <div class="code-header"><span>Python â€” MessagePassing å­ç±»åŒ–</span><button class="copy-btn" onclick="copyCode(this)">å¤åˆ¶</button></div>
  <pre><code><span class="kw">from</span> torch_geometric.nn <span class="kw">import</span> MessagePassing

<span class="kw">class</span> <span class="cls">MyGNNLayer</span>(MessagePassing):
    <span class="kw">def</span> <span class="fn">__init__</span>(<span class="sf">self</span>, in_dim, out_dim, edge_dim):
        <span class="bi">super</span>().__init__(aggr=<span class="str">'add'</span>)  <span class="cmt"># èšåˆæ–¹å¼: æ±‚å’Œ</span>
        <span class="sf">self</span>.msg_mlp = nn.Linear(in_dim * <span class="num">2</span> + edge_dim, out_dim)
        <span class="sf">self</span>.upd_mlp = nn.Linear(in_dim + out_dim, out_dim)
    
    <span class="kw">def</span> <span class="fn">forward</span>(<span class="sf">self</span>, x, edge_index, edge_attr):
        <span class="cmt"># propagate è‡ªåŠ¨è°ƒç”¨ message â†’ aggregate â†’ update</span>
        <span class="kw">return</span> <span class="sf">self</span>.propagate(edge_index, x=x, edge_attr=edge_attr)
    
    <span class="kw">def</span> <span class="fn">message</span>(<span class="sf">self</span>, x_i, x_j, edge_attr):
        <span class="str">"""
        x_i: ç›®æ ‡èŠ‚ç‚¹ç‰¹å¾ [E, in_dim]
        x_j: æºèŠ‚ç‚¹ç‰¹å¾   [E, in_dim]
        edge_attr: è¾¹ç‰¹å¾  [E, edge_dim]
        """</span>
        msg_input = torch.cat([x_i, x_j, edge_attr], dim=-<span class="num">1</span>)
        <span class="kw">return</span> torch.relu(<span class="sf">self</span>.msg_mlp(msg_input))
    
    <span class="kw">def</span> <span class="fn">update</span>(<span class="sf">self</span>, aggr_out, x):
        <span class="str">"""
        aggr_out: èšåˆåçš„æ¶ˆæ¯ [N, out_dim]
        x: åŸå§‹èŠ‚ç‚¹ç‰¹å¾ [N, in_dim]
        """</span>
        upd_input = torch.cat([x, aggr_out], dim=-<span class="num">1</span>)
        <span class="kw">return</span> <span class="sf">self</span>.upd_mlp(upd_input)</code></pre>
</div>

<div class="box theorem">
  <div class="box-title">ğŸ“— PyG çš„ propagate() é­”æ³•</div>
  <p>å½“ä½ è°ƒç”¨ <code>self.propagate(edge_index, x=x, edge_attr=edge_attr)</code> æ—¶ï¼ŒPyG ä¼šï¼š</p>
  <ol>
    <li>æ ¹æ® edge_index è‡ªåŠ¨ä¸ºæ¯æ¡è¾¹æå– <code>x_i</code>ï¼ˆç›®æ ‡ï¼‰å’Œ <code>x_j</code>ï¼ˆæºï¼‰</li>
    <li>è°ƒç”¨ä½ å®šä¹‰çš„ <code>message()</code> å‡½æ•°</li>
    <li>æŒ‰ <code>aggr</code> æ–¹å¼èšåˆåŒä¸€ç›®æ ‡èŠ‚ç‚¹çš„æ¶ˆæ¯</li>
    <li>è°ƒç”¨ä½ å®šä¹‰çš„ <code>update()</code> å‡½æ•°</li>
  </ol>
  <p>ä½ åªéœ€è¦å®šä¹‰ <strong>æ€ä¹ˆç®—æ¶ˆæ¯</strong> å’Œ <strong>æ€ä¹ˆæ›´æ–°</strong>ï¼Œå‰©ä¸‹çš„ PyG å…¨éƒ¨æå®šï¼</p>
</div>


<!-- ================================================================ -->
<!-- ç¬¬ä¸‰ç«  -->
<!-- ================================================================ -->
<h2 id="ch3">ç¬¬ä¸‰ç« ï¼šGraph Network Simulator (GNS) è¯¦è§£</h2>

<h3 id="ch3-bg">3.1 GNS è®ºæ–‡èƒŒæ™¯</h3>

<div class="box definition">
  <div class="box-title">ğŸ“˜ è®ºæ–‡ï¼š"Learning to Simulate Complex Physics with Graph Networks"</div>
  <p><strong>ä½œè€…</strong>ï¼šAlvaro Sanchez-Gonzalez, Jonathan Godwin, Tobias Pfaff, Rex Ying, Jure Leskovec, Peter Battaglia (DeepMind, 2020)</p>
  <p><strong>æ ¸å¿ƒè´¡çŒ®</strong>ï¼šæå‡ºä¸€ä¸ªé€šç”¨çš„åŸºäºå›¾ç¥ç»ç½‘ç»œçš„ç‰©ç†æ¨¡æ‹Ÿå™¨ (GNS)ï¼Œèƒ½å¤Ÿå­¦ä¹  <strong>æµä½“</strong>ã€<strong>åˆšä½“</strong>ã€<strong>å¯å˜å½¢ç‰©ä½“</strong> ç­‰å„ç§ç‰©ç†ç³»ç»Ÿçš„åŠ¨åŠ›å­¦ã€‚</p>
  <p><strong>å…³é”®å‘ç°</strong>ï¼šGNS åœ¨è®­ç»ƒåŸŸå¤–ï¼ˆä¸åŒæ•°é‡ç²’å­ã€ä¸åŒåˆå§‹æ¡ä»¶ï¼‰ä»ç„¶èƒ½ä¿æŒè‰¯å¥½çš„ <strong>æ³›åŒ–æ€§</strong>ã€‚</p>
</div>

<p>GNS çš„æ ¸å¿ƒæ€æƒ³æ˜¯å°†ç‰©ç†æ¨¡æ‹Ÿè½¬åŒ–ä¸ºä¸€ä¸ª <strong>å›¾çº§é¢„æµ‹ä»»åŠ¡</strong>ï¼š</p>
<ol>
  <li>å°†ç‰©ç†ç³»ç»Ÿï¼ˆç²’å­ã€åˆšä½“ç­‰ï¼‰è¡¨ç¤ºä¸ºå›¾ $G = (V, E)$</li>
  <li>ç”¨ GNN é¢„æµ‹æ¯ä¸ªèŠ‚ç‚¹çš„ <strong>åŠ é€Ÿåº¦</strong> $\ddot{\mathbf{x}}_i$</li>
  <li>ç”¨ç§¯åˆ†å™¨ï¼ˆEuler / Verletï¼‰æ¨è¿›çŠ¶æ€ï¼š$\mathbf{v}_{t+1} = \mathbf{v}_t + \ddot{\mathbf{x}} \cdot \Delta t$ï¼Œ$\mathbf{x}_{t+1} = \mathbf{x}_t + \mathbf{v}_{t+1} \cdot \Delta t$</li>
</ol>

<!-- ===== 3.2 ===== -->
<h3 id="ch3-epd">3.2 Encode-Process-Decode æ¶æ„</h3>

<p>GNS é‡‡ç”¨ç»å…¸çš„ <strong>Encode-Process-Decode</strong> æ¶æ„ï¼š</p>

<div class="flow-diagram">
  <div class="flow-box">ğŸ“¥ Encoder<br><small>ç‰©ç†é‡ â†’ embedding</small></div>
  <span class="flow-arrow">â†’</span>
  <div class="flow-box">âš™ï¸ Processor<br><small>M è½®æ¶ˆæ¯ä¼ é€’</small></div>
  <span class="flow-arrow">â†’</span>
  <div class="flow-box">ğŸ“¤ Decoder<br><small>embedding â†’ åŠ é€Ÿåº¦</small></div>
</div>

<h4>1. Encoderï¼ˆç¼–ç å™¨ï¼‰</h4>
<p>å°†åŸå§‹ç‰©ç†é‡æ˜ å°„åˆ°é«˜ç»´ embedding ç©ºé—´ï¼š</p>
$$
\mathbf{h}_i^{(0)} = \text{MLP}_{\text{node}}\left(\mathbf{x}_i^{\text{raw}}\right), \quad
\mathbf{e}_{ij}^{(0)} = \text{MLP}_{\text{edge}}\left(\mathbf{e}_{ij}^{\text{raw}}\right)
$$
<p>åŸå§‹èŠ‚ç‚¹ç‰¹å¾å¯èƒ½æ˜¯ä½ç½®ã€é€Ÿåº¦ã€è´¨é‡ç­‰ï¼›åŸå§‹è¾¹ç‰¹å¾å¯èƒ½æ˜¯ç›¸å¯¹ä½ç½®ã€è·ç¦»ç­‰ã€‚ç¼–ç å™¨ç”¨ MLP å°†å®ƒä»¬æ˜ å°„åˆ°ç»Ÿä¸€çš„éšè—ç»´åº¦ï¼ˆå¦‚ 128Dï¼‰ã€‚</p>

<h4>2. Processorï¼ˆå¤„ç†å™¨ï¼‰</h4>
<p>æ ¸å¿ƒè®¡ç®—å•å…ƒï¼Œç”± $M$ ä¸ªæ¶ˆæ¯ä¼ é€’å±‚å †å ç»„æˆï¼š</p>
$$
\mathbf{h}_i^{(l+1)} = \text{MP}_l\left(\mathbf{h}_i^{(l)}, \{\mathbf{h}_j^{(l)}\}_{j \in \mathcal{N}(i)}, \mathbf{e}_{ij}^{(0)}\right), \quad l = 0, 1, \ldots, M-1
$$
<p>æ¯ä¸€å±‚æ¶ˆæ¯ä¼ é€’éƒ½è®©ä¿¡æ¯åœ¨å›¾ä¸Šæ‰©æ•£ä¸€æ­¥ã€‚$M$ å±‚åï¼Œæ¯ä¸ªèŠ‚ç‚¹å¯ä»¥ "æ„ŸçŸ¥" åˆ° $M$-hop é‚»å±…çš„ä¿¡æ¯ã€‚</p>

<h4>3. Decoderï¼ˆè§£ç å™¨ï¼‰</h4>
<p>ä»æœ€ç»ˆçš„èŠ‚ç‚¹ embedding é¢„æµ‹åŠ é€Ÿåº¦ï¼š</p>
$$
\ddot{\mathbf{x}}_i = \text{MLP}_{\text{decode}}\left(\mathbf{h}_i^{(M)}\right)
$$

<div class="box theorem">
  <div class="box-title">ğŸ“— ä¸ºä»€ä¹ˆé¢„æµ‹åŠ é€Ÿåº¦è€Œéä½ç½®ï¼Ÿ</div>
  <p>é¢„æµ‹ <strong>åŠ é€Ÿåº¦</strong>ï¼ˆæˆ–åŠ›ï¼‰æ¯”ç›´æ¥é¢„æµ‹ <strong>ä¸‹ä¸€æ—¶åˆ»ä½ç½®</strong> è¦å¥½å¾—å¤šï¼š</p>
  <ol>
    <li>åŠ é€Ÿåº¦æ˜¯ <strong>å±€éƒ¨é‡</strong>â€”â€”åªä¾èµ–å½“å‰çŠ¶æ€çš„åŠ›</li>
    <li>ä½ç½®æ˜¯ <strong>ç§¯ç´¯é‡</strong>â€”â€”éœ€è¦é¢„æµ‹é•¿æœŸè½¨è¿¹çš„ç´¯ç§¯æ•ˆæœ</li>
    <li>åŠ é€Ÿåº¦é¢„æµ‹å¯ä»¥é…åˆ <strong>ä»»æ„ç§¯åˆ†å™¨</strong>ï¼ˆEulerã€Verletã€RK4ï¼‰æ¨è¿›çŠ¶æ€</li>
    <li>ç‰©ç†å®šå¾‹ $F = ma$ æœ¬èº«å°±æ˜¯å…³äºåŠ é€Ÿåº¦çš„</li>
  </ol>
</div>

<!-- ===== 3.3 ===== -->
<h3 id="ch3-node">3.3 èŠ‚ç‚¹ç‰¹å¾è®¾è®¡</h3>

<p>GNS ä¸­èŠ‚ç‚¹ç‰¹å¾çš„è®¾è®¡å¯¹æ€§èƒ½è‡³å…³é‡è¦ã€‚å¸¸è§çš„èŠ‚ç‚¹ç‰¹å¾åŒ…æ‹¬ï¼š</p>

<table>
  <thead>
    <tr><th>ç‰¹å¾</th><th>ç»´åº¦</th><th>è¯´æ˜</th></tr>
  </thead>
  <tbody>
    <tr><td>ä½ç½® $\mathbf{x}_i$</td><td>3</td><td>å½“å‰ 3D ä½ç½®</td></tr>
    <tr><td>é€Ÿåº¦ $\mathbf{v}_i$</td><td>3</td><td>å½“å‰é€Ÿåº¦</td></tr>
    <tr><td>å†å²é€Ÿåº¦</td><td>3Ã—K</td><td>è¿‡å» K ä¸ªæ—¶é—´æ­¥çš„é€Ÿåº¦ï¼ˆæä¾›åŠ é€Ÿåº¦ä¿¡æ¯ï¼‰</td></tr>
    <tr><td>è´¨é‡ $m_i$</td><td>1</td><td>ç‰©ä½“è´¨é‡ï¼ˆå¯é€‰ï¼‰</td></tr>
    <tr><td>ç‰©ä½“ç±»å‹</td><td>one-hot</td><td>ç²’å­ / è¾¹ç•Œ / å·¥å…· ç­‰ç±»å‹ç¼–ç </td></tr>
    <tr><td>ç‰©ç†å±æ€§</td><td>å¯å˜</td><td>æ‘©æ“¦ç³»æ•°ã€å¼¹æ€§ç³»æ•°ç­‰</td></tr>
  </tbody>
</table>

<div class="box example">
  <div class="box-title">ğŸ’¡ PushBox ä¸­çš„èŠ‚ç‚¹ç‰¹å¾</div>
  <p>åœ¨æˆ‘ä»¬çš„ PushBox ä¸­ï¼Œæ¯ä¸ªèŠ‚ç‚¹çš„ç‰¹å¾æ˜¯ 6 ç»´ï¼š<code>[pos_x, pos_y, pos_z, vel_x, vel_y, vel_z]</code></p>
  <ul>
    <li>Node 0 (æœ«ç«¯æ‰§è¡Œå™¨): <code>[ee_pos(3), ee_vel(3)]</code></li>
    <li>Node 1 (ç›’å­): <code>[box_pos(3), box_vel(3)]</code></li>
  </ul>
</div>

<!-- ===== 3.4 ===== -->
<h3 id="ch3-edge">3.4 è¾¹ç‰¹å¾è®¾è®¡</h3>

<p>è¾¹ç‰¹å¾ç¼–ç äº†ä¸¤ä¸ªèŠ‚ç‚¹ä¹‹é—´çš„ <strong>å…³ç³»</strong>ã€‚åœ¨ç‰©ç†ç³»ç»Ÿä¸­ï¼Œè¿™é€šå¸¸æ˜¯ç©ºé—´å…³ç³»ï¼š</p>

$$
\mathbf{e}_{ij}^{\text{raw}} = \left[\mathbf{x}_j - \mathbf{x}_i, \|\mathbf{x}_j - \mathbf{x}_i\|, \mathbf{v}_j - \mathbf{v}_i, \|\mathbf{v}_j - \mathbf{v}_i\|\right]
$$

<table>
  <thead>
    <tr><th>ç‰¹å¾</th><th>ç»´åº¦</th><th>ç‰©ç†æ„ä¹‰</th></tr>
  </thead>
  <tbody>
    <tr><td>ç›¸å¯¹ä½ç½® $\mathbf{r}_{ij} = \mathbf{x}_j - \mathbf{x}_i$</td><td>3</td><td>æ–¹å‘å’Œè·ç¦»ä¿¡æ¯</td></tr>
    <tr><td>è·ç¦» $\|\mathbf{r}_{ij}\|$</td><td>1</td><td>æ ‡é‡è·ç¦»ï¼ˆæ—‹è½¬ä¸å˜ï¼‰</td></tr>
    <tr><td>ç›¸å¯¹é€Ÿåº¦ $\mathbf{v}_j - \mathbf{v}_i$</td><td>3</td><td>æ¥è¿‘/è¿œç¦»é€Ÿåº¦</td></tr>
    <tr><td>é€Ÿåº¦èŒƒæ•° $\|\mathbf{v}_j - \mathbf{v}_i\|$</td><td>1</td><td>ç›¸å¯¹é€Ÿç‡</td></tr>
  </tbody>
</table>

<div class="box theorem">
  <div class="box-title">ğŸ“— åå¯¹ç§°æ€§ (Antisymmetry)</div>
  <p>æ³¨æ„ä¸€ä¸ªé‡è¦æ€§è´¨ï¼š$\mathbf{r}_{ij} = -\mathbf{r}_{ji}$ã€‚è¿™æ„å‘³ç€ä» $i$ çœ‹ $j$ å’Œä» $j$ çœ‹ $i$ï¼Œä½ç§»å‘é‡æ–¹å‘ç›¸åã€‚è¿™ç§ <strong>åå¯¹ç§°æ€§</strong> åœ¨ç‰©ç†ä¸Šéå¸¸è‡ªç„¶ï¼ˆç‰›é¡¿ç¬¬ä¸‰å®šå¾‹ï¼š$F_{ij} = -F_{ji}$ï¼‰ï¼Œä¹Ÿæ˜¯ Edge Frame çš„å…³é”®æ€æƒ³ã€‚</p>
</div>

<!-- ===== 3.5 ===== -->
<h3 id="ch3-impl">3.5 æ¶ˆæ¯ä¼ é€’å±‚çš„å®ç°</h3>

<p>ä»¥ä¸‹æ˜¯æˆ‘ä»¬é¡¹ç›®ä¸­ <strong>GraphNetworkLayer</strong> çš„å®Œæ•´å®ç°ï¼Œæ¥è‡ª <code>baselines/gns_baseline.py</code>ï¼š</p>

<div class="code-container">
  <div class="code-header"><span>Python â€” GraphNetworkLayer (gns_baseline.py)</span><button class="copy-btn" onclick="copyCode(this)">å¤åˆ¶</button></div>
  <pre><code><span class="kw">class</span> <span class="cls">GraphNetworkLayer</span>(MessagePassing):
    <span class="str">"""
    å•ä¸ªå›¾ç½‘ç»œå±‚
    æ ‡å‡†æ¶ˆæ¯ä¼ é€’ï¼Œä¸å¸¦ç‰©ç†çº¦æŸ
    """</span>
    
    <span class="kw">def</span> <span class="fn">__init__</span>(<span class="sf">self</span>, node_dim, edge_dim, hidden_dim=<span class="num">128</span>):
        <span class="bi">super</span>().__init__(aggr=<span class="str">'add'</span>)
        
        <span class="cmt"># è¾¹æ¨¡å‹: è®¡ç®—æ¶ˆæ¯</span>
        <span class="sf">self</span>.edge_mlp = nn.Sequential(
            nn.Linear(<span class="num">2</span> * node_dim + edge_dim, hidden_dim),
            nn.ReLU(),
            nn.Linear(hidden_dim, hidden_dim),
            nn.ReLU(),
            nn.Linear(hidden_dim, edge_dim)
        )
        
        <span class="cmt"># èŠ‚ç‚¹æ¨¡å‹: æ›´æ–°èŠ‚ç‚¹ç‰¹å¾</span>
        <span class="sf">self</span>.node_mlp = nn.Sequential(
            nn.Linear(node_dim + edge_dim, hidden_dim),
            nn.ReLU(),
            nn.Linear(hidden_dim, hidden_dim),
            nn.ReLU(),
            nn.Linear(hidden_dim, node_dim)
        )
    
    <span class="kw">def</span> <span class="fn">forward</span>(<span class="sf">self</span>, x, edge_index, edge_attr):
        <span class="kw">return</span> <span class="sf">self</span>.propagate(edge_index, x=x, edge_attr=edge_attr)
    
    <span class="kw">def</span> <span class="fn">message</span>(<span class="sf">self</span>, x_i, x_j, edge_attr):
        <span class="str">"""
        è®¡ç®—è¾¹æ¶ˆæ¯
        x_i: æ¥æ”¶èŠ‚ç‚¹ç‰¹å¾ [E, node_dim]
        x_j: å‘é€èŠ‚ç‚¹ç‰¹å¾ [E, node_dim]
        edge_attr: è¾¹å±æ€§   [E, edge_dim]
        """</span>
        <span class="cmt"># æ‹¼æ¥å‘é€è€…ã€æ¥æ”¶è€…ã€è¾¹çš„ä¿¡æ¯</span>
        edge_input = torch.cat([x_i, x_j, edge_attr], dim=-<span class="num">1</span>)
        <span class="cmt"># æ›´æ–°è¾¹ç‰¹å¾ï¼ˆå³æ¶ˆæ¯ï¼‰</span>
        <span class="kw">return</span> <span class="sf">self</span>.edge_mlp(edge_input)
    
    <span class="kw">def</span> <span class="fn">update</span>(<span class="sf">self</span>, aggr_out, x):
        <span class="str">"""
        æ›´æ–°èŠ‚ç‚¹ç‰¹å¾
        aggr_out: èšåˆåçš„æ¶ˆæ¯ [N, edge_dim]
        x: å½“å‰èŠ‚ç‚¹ç‰¹å¾ [N, node_dim]
        """</span>
        node_input = torch.cat([x, aggr_out], dim=-<span class="num">1</span>)
        <span class="kw">return</span> <span class="sf">self</span>.node_mlp(node_input)</code></pre>
</div>

<p>æ•°æ®æµåˆ†æï¼š</p>
<ol>
  <li><strong>message()</strong>: è¾“å…¥ $(x_i, x_j, e_{ij})$ â†’ è¾“å‡º <code>[E, edge_dim]</code> çš„æ¶ˆæ¯å‘é‡</li>
  <li><strong>aggregate</strong> (ç”± <code>aggr='add'</code> æŒ‡å®š): æŒ‰ç›®æ ‡èŠ‚ç‚¹æ±‚å’Œ â†’ <code>[N, edge_dim]</code></li>
  <li><strong>update()</strong>: æ‹¼æ¥åŸå§‹ç‰¹å¾å’Œèšåˆæ¶ˆæ¯ â†’ MLP â†’ <code>[N, node_dim]</code></li>
</ol>

<!-- ===== 3.6 ===== -->
<h3 id="ch3-multi">3.6 å¤šè½®æ¶ˆæ¯ä¼ é€’</h3>

<p>ä¸ºä»€ä¹ˆéœ€è¦å¤šè½®ï¼ˆå¤šå±‚ï¼‰æ¶ˆæ¯ä¼ é€’ï¼Ÿå…³é”®åœ¨äº <strong>ä¿¡æ¯ä¼ æ’­èŒƒå›´</strong>ï¼š</p>

<div class="box definition">
  <div class="box-title">ğŸ“˜ ä¿¡æ¯ä¼ æ’­ä¸æ„Ÿå—é‡</div>
  <p>$L$ å±‚æ¶ˆæ¯ä¼ é€’åï¼ŒèŠ‚ç‚¹ $i$ çš„è¡¨ç¤º $\mathbf{h}_i^{(L)}$ åŒ…å«äº†å…¶ $L$-hop é‚»åŸŸå†…æ‰€æœ‰èŠ‚ç‚¹çš„ä¿¡æ¯ã€‚</p>
</div>

<p>åœ¨ PushBox ä¸­åªæœ‰ 2 ä¸ªèŠ‚ç‚¹ï¼Œ1 å±‚å°±è¶³å¤Ÿè®©ä¿¡æ¯ä¼ éå…¨å›¾ã€‚ä½†åœ¨æ›´å¤æ‚çš„ç³»ç»Ÿä¸­ï¼š</p>

<table>
  <thead>
    <tr><th>å±‚æ•°</th><th>æ„Ÿå—é‡</th><th>é€‚ç”¨åœºæ™¯</th></tr>
  </thead>
  <tbody>
    <tr><td>1</td><td>ç›´æ¥é‚»å±…</td><td>PushBox (2èŠ‚ç‚¹)ã€çŸ­è·ç¦»åŠ›</td></tr>
    <tr><td>3</td><td>3-hop</td><td>ä¸­ç­‰è§„æ¨¡ç²’å­ç³»ç»Ÿ</td></tr>
    <tr><td>5-10</td><td>5-10-hop</td><td>é“¾çŠ¶ç»“æ„ã€é•¿è·ç¦»ä¾èµ–</td></tr>
    <tr><td>10+</td><td>æ•´ä¸ªå›¾</td><td>å…¨å±€å±æ€§é¢„æµ‹ï¼ˆå¯èƒ½è¿‡å¹³æ»‘ï¼ï¼‰</td></tr>
  </tbody>
</table>

<div class="code-container">
  <div class="code-header"><span>Python â€” å¤šå±‚æ¶ˆæ¯ä¼ é€’ï¼ˆæ®‹å·®è¿æ¥ï¼‰</span><button class="copy-btn" onclick="copyCode(this)">å¤åˆ¶</button></div>
  <pre><code><span class="cmt"># GNSNetwork ä¸­çš„å¤šå±‚æ¶ˆæ¯ä¼ é€’</span>
<span class="sf">self</span>.gn_layers = nn.ModuleList([
    GraphNetworkLayer(hidden_dim, hidden_dim, hidden_dim)
    <span class="kw">for</span> _ <span class="kw">in</span> <span class="bi">range</span>(n_layers)  <span class="cmt"># é€šå¸¸ n_layers = 3~10</span>
])

<span class="cmt"># Forward pass ä¸­:</span>
x = <span class="sf">self</span>.node_encoder(x)
edge_attr = <span class="sf">self</span>.edge_encoder(edge_attr)

<span class="kw">for</span> layer <span class="kw">in</span> <span class="sf">self</span>.gn_layers:
    x_new = layer(x, edge_index, edge_attr)
    x = x + x_new  <span class="cmt"># â† æ®‹å·®è¿æ¥ï¼é˜²æ­¢æ¢¯åº¦æ¶ˆå¤±</span>

acc = <span class="sf">self</span>.decoder(x)</code></pre>
</div>

<div class="box warning">
  <div class="box-title">âš ï¸ æ®‹å·®è¿æ¥çš„é‡è¦æ€§</div>
  <p>æ³¨æ„ <code>x = x + x_new</code> è¿™è¡Œæ®‹å·®è¿æ¥ã€‚æ²¡æœ‰å®ƒï¼Œæ·±å±‚ GNN ä¼š <strong>æ¢¯åº¦æ¶ˆå¤±</strong> æˆ– <strong>è¿‡å¹³æ»‘</strong>ï¼ˆæ‰€æœ‰èŠ‚ç‚¹ç‰¹å¾è¶‹åŒï¼‰ã€‚æ®‹å·®è¿æ¥ä¿ç•™äº†åŸå§‹ä¿¡æ¯ï¼Œè®©ä¼˜åŒ–æ›´ç¨³å®šã€‚</p>
</div>

<!-- ===== 3.7 ===== -->
<h3 id="ch3-global">3.7 å…¨å±€ç‰¹å¾</h3>

<p>æœ‰äº›ç‰©ç†é‡æ˜¯å…¨å±€çš„ï¼ˆå¦‚é‡åŠ›æ–¹å‘ã€ç³»ç»Ÿæ€»èƒ½é‡ï¼‰ï¼Œæ— æ³•å½’å±äºä»»ä½•å•ä¸ªèŠ‚ç‚¹æˆ–è¾¹ã€‚GNS å¯ä»¥å¼•å…¥ <strong>å…¨å±€èŠ‚ç‚¹</strong> æ¥å¤„ç†ï¼š</p>

$$
\mathbf{u} = \phi_u\left(\mathbf{u}^{(l)}, \sum_i \mathbf{h}_i^{(l)}\right)
$$

<p>å…¨å±€èŠ‚ç‚¹è¿æ¥åˆ°æ‰€æœ‰å…¶ä»–èŠ‚ç‚¹ï¼Œå¯ä»¥å¹¿æ’­å…¨å±€ä¿¡æ¯ï¼ˆå¦‚é‡åŠ›ã€å¤–éƒ¨åœºï¼‰ï¼Œä¹Ÿå¯ä»¥æ±‡æ€»å…¨å±€ç»Ÿè®¡é‡ï¼ˆå¦‚ç³»ç»Ÿæ€»èƒ½é‡ï¼‰ã€‚</p>

<div class="box example">
  <div class="box-title">ğŸ’¡ åœ¨ PushBox ä¸­</div>
  <p>æˆ‘ä»¬çš„ PushBox åªæœ‰ 2 ä¸ªèŠ‚ç‚¹ï¼Œ1 è½®æ¶ˆæ¯ä¼ é€’å·²ç»èƒ½è®©ä¿¡æ¯ä¼ éå…¨å›¾ï¼Œæ‰€ä»¥ <strong>ä¸éœ€è¦å…¨å±€èŠ‚ç‚¹</strong>ã€‚ä½†å¦‚æœæ‰©å±•åˆ°å¤šç‰©ä½“åœºæ™¯ï¼ˆ10+ ä¸ªç®±å­ï¼‰ï¼Œå…¨å±€èŠ‚ç‚¹å¯ä»¥ç¼–ç ç›®æ ‡ä¿¡æ¯æˆ–ç¯å¢ƒå‚æ•°ã€‚</p>
</div>


<!-- ================================================================ -->
<!-- ç¬¬å››ç«  -->
<!-- ================================================================ -->
<h2 id="ch4">ç¬¬å››ç« ï¼šè¾¹å¸§ (Edge Frame) ä¸ç‰©ç†çº¦æŸ</h2>

<h3 id="ch4-what">4.1 ä»€ä¹ˆæ˜¯ Edge Frame</h3>

<div class="box definition">
  <div class="box-title">ğŸ“˜ å®šä¹‰ï¼šè¾¹å¸§ (Edge Frame)</div>
  <p>è¾¹å¸§æ˜¯ä»¥æ¯æ¡ <strong>è¾¹</strong> ä¸ºä¸­å¿ƒæ„å»ºçš„ <strong>å±€éƒ¨åæ ‡ç³»</strong>ã€‚å¯¹äºè¾¹ $(i, j)$ï¼Œä»¥ä½ç§»å‘é‡ $\mathbf{r}_{ij} = \mathbf{x}_j - \mathbf{x}_i$ ä¸ºåŸºå‡†æ–¹å‘ï¼Œæ„å»ºä¸€ä¸ªæ­£äº¤åŸº $\{\mathbf{e}_1, \mathbf{e}_2, \mathbf{e}_3\}$ï¼Œç„¶ååœ¨æ­¤åæ ‡ç³»ä¸‹è¡¨ç¤ºæ‰€æœ‰ç‰©ç†é‡ã€‚</p>
</div>

<p>ä¼ ç»Ÿ GNN ä½¿ç”¨å…¨å±€åæ ‡ç³»ä¸‹çš„ç»å¯¹ä½ç½®å’Œé€Ÿåº¦ä½œä¸ºç‰¹å¾ã€‚Edge Frame åˆ™å°†è¿™äº›ç‰¹å¾ <strong>è½¬æ¢åˆ°å±€éƒ¨åæ ‡ç³»</strong>ï¼Œä½¿å¾—ï¼š</p>
<ul>
  <li><strong>å¹³ç§»ä¸å˜æ€§</strong>ï¼šåªä½¿ç”¨ç›¸å¯¹é‡ $\mathbf{r}_{ij} = \mathbf{x}_j - \mathbf{x}_i$ï¼Œä¸ç»å¯¹ä½ç½®æ— å…³</li>
  <li><strong>æ—‹è½¬ç­‰å˜æ€§</strong>ï¼šåŠ›çš„æ–¹å‘éšåæ ‡ç³»æ—‹è½¬ï¼Œä½†ç‰©ç†è§„å¾‹ä¸å˜</li>
  <li><strong>åå¯¹ç§°æ€§</strong>ï¼š$\mathbf{e}_{ij} = -\mathbf{e}_{ji}$ï¼Œè‡ªåŠ¨æ»¡è¶³ç‰›é¡¿ç¬¬ä¸‰å®šå¾‹</li>
</ul>

<!-- ===== 4.2 ===== -->
<h3 id="ch4-why">4.2 ä¸ºä»€ä¹ˆ Edge Frame é‡è¦</h3>

<div class="box theorem">
  <div class="box-title">ğŸ“— æ ¸å¿ƒè®ºç‚¹</div>
  <p>ç‰©ç†å®šå¾‹å…·æœ‰ <strong>å¯¹ç§°æ€§</strong>ï¼š</p>
  <ul>
    <li><strong>å¹³ç§»å¯¹ç§°æ€§</strong> â†’ åŠ¨é‡å®ˆæ’ï¼ˆNoether å®šç†ï¼‰</li>
    <li><strong>æ—‹è½¬å¯¹ç§°æ€§</strong> â†’ è§’åŠ¨é‡å®ˆæ’</li>
    <li><strong>æ—¶é—´å¹³ç§»å¯¹ç§°æ€§</strong> â†’ èƒ½é‡å®ˆæ’</li>
  </ul>
  <p>å¦‚æœç½‘ç»œçš„è¾“å…¥ç‰¹å¾æ²¡æœ‰è¿™äº›å¯¹ç§°æ€§ï¼Œç½‘ç»œå°±éœ€è¦ <strong>ä»æ•°æ®ä¸­å­¦ä¹ </strong> å®ƒä»¬â€”â€”è¿™æµªè´¹äº†å¤§é‡æ ·æœ¬ã€‚Edge Frame å°†å¯¹ç§°æ€§ <strong>å†…ç½®åˆ°ç½‘ç»œç»“æ„ä¸­</strong>ï¼Œè®©ç½‘ç»œä»ä¸€å¼€å§‹å°±è‡ªåŠ¨æ»¡è¶³ã€‚</p>
</div>

<p>ç”¨ä¸€ä¸ªå…·ä½“ä¾‹å­è¯´æ˜ï¼š</p>

<div class="compare-grid">
  <div class="compare-card">
    <h4>âŒ æ²¡æœ‰ Edge Frame</h4>
    <p>è¾“å…¥ï¼šç»å¯¹ä½ç½® $\mathbf{x}_i = [1, 2, 3]$</p>
    <p>å¦‚æœæ•´ä¸ªç³»ç»Ÿå¹³ç§» $[10, 0, 0]$ï¼š</p>
    <p>$\mathbf{x}_i' = [11, 2, 3]$ â†’ <strong>å®Œå…¨ä¸åŒçš„è¾“å…¥ï¼</strong></p>
    <p>ç½‘ç»œéœ€è¦å­¦åˆ°"å¹³ç§»ä¸å½±å“ç‰©ç†"ã€‚</p>
  </div>
  <div class="compare-card">
    <h4>âœ… æœ‰ Edge Frame</h4>
    <p>è¾“å…¥ï¼šç›¸å¯¹ä½ç½® $\mathbf{r}_{ij} = \mathbf{x}_j - \mathbf{x}_i$</p>
    <p>å¦‚æœæ•´ä¸ªç³»ç»Ÿå¹³ç§» $[10, 0, 0]$ï¼š</p>
    <p>$\mathbf{r}_{ij}' = (\mathbf{x}_j + [10,0,0]) - (\mathbf{x}_i + [10,0,0]) = \mathbf{r}_{ij}$</p>
    <p><strong>è¾“å…¥å®Œå…¨ä¸å˜ï¼</strong>å¤©ç”Ÿå¹³ç§»ä¸å˜ã€‚</p>
  </div>
</div>

<!-- ===== 4.3 ===== -->
<h3 id="ch4-math">4.3 Edge Frame çš„æ•°å­¦</h3>

<p>å¯¹äºè¾¹ $(i, j)$ï¼ŒEdge Frame è®¡ç®—ä»¥ä¸‹ç‰¹å¾ï¼š</p>

<h4>1. ä½ç§»å‘é‡ä¸è·ç¦»</h4>
$$
\mathbf{r}_{ij} = \mathbf{x}_j - \mathbf{x}_i \in \mathbb{R}^3, \quad d_{ij} = \|\mathbf{r}_{ij}\| \in \mathbb{R}
$$

<h4>2. ç›¸å¯¹é€Ÿåº¦ä¸é€Ÿç‡</h4>
$$
\mathbf{v}_{ij}^{\text{rel}} = \mathbf{v}_j - \mathbf{v}_i \in \mathbb{R}^3, \quad s_{ij} = \|\mathbf{v}_{ij}^{\text{rel}}\| \in \mathbb{R}
$$

<h4>3. ç»„åˆè¾¹ç‰¹å¾</h4>
$$
\mathbf{e}_{ij} = [\mathbf{r}_{ij},\; d_{ij},\; \mathbf{v}_{ij}^{\text{rel}},\; s_{ij}] \in \mathbb{R}^8
$$

<h4>4. åå¯¹ç§°æ€§è´¨</h4>
$$
\mathbf{r}_{ij} = -\mathbf{r}_{ji}, \quad \mathbf{v}_{ij}^{\text{rel}} = -\mathbf{v}_{ji}^{\text{rel}}
$$
<p>ä½† $d_{ij} = d_{ji}$ï¼Œ$s_{ij} = s_{ji}$ï¼ˆèŒƒæ•°æ€»ä¸ºæ­£ï¼‰ã€‚</p>

<div class="box theorem">
  <div class="box-title">ğŸ“— åå¯¹ç§°æ€§ä¸ç‰›é¡¿ç¬¬ä¸‰å®šå¾‹</div>
  <p>ç”±äº $\mathbf{r}_{ij} = -\mathbf{r}_{ji}$ï¼Œå¦‚æœåŠ› $\mathbf{F}_{ij}$ æ˜¯ $\mathbf{r}_{ij}$ çš„å¥‡å‡½æ•°ï¼Œåˆ™è‡ªåŠ¨æ»¡è¶³ $\mathbf{F}_{ij} = -\mathbf{F}_{ji}$ï¼ˆç‰›é¡¿ç¬¬ä¸‰å®šå¾‹ï¼‰ï¼Œè¿›è€Œä¿è¯ <strong>åŠ¨é‡å®ˆæ’</strong>ï¼š</p>
  $$\sum_i \mathbf{F}_i = \sum_i \sum_{j \neq i} \mathbf{F}_{ij} = \sum_{(i,j)} (\mathbf{F}_{ij} + \mathbf{F}_{ji}) = \mathbf{0}$$
</div>

<!-- ===== 4.4 ===== -->
<h3 id="ch4-code">4.4 æˆ‘ä»¬çš„ EdgeFrame å®ç° â€” å®Œæ•´ä»£ç è§£æ</h3>

<p>ä»¥ä¸‹æ˜¯ <code>physics_core/edge_frame.py</code> ä¸­ <strong>EdgeFrame</strong> ç±»çš„å®Œæ•´å®ç°ï¼Œé™„é€è¡Œè§£é‡Šï¼š</p>

<div class="code-container">
  <div class="code-header"><span>Python â€” edge_frame.py å®Œæ•´æºç </span><button class="copy-btn" onclick="copyCode(this)">å¤åˆ¶</button></div>
  <pre><code><span class="kw">import</span> torch
<span class="kw">import</span> torch.nn <span class="kw">as</span> nn
<span class="kw">from</span> typing <span class="kw">import</span> Tuple, Optional


<span class="kw">class</span> <span class="cls">EdgeFrame</span>(nn.Module):
    <span class="str">"""
    Edge Frame for encoding spatial relationships between nodes.
    
    Given nodes i and j with positions x_i, x_j and velocities v_i, v_j,
    constructs antisymmetric edge features:
    
    e_ij = [r_ij, ||r_ij||, v_rel, ||v_rel||]
    
    where r_ij = x_j - x_i (displacement vector)
          v_rel = v_j - v_i (relative velocity)
    """</span>
    
    <span class="kw">def</span> <span class="fn">__init__</span>(<span class="sf">self</span>, hidden_dim: <span class="bi">int</span> = <span class="num">64</span>):
        <span class="bi">super</span>().__init__()
        <span class="sf">self</span>.hidden_dim = hidden_dim
        
        <span class="cmt"># è¾¹ç‰¹å¾ç¼–ç å™¨ï¼ˆä¿æŒåå¯¹ç§°æ€§ï¼‰</span>
        <span class="cmt"># è¾“å…¥: [dx, dy, dz, ||r||, dvx, dvy, dvz, ||v||] = 8 ä¸ªç‰¹å¾</span>
        <span class="sf">self</span>.edge_encoder = nn.Sequential(
            nn.Linear(<span class="num">8</span>, hidden_dim),       <span class="cmt"># 8D â†’ hidden_dim</span>
            nn.LayerNorm(hidden_dim),       <span class="cmt"># å½’ä¸€åŒ–ç¨³å®šè®­ç»ƒ</span>
            nn.ReLU(),                      <span class="cmt"># éçº¿æ€§æ¿€æ´»</span>
            nn.Linear(hidden_dim, hidden_dim),
            nn.LayerNorm(hidden_dim),
            nn.ReLU(),
        )
        
    <span class="kw">def</span> <span class="fn">forward</span>(
        <span class="sf">self</span>,
        positions: torch.Tensor,   <span class="cmt"># (N, 3)</span>
        velocities: torch.Tensor,  <span class="cmt"># (N, 3)</span>
        edge_index: torch.Tensor,  <span class="cmt"># (2, E)</span>
    ) -> torch.Tensor:             <span class="cmt"># (E, hidden_dim)</span>

        <span class="cmt"># æå–æºèŠ‚ç‚¹å’Œç›®æ ‡èŠ‚ç‚¹çš„ç´¢å¼•</span>
        src_idx, tgt_idx = edge_index[<span class="num">0</span>], edge_index[<span class="num">1</span>]
        
        <span class="cmt"># ========= æ ¸å¿ƒè®¡ç®— =========</span>
        
        <span class="cmt"># 1. ä½ç§»å‘é‡ï¼ˆåå¯¹ç§°ï¼‰: r_ij = x_target - x_source</span>
        r_ij = positions[tgt_idx] - positions[src_idx]   <span class="cmt"># (E, 3)</span>
        r_norm = torch.norm(r_ij, dim=<span class="num">1</span>, keepdim=<span class="kw">True</span>)  <span class="cmt"># (E, 1)</span>
        
        <span class="cmt"># 2. ç›¸å¯¹é€Ÿåº¦ï¼ˆåå¯¹ç§°ï¼‰: v_rel = v_target - v_source</span>
        v_rel = velocities[tgt_idx] - velocities[src_idx] <span class="cmt"># (E, 3)</span>
        v_norm = torch.norm(v_rel, dim=<span class="num">1</span>, keepdim=<span class="kw">True</span>)  <span class="cmt"># (E, 1)</span>
        
        <span class="cmt"># 3. æ‹¼æ¥åŸå§‹ç‰¹å¾: [r_ij(3), ||r||(1), v_rel(3), ||v||(1)] = 8D</span>
        edge_features = torch.cat([r_ij, r_norm, v_rel, v_norm], dim=<span class="num">1</span>)
        
        <span class="cmt"># 4. ç¼–ç åˆ°é«˜ç»´ç©ºé—´</span>
        edge_hidden = <span class="sf">self</span>.edge_encoder(edge_features)  <span class="cmt"># (E, hidden_dim)</span>
        
        <span class="kw">return</span> edge_hidden</code></pre>
</div>

<p><strong>é€æ­¥è§£æï¼š</strong></p>
<ol>
  <li><strong>è¾“å…¥</strong>ï¼šæ‰€æœ‰èŠ‚ç‚¹çš„ä½ç½® $(N, 3)$ã€é€Ÿåº¦ $(N, 3)$ã€è¾¹è¿æ¥ $(2, E)$</li>
  <li><strong>ç´¢å¼•æå–</strong>ï¼š<code>edge_index[0]</code> æ˜¯æºèŠ‚ç‚¹ç¼–å·ï¼Œ<code>edge_index[1]</code> æ˜¯ç›®æ ‡èŠ‚ç‚¹ç¼–å·</li>
  <li><strong>ä½ç§»è®¡ç®—</strong>ï¼šç”¨ PyTorch çš„é«˜çº§ç´¢å¼• <code>positions[tgt_idx]</code> ä¸€æ¬¡æ€§å–å‡ºæ‰€æœ‰è¾¹çš„ç›®æ ‡èŠ‚ç‚¹ä½ç½®ï¼Œç„¶åå‡å»æºèŠ‚ç‚¹ä½ç½®</li>
  <li><strong>èŒƒæ•°è®¡ç®—</strong>ï¼š<code>torch.norm(..., keepdim=True)</code> ä¿æŒç»´åº¦ä»¥ä¾¿åç»­æ‹¼æ¥</li>
  <li><strong>MLP ç¼–ç </strong>ï¼š8D åŸå§‹ç‰¹å¾ â†’ <code>hidden_dim</code>D éšè—è¡¨ç¤º</li>
</ol>

<h4>åå¯¹ç§°æ€§éªŒè¯</h4>
<div class="code-container">
  <div class="code-header"><span>Python â€” éªŒè¯åå¯¹ç§°æ€§</span><button class="copy-btn" onclick="copyCode(this)">å¤åˆ¶</button></div>
  <pre><code><span class="kw">def</span> <span class="fn">check_antisymmetry</span>(<span class="sf">self</span>, positions, velocities, edge_index):
    <span class="str">"""éªŒè¯: e_ij â‰ˆ -e_ji (åå¯¹ç§°æ€§è´¨)"""</span>
    <span class="cmt"># æ­£å‘è¾¹ e_ij</span>
    e_ij = <span class="sf">self</span>(positions, velocities, edge_index)
    
    <span class="cmt"># åå‘è¾¹ e_ji (äº¤æ¢æºå’Œç›®æ ‡)</span>
    edge_index_rev = torch.stack([edge_index[<span class="num">1</span>], edge_index[<span class="num">0</span>]], dim=<span class="num">0</span>)
    e_ji = <span class="sf">self</span>(positions, velocities, edge_index_rev)
    
    <span class="cmt"># æ£€æŸ¥ e_ij + e_ji â‰ˆ 0</span>
    antisym_error = torch.max(torch.abs(e_ij + e_ji))
    <span class="kw">return</span> antisym_error.item()
    <span class="cmt"># æ³¨æ„ï¼šç»è¿‡ MLP ååå¯¹ç§°æ€§ä¸å†ä¸¥æ ¼æˆç«‹</span>
    <span class="cmt"># ä½†åŸå§‹ç‰¹å¾å±‚é¢ (r_ij = -r_ji) æ˜¯ç²¾ç¡®çš„</span></code></pre>
</div>

<div class="box warning">
  <div class="box-title">âš ï¸ MLP ä¼šç ´åä¸¥æ ¼åå¯¹ç§°</div>
  <p>åŸå§‹çš„ 8D è¾¹ç‰¹å¾ä¸­ï¼Œ$\mathbf{r}_{ij}$ å’Œ $\mathbf{v}_{rel}$ æ˜¯ä¸¥æ ¼åå¯¹ç§°çš„ï¼Œä½†ç»è¿‡éçº¿æ€§ MLP ç¼–ç åï¼Œ$\mathbf{e}_{ij}$ ä¸å†ä¸¥æ ¼ç­‰äº $-\mathbf{e}_{ji}$ã€‚ä¸è¿‡ï¼ŒMLP å¯ä»¥ <strong>å­¦ä¹ åˆ°</strong> è¿‘ä¼¼çš„åå¯¹ç§°æ€§ã€‚å¦‚æœéœ€è¦ <strong>ä¸¥æ ¼</strong> åå¯¹ç§°ï¼Œéœ€è¦ä½¿ç”¨å¥‡å‡½æ•°æ¿€æ´»æˆ–ä¸“é—¨çš„åå¯¹ç§°æ¶æ„ï¼ˆè§ç¬¬äº”ç« ï¼‰ã€‚</p>
</div>

<!-- ===== 4.5 ===== -->
<h3 id="ch4-compare">4.5 å¯¹æ¯”ï¼šæœ‰ vs æ—  Edge Frame</h3>

<table>
  <thead>
    <tr><th>æ–¹é¢</th><th>æ—  Edge Frame</th><th>æœ‰ Edge Frame</th></tr>
  </thead>
  <tbody>
    <tr><td>å¹³ç§»ä¸å˜æ€§</td><td>âŒ éœ€è¦å­¦ä¹ </td><td>âœ… å†…ç½®</td></tr>
    <tr><td>æ—‹è½¬ç­‰å˜æ€§</td><td>âŒ éœ€è¦å­¦ä¹ </td><td>âš ï¸ éƒ¨åˆ†ï¼ˆéœ€èŒƒæ•°ç‰¹å¾ï¼‰</td></tr>
    <tr><td>åå¯¹ç§°æ€§</td><td>âŒ éœ€è¦å­¦ä¹ </td><td>âœ… åŸå§‹ç‰¹å¾å±‚ç²¾ç¡®</td></tr>
    <tr><td>æ³›åŒ–åˆ°æ–°ä½ç½®</td><td>å·®ï¼ˆè¿‡æ‹Ÿåˆç»å¯¹åæ ‡ï¼‰</td><td>å¥½ï¼ˆåªä¾èµ–ç›¸å¯¹é‡ï¼‰</td></tr>
    <tr><td>æ ·æœ¬æ•ˆç‡</td><td>ä½</td><td>é«˜ï¼ˆå¯¹ç§°æ€§é™ä½æœç´¢ç©ºé—´ï¼‰</td></tr>
    <tr><td>è®¡ç®—å¼€é”€</td><td>ç•¥ä½</td><td>ç•¥é«˜ï¼ˆéœ€è®¡ç®—ç›¸å¯¹é‡ï¼‰</td></tr>
  </tbody>
</table>


<!-- ================================================================ -->
<!-- ç¬¬äº”ç«  -->
<!-- ================================================================ -->
<h2 id="ch5">ç¬¬äº”ç« ï¼šDynami-CAL GNN</h2>

<h3 id="ch5-what">5.1 ä»€ä¹ˆæ˜¯ Dynami-CAL</h3>

<div class="box definition">
  <div class="box-title">ğŸ“˜ Dynami-CAL GNN â€” åŠ¨åŠ›å­¦æ„ŸçŸ¥çš„å›¾ç½‘ç»œ</div>
  <p>Dynami-CAL (Dynamics-Calibrated) æ˜¯æˆ‘ä»¬åœ¨æ ‡å‡† GNS åŸºç¡€ä¸Šçš„å¢å¼ºç‰ˆæœ¬ï¼Œæ ¸å¿ƒåˆ›æ–°æ˜¯ï¼š</p>
  <ul>
    <li><strong>è¾¹å±€éƒ¨åæ ‡ç³»</strong>ï¼ˆEdge Frameï¼‰ä¿è¯å¹³ç§»/æ—‹è½¬ç­‰å˜æ€§</li>
    <li><strong>åå¯¹ç§°æ¶ˆæ¯ä¼ é€’</strong> è‡ªåŠ¨æ»¡è¶³ç‰›é¡¿ç¬¬ä¸‰å®šå¾‹ â†’ åŠ¨é‡å®ˆæ’</li>
    <li><strong>è¾›ç§¯åˆ†å™¨</strong>ï¼ˆSymplectic Integratorï¼‰ä¿æŒå“ˆå¯†é¡¿ç»“æ„ â†’ èƒ½é‡å®ˆæ’</li>
    <li><strong>åŠ›åˆ†è§£</strong> åœ¨å±€éƒ¨åæ ‡ç³»ä¸‹åˆ†è§£åŠ›çš„åˆ†é‡</li>
  </ul>
</div>

<!-- ===== 5.2 ===== -->
<h3 id="ch5-pmp">5.2 PhysicsMessagePassing â€” ç‰©ç†æ¶ˆæ¯ä¼ é€’å±‚</h3>

<p>ä»¥ä¸‹æ˜¯ <code>physics_core/dynamical_gnn.py</code> ä¸­ <strong>PhysicsMessagePassing</strong> çš„å®Œæ•´å®ç°ï¼š</p>

<div class="code-container">
  <div class="code-header"><span>Python â€” PhysicsMessagePassing (dynamical_gnn.py)</span><button class="copy-btn" onclick="copyCode(this)">å¤åˆ¶</button></div>
  <pre><code><span class="kw">class</span> <span class="cls">PhysicsMessagePassing</span>(MessagePassing):
    <span class="str">"""
    å¸¦ç‰©ç†çº¦æŸçš„æ¶ˆæ¯ä¼ é€’å±‚
    
    Message: m_ij = Ï†(e_ij, h_i, h_j)
    Update:  h_i' = Ïˆ(h_i, Î£_j m_ij)
    """</span>
    
    <span class="kw">def</span> <span class="fn">__init__</span>(<span class="sf">self</span>, hidden_dim: <span class="bi">int</span>, edge_dim: <span class="bi">int</span>):
        <span class="bi">super</span>().__init__(aggr=<span class="str">'add'</span>)  <span class="cmt"># Sum èšåˆ â€” åŠ›çš„å åŠ åŸç†!</span>
        <span class="sf">self</span>.hidden_dim = hidden_dim
        <span class="sf">self</span>.edge_dim = edge_dim
        
        <span class="cmt"># æ¶ˆæ¯ç½‘ç»œ Ï†: æ ¹æ®è¾¹ç‰¹å¾å’Œä¸¤ç«¯èŠ‚ç‚¹è®¡ç®—æ¶ˆæ¯</span>
        <span class="sf">self</span>.message_net = nn.Sequential(
            nn.Linear(edge_dim + <span class="num">2</span> * hidden_dim, hidden_dim),
            nn.LayerNorm(hidden_dim),
            nn.ReLU(),
            nn.Linear(hidden_dim, hidden_dim),
        )
        
        <span class="cmt"># æ›´æ–°ç½‘ç»œ Ïˆ: ç»“åˆæ—§ç‰¹å¾å’Œèšåˆæ¶ˆæ¯</span>
        <span class="sf">self</span>.update_net = nn.Sequential(
            nn.Linear(<span class="num">2</span> * hidden_dim, hidden_dim),
            nn.LayerNorm(hidden_dim),
            nn.ReLU(),
            nn.Linear(hidden_dim, hidden_dim),
        )
    
    <span class="kw">def</span> <span class="fn">forward</span>(<span class="sf">self</span>, x, edge_index, edge_attr):
        <span class="kw">return</span> <span class="sf">self</span>.propagate(edge_index, x=x, edge_attr=edge_attr)
    
    <span class="kw">def</span> <span class="fn">message</span>(<span class="sf">self</span>, x_i, x_j, edge_attr):
        <span class="str">"""
        æ„é€ æ¶ˆæ¯ m_ij: ä»æº j å‘é€åˆ°ç›®æ ‡ i
        
        å…³é”®: edge_attr æ¥è‡ª EdgeFrame, å·²ç»åŒ…å«åå¯¹ç§°ä¿¡æ¯
        """</span>
        msg_input = torch.cat([edge_attr, x_i, x_j], dim=-<span class="num">1</span>)
        messages = <span class="sf">self</span>.message_net(msg_input)
        <span class="kw">return</span> messages
    
    <span class="kw">def</span> <span class="fn">update</span>(<span class="sf">self</span>, aggr_out, x):
        <span class="str">"""
        æ›´æ–°èŠ‚ç‚¹ç‰¹å¾ (å¸¦æ®‹å·®è¿æ¥)
        
        aggr_out = Î£_j m_ij  â€” æ‰€æœ‰å…¥è¾¹æ¶ˆæ¯ä¹‹å’Œ
        x = åŸå§‹èŠ‚ç‚¹ç‰¹å¾
        """</span>
        update_input = torch.cat([x, aggr_out], dim=-<span class="num">1</span>)
        x_new = <span class="sf">self</span>.update_net(update_input) + x  <span class="cmt"># â† æ®‹å·®!</span>
        <span class="kw">return</span> x_new</code></pre>
</div>

<p><strong>ä¸æ ‡å‡† GraphNetworkLayer çš„åŒºåˆ«ï¼š</strong></p>
<ol>
  <li><strong>edge_attr æ¥è‡ª EdgeFrame</strong>ï¼šå·²ç»ç¼–ç äº†åå¯¹ç§°çš„ç©ºé—´å…³ç³»</li>
  <li><strong><code>aggr='add'</code></strong>ï¼šæ±‚å’Œèšåˆ = åŠ›çš„å åŠ åŸç† $\mathbf{F}_i = \sum_j \mathbf{F}_{ij}$</li>
  <li><strong>æ®‹å·®è¿æ¥</strong>ï¼š<code>update_net(input) + x</code>ï¼Œè®©ä¼˜åŒ–æ›´ç¨³å®š</li>
  <li><strong>LayerNorm</strong>ï¼šå½’ä¸€åŒ–éšè—è¡¨ç¤ºï¼Œé˜²æ­¢æ•°å€¼çˆ†ç‚¸/æ¶ˆå¤±</li>
</ol>

<!-- ===== 5.3 ===== -->
<h3 id="ch5-arch">5.3 DynamicalGNN å®Œæ•´æ¶æ„</h3>

<p>å°† EdgeFrame + PhysicsMessagePassing + Decoder ç»„åˆä¸ºå®Œæ•´çš„ DynamicalGNNï¼š</p>

<div class="flow-diagram">
  <div class="flow-box">ğŸŒ EdgeFrame<br><small>ä½ç½®+é€Ÿåº¦â†’è¾¹ç‰¹å¾</small></div>
  <span class="flow-arrow">â†’</span>
  <div class="flow-box">ğŸ“¥ NodeEncoder<br><small>çŠ¶æ€â†’embedding</small></div>
  <span class="flow-arrow">â†’</span>
  <div class="flow-box">âš™ï¸ MP Ã— N<br><small>ç‰©ç†æ¶ˆæ¯ä¼ é€’</small></div>
  <span class="flow-arrow">â†’</span>
  <div class="flow-box">ğŸ“¤ Decoder<br><small>embeddingâ†’åŠ é€Ÿåº¦</small></div>
</div>

<div class="code-container">
  <div class="code-header"><span>Python â€” DynamicalGNN å®Œæ•´æ¶æ„ (dynamical_gnn.py)</span><button class="copy-btn" onclick="copyCode(this)">å¤åˆ¶</button></div>
  <pre><code><span class="kw">class</span> <span class="cls">DynamicalGNN</span>(nn.Module):
    <span class="str">"""
    ç”¨äºå­¦ä¹ åŠ¨åŠ›å­¦ç³»ç»Ÿçš„å›¾ç¥ç»ç½‘ç»œ
    
    æ¶æ„:
    1. Edge Frame: ç¼–ç ç©ºé—´å…³ç³»
    2. Node Encoder: åµŒå…¥èŠ‚ç‚¹çŠ¶æ€
    3. Message Passing: ä¼ æ’­ä¿¡æ¯ (Ã—N å±‚)
    4. Dynamics Decoder: é¢„æµ‹åŠ é€Ÿåº¦
    """</span>
    
    <span class="kw">def</span> <span class="fn">__init__</span>(
        <span class="sf">self</span>,
        node_dim: <span class="bi">int</span> = <span class="num">6</span>,              <span class="cmt"># ä½ç½®(3) + é€Ÿåº¦(3)</span>
        hidden_dim: <span class="bi">int</span> = <span class="num">128</span>,          <span class="cmt"># éšè—å±‚ç»´åº¦</span>
        edge_hidden_dim: <span class="bi">int</span> = <span class="num">64</span>,     <span class="cmt"># è¾¹ç‰¹å¾ç»´åº¦</span>
        n_message_passing: <span class="bi">int</span> = <span class="num">3</span>,    <span class="cmt"># æ¶ˆæ¯ä¼ é€’å±‚æ•°</span>
        output_dim: <span class="bi">int</span> = <span class="num">3</span>,           <span class="cmt"># åŠ é€Ÿåº¦(3)</span>
    ):
        <span class="bi">super</span>().__init__()
        
        <span class="cmt"># 1. è¾¹å¸§ â€” ç©ºé—´å…³ç³»ç¼–ç </span>
        <span class="sf">self</span>.edge_frame = EdgeFrame(hidden_dim=edge_hidden_dim)
        
        <span class="cmt"># 2. èŠ‚ç‚¹ç¼–ç å™¨</span>
        <span class="sf">self</span>.node_encoder = nn.Sequential(
            nn.Linear(node_dim, hidden_dim),
            nn.LayerNorm(hidden_dim),
            nn.ReLU(),
            nn.Linear(hidden_dim, hidden_dim),
        )
        
        <span class="cmt"># 3. æ¶ˆæ¯ä¼ é€’å±‚ (N å±‚)</span>
        <span class="sf">self</span>.mp_layers = nn.ModuleList([
            PhysicsMessagePassing(hidden_dim, edge_hidden_dim)
            <span class="kw">for</span> _ <span class="kw">in</span> <span class="bi">range</span>(n_message_passing)
        ])
        
        <span class="cmt"># 4. åŠ¨åŠ›å­¦è§£ç å™¨ â†’ åŠ é€Ÿåº¦</span>
        <span class="sf">self</span>.decoder = nn.Sequential(
            nn.Linear(hidden_dim, hidden_dim),
            nn.LayerNorm(hidden_dim),
            nn.ReLU(),
            nn.Linear(hidden_dim, hidden_dim // <span class="num">2</span>),
            nn.ReLU(),
            nn.Linear(hidden_dim // <span class="num">2</span>, output_dim),
        )
    
    <span class="kw">def</span> <span class="fn">forward</span>(<span class="sf">self</span>, positions, velocities, edge_index, masses=<span class="kw">None</span>):
        <span class="cmt"># Step 1: è¾¹å¸§ç¼–ç </span>
        edge_features = <span class="sf">self</span>.edge_frame(positions, velocities, edge_index)
        
        <span class="cmt"># Step 2: èŠ‚ç‚¹ç¼–ç </span>
        node_states = torch.cat([positions, velocities], dim=-<span class="num">1</span>)  <span class="cmt"># (N, 6)</span>
        node_features = <span class="sf">self</span>.node_encoder(node_states)            <span class="cmt"># (N, 128)</span>
        
        <span class="cmt"># Step 3: å¤šè½®æ¶ˆæ¯ä¼ é€’</span>
        x = node_features
        <span class="kw">for</span> mp_layer <span class="kw">in</span> <span class="sf">self</span>.mp_layers:
            x = mp_layer(x, edge_index, edge_features)
        
        <span class="cmt"># Step 4: é¢„æµ‹åŠ é€Ÿåº¦</span>
        accelerations = <span class="sf">self</span>.decoder(x)  <span class="cmt"># (N, 3)</span>
        
        <span class="kw">return</span> accelerations</code></pre>
</div>

<p><strong>å‚æ•°é‡ç»Ÿè®¡ï¼ˆé»˜è®¤é…ç½®ï¼‰ï¼š</strong></p>
<ul>
  <li>EdgeFrame: $8 \times 64 + 64 \times 64 \approx 4.6K$ å‚æ•°</li>
  <li>NodeEncoder: $6 \times 128 + 128 \times 128 \approx 17K$ å‚æ•°</li>
  <li>3 Ã— PhysicsMessagePassing: $3 \times (192 \times 128 + 256 \times 128) \approx 172K$ å‚æ•°</li>
  <li>Decoder: $128 \times 128 + 128 \times 64 + 64 \times 3 \approx 25K$ å‚æ•°</li>
  <li><strong>æ€»è®¡çº¦ ~220K å‚æ•°</strong> â€” éå¸¸è½»é‡!</li>
</ul>

<!-- ===== 5.4 ===== -->
<h3 id="ch5-conservation">5.4 å®ˆæ’å®šå¾‹ç¼–ç </h3>

<p>Dynami-CAL GNN å¦‚ä½•å°†ç‰©ç†å®ˆæ’å®šå¾‹èå…¥ç½‘ç»œï¼Ÿ</p>

<h4>åŠ¨é‡å®ˆæ’</h4>
<p>é€šè¿‡ <strong>åå¯¹ç§°æ¶ˆæ¯ä¼ é€’</strong> å®ç°ã€‚å½“ä½¿ç”¨ Sum èšåˆæ—¶ï¼š</p>
$$
\sum_{i} \sum_{j \in \mathcal{N}(i)} \mathbf{m}_{ji} = \sum_{(i,j) \in E} (\mathbf{m}_{ji} + \mathbf{m}_{ij})
$$
<p>å¦‚æœæ¶ˆæ¯æ˜¯åå¯¹ç§°çš„ ($\mathbf{m}_{ij} = -\mathbf{m}_{ji}$)ï¼Œåˆ™ç³»ç»Ÿæ€»åŠ›ä¸ºé›¶ â†’ åŠ¨é‡å®ˆæ’ã€‚</p>

<h4>èƒ½é‡å®ˆæ’</h4>
<p>é€šè¿‡ <strong>å®ˆæ’å®šå¾‹æŸå¤±å‡½æ•°</strong> è½¯çº¦æŸå®ç°ï¼š</p>

<div class="code-container">
  <div class="code-header"><span>Python â€” èƒ½é‡å®ˆæ’æ£€æŸ¥</span><button class="copy-btn" onclick="copyCode(this)">å¤åˆ¶</button></div>
  <pre><code><span class="kw">def</span> <span class="fn">compute_energy</span>(<span class="sf">self</span>, positions, velocities, masses):
    <span class="str">"""è®¡ç®—ç³»ç»Ÿèƒ½é‡ç”¨äºå®ˆæ’æ£€æŸ¥"""</span>
    <span class="cmt"># åŠ¨èƒ½: KE = 0.5 * m * vÂ²</span>
    kinetic = <span class="num">0.5</span> * masses.unsqueeze(-<span class="num">1</span>) * (velocities ** <span class="num">2</span>).<span class="fn">sum</span>(dim=-<span class="num">1</span>)
    kinetic_total = kinetic.<span class="fn">sum</span>()
    
    <span class="cmt"># åŠ¿èƒ½ (é‡åŠ›): PE = m * g * h</span>
    g = <span class="num">9.81</span>
    potential = masses * g * positions[:, <span class="num">2</span>]  <span class="cmt"># z æ˜¯é«˜åº¦</span>
    potential_total = potential.<span class="fn">sum</span>()
    
    total = kinetic_total + potential_total
    <span class="kw">return</span> kinetic_total, potential_total, total

<span class="kw">def</span> <span class="fn">check_conservation</span>(<span class="sf">self</span>, pos_t0, vel_t0, pos_t1, vel_t1, masses):
    <span class="str">"""æ£€æŸ¥ä¸¤ä¸ªæ—¶é—´æ­¥ä¹‹é—´çš„å®ˆæ’å¾‹"""</span>
    _, _, E_t0 = <span class="sf">self</span>.compute_energy(pos_t0, vel_t0, masses)
    _, _, E_t1 = <span class="sf">self</span>.compute_energy(pos_t1, vel_t1, masses)
    energy_error = torch.abs((E_t1 - E_t0) / (E_t0 + <span class="num">1e-8</span>))
    
    <span class="cmt"># åŠ¨é‡å®ˆæ’</span>
    p_t0 = (masses.unsqueeze(-<span class="num">1</span>) * vel_t0).<span class="fn">sum</span>(dim=<span class="num">0</span>)
    p_t1 = (masses.unsqueeze(-<span class="num">1</span>) * vel_t1).<span class="fn">sum</span>(dim=<span class="num">0</span>)
    momentum_error = torch.norm(p_t1 - p_t0) / (torch.norm(p_t0) + <span class="num">1e-8</span>)
    
    <span class="kw">return</span> {
        <span class="str">'energy_error'</span>: energy_error.item(),
        <span class="str">'momentum_error'</span>: momentum_error.item(),
    }</code></pre>
</div>

<!-- ===== 5.5 ===== -->
<h3 id="ch5-symplectic">5.5 è¾›ç§¯åˆ†å™¨ (Symplectic Integrator)</h3>

<div class="box definition">
  <div class="box-title">ğŸ“˜ è¾›ç§¯åˆ†å™¨ â€” Velocity Verlet</div>
  <p>è¾›ç§¯åˆ†å™¨æ˜¯ä¸€ç±»ä¿æŒ <strong>å“ˆå¯†é¡¿ç»“æ„</strong>ï¼ˆå³ç›¸ç©ºé—´ä½“ç§¯ï¼‰çš„æ•°å€¼ç§¯åˆ†æ–¹æ³•ã€‚ç›¸æ¯” Euler ç§¯åˆ†ï¼Œè¾›ç§¯åˆ†å™¨åœ¨ <strong>é•¿æœŸæ¨¡æ‹Ÿ</strong> ä¸­èƒ½é‡æ¼‚ç§»æ›´å°ã€‚</p>
</div>

<p>Velocity Verlet ç®—æ³•çš„æ›´æ–°æ­¥éª¤ï¼š</p>

$$
\begin{aligned}
\mathbf{v}_{n+\frac{1}{2}} &= \mathbf{v}_n + \frac{1}{2} \Delta t \cdot \mathbf{a}_n \\
\mathbf{x}_{n+1} &= \mathbf{x}_n + \Delta t \cdot \mathbf{v}_{n+\frac{1}{2}} \\
\mathbf{a}_{n+1} &= f(\mathbf{x}_{n+1}) \\
\mathbf{v}_{n+1} &= \mathbf{v}_{n+\frac{1}{2}} + \frac{1}{2} \Delta t \cdot \mathbf{a}_{n+1}
\end{aligned}
$$

<div class="code-container">
  <div class="code-header"><span>Python â€” SymplecticIntegrator (integrators.py)</span><button class="copy-btn" onclick="copyCode(this)">å¤åˆ¶</button></div>
  <pre><code><span class="kw">class</span> <span class="cls">SymplecticIntegrator</span>:
    <span class="str">"""
    è¾› (Verlet) ç§¯åˆ†å™¨
    ä¿æŒå“ˆå¯†é¡¿ç»“æ„ï¼Œé•¿æœŸæ¨¡æ‹Ÿèƒ½é‡æ¼‚ç§»å°
    """</span>
    <span class="kw">def</span> <span class="fn">__init__</span>(<span class="sf">self</span>, dt: <span class="bi">float</span> = <span class="num">0.01</span>):
        <span class="sf">self</span>.dt = dt
    
    <span class="kw">def</span> <span class="fn">step</span>(<span class="sf">self</span>, positions, velocities, acceleration_fn):
        <span class="str">"""
        æ‰§è¡Œä¸€æ­¥ç§¯åˆ†
        acceleration_fn: (pos, vel) â†’ accel çš„å‡½æ•°
        """</span>
        <span class="cmt"># å½“å‰åŠ é€Ÿåº¦</span>
        accel_n = acceleration_fn(positions, velocities)
        
        <span class="cmt"># åŠæ­¥é€Ÿåº¦æ›´æ–°</span>
        v_half = velocities + <span class="num">0.5</span> * <span class="sf">self</span>.dt * accel_n
        
        <span class="cmt"># ä½ç½®æ›´æ–°</span>
        x_new = positions + <span class="sf">self</span>.dt * v_half
        
        <span class="cmt"># æ–°ä½ç½®å¤„çš„åŠ é€Ÿåº¦</span>
        accel_n1 = acceleration_fn(x_new, v_half)
        
        <span class="cmt"># å®Œæ•´é€Ÿåº¦æ›´æ–°</span>
        v_new = v_half + <span class="num">0.5</span> * <span class="sf">self</span>.dt * accel_n1
        
        <span class="kw">return</span> x_new, v_new</code></pre>
</div>

<div class="compare-grid">
  <div class="compare-card">
    <h4>Euler ç§¯åˆ†</h4>
    <p>$\mathbf{v}_{n+1} = \mathbf{v}_n + \Delta t \cdot \mathbf{a}_n$</p>
    <p>$\mathbf{x}_{n+1} = \mathbf{x}_n + \Delta t \cdot \mathbf{v}_{n+1}$</p>
    <p>âš ï¸ 1 é˜¶ç²¾åº¦ï¼Œèƒ½é‡æŒç»­æ¼‚ç§»</p>
    <p>âš ï¸ é•¿æœŸæ¨¡æ‹Ÿä¸ç¨³å®š</p>
  </div>
  <div class="compare-card">
    <h4>Velocity Verlet (è¾›ç§¯åˆ†)</h4>
    <p>åŠæ­¥é€Ÿåº¦ â†’ ä½ç½® â†’ æ–°åŠ é€Ÿåº¦ â†’ å…¨æ­¥é€Ÿåº¦</p>
    <p>âœ… 2 é˜¶ç²¾åº¦ï¼Œèƒ½é‡æŒ¯è¡ä½†ä¸æ¼‚ç§»</p>
    <p>âœ… é€‚åˆé•¿æœŸä¿å®ˆç³»ç»Ÿæ¨¡æ‹Ÿ</p>
    <p>âœ… æ—¶é—´å¯é€†</p>
  </div>
</div>

<!-- ===== 5.6 ===== -->
<h3 id="ch5-force">5.6 åŠ›é¢„æµ‹ vs åŠ é€Ÿåº¦é¢„æµ‹</h3>

<table>
  <thead>
    <tr><th>é¢„æµ‹ç›®æ ‡</th><th>ä¼˜ç‚¹</th><th>ç¼ºç‚¹</th></tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>åŠ› $\mathbf{F}_i$</strong></td>
      <td>å¯ä»¥ç›´æ¥æ£€æŸ¥ç‰›é¡¿ç¬¬ä¸‰å®šå¾‹ï¼›å¯ä»¥åˆ†è§£ä¸ºå„åˆ†åŠ›</td>
      <td>éœ€è¦è´¨é‡ä¿¡æ¯æ¥è½¬æ¢ä¸ºåŠ é€Ÿåº¦</td>
    </tr>
    <tr>
      <td><strong>åŠ é€Ÿåº¦ $\ddot{\mathbf{x}}_i$</strong></td>
      <td>ç›´æ¥ç”¨äºç§¯åˆ†å™¨ï¼›ä¸éœ€è¦è´¨é‡</td>
      <td>éš¾ä»¥ç›´æ¥æ£€æŸ¥å®ˆæ’å¾‹</td>
    </tr>
    <tr>
      <td><strong>é€Ÿåº¦å˜åŒ– $\Delta \mathbf{v}$</strong></td>
      <td>ç›´æ¥æ›´æ–°é€Ÿåº¦ï¼Œç®€å•</td>
      <td>ä¾èµ–æ—¶é—´æ­¥é•¿</td>
    </tr>
    <tr>
      <td><strong>ä½ç½®å˜åŒ– $\Delta \mathbf{x}$</strong></td>
      <td>æœ€ç®€å•ç›´æ¥</td>
      <td>ç‰©ç†æ„ä¹‰ä¸æ˜ç¡®ï¼Œéš¾æ³›åŒ–</td>
    </tr>
  </tbody>
</table>

<div class="box theorem">
  <div class="box-title">ğŸ“— æˆ‘ä»¬çš„é€‰æ‹©ï¼šåŠ é€Ÿåº¦</div>
  <p>åœ¨ DynamicalGNN ä¸­ï¼Œæˆ‘ä»¬é€‰æ‹©é¢„æµ‹ <strong>åŠ é€Ÿåº¦</strong> $\ddot{\mathbf{x}}_i \in \mathbb{R}^3$ï¼ŒåŸå› æ˜¯ï¼š</p>
  <ol>
    <li>åŠ é€Ÿåº¦ä¸æ—¶é—´æ­¥é•¿æ— å…³ï¼ˆåŠ›å’ŒåŠ é€Ÿåº¦çš„å…³ç³» $\mathbf{a} = \mathbf{F}/m$ æ˜¯ç¬æ—¶çš„ï¼‰</li>
    <li>å¯ä»¥æ­é…ä»»æ„ç§¯åˆ†å™¨ï¼ˆEuler / Verlet / RK4ï¼‰</li>
    <li>è´¨é‡å¯ä»¥è¢«ç½‘ç»œéšå¼å­¦ä¹ ï¼ˆä¸éœ€è¦æ˜¾å¼æä¾›ï¼‰</li>
  </ol>
</div>


<!-- ================================================================ -->
<!-- ç¬¬å…­ç«  -->
<!-- ================================================================ -->
<h2 id="ch6">ç¬¬å…­ç« ï¼šGNS åœ¨ PushBox ä¸­çš„åº”ç”¨</h2>

<h3 id="ch6-build">6.1 å›¾æ„å»ºè¿‡ç¨‹</h3>

<p>ä» PushBox ç¯å¢ƒçš„ 16 ç»´è§‚æµ‹å‘é‡æ„å»ºå›¾çš„å®Œæ•´è¿‡ç¨‹ï¼š</p>

<div class="code-container">
  <div class="code-header"><span>Python â€” PushBox è§‚æµ‹ç©ºé—´ (push_box_env.py)</span><button class="copy-btn" onclick="copyCode(this)">å¤åˆ¶</button></div>
  <pre><code><span class="kw">def</span> <span class="fn">_get_obs</span>(<span class="sf">self</span>):
    <span class="str">"""è·å– 16 ç»´è§‚æµ‹å‘é‡"""</span>
    joint_pos = <span class="sf">self</span>.data.qpos[:<span class="num">2</span>].copy()   <span class="cmt"># 2D: å…³èŠ‚è§’åº¦</span>
    joint_vel = <span class="sf">self</span>.data.qvel[:<span class="num">2</span>].copy()   <span class="cmt"># 2D: å…³èŠ‚é€Ÿåº¦</span>
    ee_pos = <span class="sf">self</span>.data.site_xpos[<span class="sf">self</span>._ee_site_id].copy()  <span class="cmt"># 3D</span>
    box_pos = <span class="sf">self</span>.data.qpos[<span class="num">2</span>:<span class="num">5</span>].copy()    <span class="cmt"># 3D: ç›’å­ä½ç½®</span>
    box_vel = <span class="sf">self</span>.data.qvel[<span class="num">2</span>:<span class="num">5</span>].copy()    <span class="cmt"># 3D: ç›’å­é€Ÿåº¦</span>
    goal_pos = <span class="sf">self</span>.goal_pos.copy()           <span class="cmt"># 3D: ç›®æ ‡ä½ç½®</span>
    
    obs = np.concatenate([
        joint_pos,    <span class="cmt"># [0:2]   â€” å…³èŠ‚è§’åº¦</span>
        joint_vel,    <span class="cmt"># [2:4]   â€” å…³èŠ‚é€Ÿåº¦</span>
        ee_pos,       <span class="cmt"># [4:7]   â€” æœ«ç«¯æ‰§è¡Œå™¨ä½ç½®</span>
        box_pos,      <span class="cmt"># [7:10]  â€” ç›’å­ä½ç½®</span>
        box_vel,      <span class="cmt"># [10:13] â€” ç›’å­é€Ÿåº¦</span>
        goal_pos      <span class="cmt"># [13:16] â€” ç›®æ ‡ä½ç½®</span>
    ])
    <span class="kw">return</span> obs.astype(np.float32)</code></pre>
</div>

<p>å›¾æ„å»ºçš„æ˜ å°„å…³ç³»ï¼š</p>
<div class="flow-diagram">
  <div class="flow-box">ğŸ“‹ obs[16]<br><small>æ‰å¹³è§‚æµ‹å‘é‡</small></div>
  <span class="flow-arrow">â†’</span>
  <div class="flow-box">ğŸ”€ æ‹†åˆ†æå–<br><small>ee_pos, box_pos, box_vel</small></div>
  <span class="flow-arrow">â†’</span>
  <div class="flow-box">ğŸ“Š Graph(x, edge_index, edge_attr)<br><small>2 èŠ‚ç‚¹ã€2 è¾¹çš„ PyG å›¾</small></div>
</div>

<!-- ===== 6.2 ===== -->
<h3 id="ch6-gns">6.2 GNSFeaturesExtractor</h3>

<p>è¿™æ˜¯å°† GNS é›†æˆåˆ° PPO æ¡†æ¶çš„å…³é”®ç»„ä»¶ã€‚å®ƒä½œä¸º Stable-Baselines3 çš„ <strong>è‡ªå®šä¹‰ç‰¹å¾æå–å™¨</strong>ï¼Œå°†åŸå§‹è§‚æµ‹è½¬æ¢ä¸ºç‰©ç†æ„ŸçŸ¥çš„ç‰¹å¾å‘é‡ã€‚</p>

<div class="code-container">
  <div class="code-header"><span>Python â€” GNSFeaturesExtractor (gns_baseline.py)</span><button class="copy-btn" onclick="copyCode(this)">å¤åˆ¶</button></div>
  <pre><code><span class="kw">class</span> <span class="cls">GNSFeaturesExtractor</span>(BaseFeaturesExtractor):
    <span class="str">"""
    å°† GNS é›†æˆåˆ° PPO çš„ç‰¹å¾æå–å™¨
    è§‚æµ‹ â†’ å›¾ â†’ GNS ç‰©ç†é¢„æµ‹ â†’ ç‰¹å¾å‘é‡
    """</span>
    
    <span class="kw">def</span> <span class="fn">__init__</span>(<span class="sf">self</span>, observation_space, features_dim=<span class="num">128</span>):
        <span class="bi">super</span>().__init__(observation_space, features_dim)
        
        <span class="cmt"># GNS ç½‘ç»œç”¨äºç‰©ç†é¢„æµ‹</span>
        <span class="sf">self</span>.gns = GNSNetwork(
            node_feature_dim=<span class="num">6</span>,     <span class="cmt"># pos(3) + vel(3)</span>
            edge_feature_dim=<span class="num">4</span>,     <span class="cmt"># rel_pos(3) + dist(1)</span>
            hidden_dim=<span class="num">128</span>,
            n_layers=<span class="num">3</span>
        )
        
        <span class="cmt"># èåˆ: GNSç‰©ç†ç‰¹å¾ + åŸå§‹è§‚æµ‹</span>
        <span class="sf">self</span>.feature_proj = nn.Sequential(
            nn.Linear(<span class="num">128</span> + <span class="num">16</span>, features_dim),
            nn.ReLU()
        )
    
    <span class="kw">def</span> <span class="fn">_obs_to_graph</span>(<span class="sf">self</span>, obs):
        <span class="str">"""å°†æ‰¹é‡è§‚æµ‹è½¬ä¸º PyG æ‰¹é‡å›¾"""</span>
        batch_size = obs.shape[<span class="num">0</span>]
        graphs = []
        
        <span class="kw">for</span> i <span class="kw">in</span> <span class="bi">range</span>(batch_size):
            o = obs[i]
            
            <span class="cmt"># èŠ‚ç‚¹: [æœ«ç«¯æ‰§è¡Œå™¨, ç›’å­]</span>
            ee_pos = o[<span class="num">4</span>:<span class="num">7</span>]
            ee_vel = torch.zeros(<span class="num">3</span>, device=obs.device)
            box_pos = o[<span class="num">7</span>:<span class="num">10</span>]
            box_vel = o[<span class="num">10</span>:<span class="num">13</span>]
            
            <span class="cmt"># èŠ‚ç‚¹ç‰¹å¾: [pos(3), vel(3)]</span>
            node_features = torch.stack([
                torch.cat([ee_pos, ee_vel]),
                torch.cat([box_pos, box_vel])
            ])
            
            <span class="cmt"># å•å‘è¾¹: æœ«ç«¯æ‰§è¡Œå™¨ â†’ ç›’å­</span>
            edge_index = torch.tensor([[<span class="num">0</span>], [<span class="num">1</span>]],
                dtype=torch.long, device=obs.device)
            
            <span class="cmt"># è¾¹ç‰¹å¾: ç›¸å¯¹ä½ç½® + è·ç¦»</span>
            rel_pos = box_pos - ee_pos
            distance = torch.norm(rel_pos).unsqueeze(<span class="num">0</span>)
            edge_attr = torch.cat([rel_pos, distance]).unsqueeze(<span class="num">0</span>)
            
            graph = Data(x=node_features,
                        edge_index=edge_index, edge_attr=edge_attr)
            graphs.append(graph)
        
        <span class="kw">return</span> Batch.from_data_list(graphs)
    
    <span class="kw">def</span> <span class="fn">forward</span>(<span class="sf">self</span>, observations):
        <span class="str">"""è§‚æµ‹ â†’ GNS â†’ ç‰¹å¾å‘é‡"""</span>
        graph = <span class="sf">self</span>._obs_to_graph(observations)
        acc_pred = <span class="sf">self</span>.gns(graph)
        
        <span class="cmt"># æå–ç›’å­èŠ‚ç‚¹çš„é¢„æµ‹ (æ¯2ä¸ªèŠ‚ç‚¹å–ç¬¬2ä¸ª)</span>
        physics_features = acc_pred[<span class="num">1</span>::<span class="num">2</span>]
        
        <span class="cmt"># æ‹¼æ¥ç‰©ç†é¢„æµ‹ + åŸå§‹è§‚æµ‹</span>
        combined = torch.cat([
            physics_features.view(observations.shape[<span class="num">0</span>], -<span class="num">1</span>),
            observations
        ], dim=-<span class="num">1</span>)
        
        <span class="kw">return</span> <span class="sf">self</span>.feature_proj(combined)</code></pre>
</div>

<div class="box example">
  <div class="box-title">ğŸ’¡ æ•°æ®æµ</div>
  <p>ä¸€ä¸ª batch çš„æ•°æ®æµå¦‚ä¸‹ï¼ˆbatch_size=64ï¼‰ï¼š</p>
  <ol>
    <li><code>observations</code>: <code>[64, 16]</code> â€” 64 ä¸ªè§‚æµ‹</li>
    <li><code>_obs_to_graph()</code>: æ„å»º 64 ä¸ªç‹¬ç«‹çš„ 2-èŠ‚ç‚¹å›¾ â†’ <code>Batch(x=[128, 6], ...)</code></li>
    <li><code>gns(graph)</code>: å¯¹ 128 ä¸ªèŠ‚ç‚¹åšæ¶ˆæ¯ä¼ é€’ â†’ <code>acc_pred [128, 3]</code></li>
    <li>å–ç›’å­èŠ‚ç‚¹: <code>acc_pred[1::2]</code> â†’ <code>[64, 3]</code> â€” æ¯ä¸ªæ ·æœ¬çš„ç›’å­åŠ é€Ÿåº¦é¢„æµ‹</li>
    <li>æ‹¼æ¥: <code>[64, 3] cat [64, 16]</code> â†’ <code>[64, 19]</code></li>
    <li>æŠ•å½±: <code>feature_proj([64, 19])</code> â†’ <code>[64, 128]</code> â€” PPO çš„è¾“å…¥ç‰¹å¾</li>
  </ol>
</div>

<!-- ===== 6.3 ===== -->
<h3 id="ch6-phys">6.3 PhysRobotFeaturesExtractor â€” ç‰©ç†çº¦æŸç‰ˆæœ¬</h3>

<p>ä¸ GNSFeaturesExtractor ç›¸æ¯”ï¼ŒPhysRobot ç‰ˆæœ¬å¢åŠ äº† <strong>Dynami-CAL ç‰©ç†çº¦æŸ</strong> å’Œ <strong>åŒæµèåˆ</strong>ï¼š</p>

<div class="code-container">
  <div class="code-header"><span>Python â€” PhysRobotFeaturesExtractor (physics_informed.py)</span><button class="copy-btn" onclick="copyCode(this)">å¤åˆ¶</button></div>
  <pre><code><span class="kw">class</span> <span class="cls">PhysRobotFeaturesExtractor</span>(BaseFeaturesExtractor):
    <span class="str">"""
    åŒæµç‰¹å¾æå–å™¨:
    - ç­–ç•¥æµ (Policy Stream): "è¯¥åšä»€ä¹ˆ" â€” æ ‡å‡† MLP
    - ç‰©ç†æµ (Physics Stream): "ç‰©ç†ä¸Šä»€ä¹ˆå¯èƒ½" â€” Dynami-CAL
    - èåˆ: åˆå¹¶ä¸¤è€…
    """</span>
    
    <span class="kw">def</span> <span class="fn">__init__</span>(<span class="sf">self</span>, observation_space, features_dim=<span class="num">128</span>):
        <span class="bi">super</span>().__init__(observation_space, features_dim)
        
        <span class="cmt"># ç‰©ç†æµ: Dynami-CAL ç‰©ç†æ ¸å¿ƒ</span>
        <span class="sf">self</span>.physics_core = PhysicsCore(
            node_feature_dim=<span class="num">6</span>, hidden_dim=<span class="num">128</span>, n_message_passing=<span class="num">3</span>
        )
        
        <span class="cmt"># ç­–ç•¥æµ: æ ‡å‡† MLP</span>
        <span class="sf">self</span>.policy_stream = nn.Sequential(
            nn.Linear(observation_space.shape[<span class="num">0</span>], <span class="num">128</span>),
            nn.ReLU(),
            nn.Linear(<span class="num">128</span>, <span class="num">128</span>),
            nn.ReLU(),
            nn.Linear(<span class="num">128</span>, features_dim)
        )
        
        <span class="cmt"># èåˆ: ç­–ç•¥ç‰¹å¾(128) + ç‰©ç†é¢„æµ‹(3) â†’ æœ€ç»ˆç‰¹å¾(128)</span>
        <span class="sf">self</span>.fusion = nn.Sequential(
            nn.Linear(features_dim + <span class="num">3</span>, features_dim),
            nn.ReLU()
        )
    
    <span class="kw">def</span> <span class="fn">_obs_to_graph</span>(<span class="sf">self</span>, obs):
        <span class="str">"""è§‚æµ‹ â†’ å›¾ (å¸¦ä½ç½®ä¿¡æ¯)"""</span>
        batch_size = obs.shape[<span class="num">0</span>]
        graphs = []
        <span class="kw">for</span> i <span class="kw">in</span> <span class="bi">range</span>(batch_size):
            o = obs[i]
            ee_pos = o[<span class="num">4</span>:<span class="num">7</span>]
            box_pos = o[<span class="num">7</span>:<span class="num">10</span>]
            box_vel = o[<span class="num">10</span>:<span class="num">13</span>]
            
            positions = torch.stack([ee_pos, box_pos])
            node_features = torch.stack([
                torch.cat([torch.zeros(<span class="num">3</span>, device=obs.device), ee_pos]),
                torch.cat([box_vel, box_pos])
            ])
            
            <span class="cmt"># åŒå‘è¾¹ï¼</span>
            edge_index = torch.tensor(
                [[<span class="num">0</span>, <span class="num">1</span>], [<span class="num">1</span>, <span class="num">0</span>]], dtype=torch.long, device=obs.device
            ).t()
            
            graph = Data(x=node_features, pos=positions,
                        edge_index=edge_index)
            graphs.append(graph)
        <span class="kw">return</span> Batch.from_data_list(graphs)
    
    <span class="kw">def</span> <span class="fn">forward</span>(<span class="sf">self</span>, observations):
        <span class="str">"""åŒæµå¤„ç† â†’ èåˆ"""</span>
        <span class="cmt"># 1. ç­–ç•¥æµ: å­¦ä¹  "è¯¥åšä»€ä¹ˆ"</span>
        policy_features = <span class="sf">self</span>.policy_stream(observations)
        
        <span class="cmt"># 2. ç‰©ç†æµ: é¢„æµ‹ "ç‰©ç†ä¸Šä»€ä¹ˆä¼šå‘ç”Ÿ"</span>
        graph = <span class="sf">self</span>._obs_to_graph(observations)
        physics_pred = <span class="sf">self</span>.physics_core(graph)
        box_physics = physics_pred[<span class="num">1</span>::<span class="num">2</span>]  <span class="cmt"># ç›’å­é¢„æµ‹</span>
        
        <span class="cmt"># 3. èåˆ</span>
        combined = torch.cat([policy_features, box_physics], dim=-<span class="num">1</span>)
        features = <span class="sf">self</span>.fusion(combined)
        <span class="kw">return</span> features</code></pre>
</div>

<div class="box theorem">
  <div class="box-title">ğŸ“— åŒæµæ¶æ„çš„ä¼˜åŠ¿</div>
  <p><strong>ç­–ç•¥æµ</strong>ï¼ˆMLPï¼‰å¯ä»¥çµæ´»å­¦ä¹ ä»»æ„ç­–ç•¥ç‰¹å¾ï¼Œä¸å—ç‰©ç†çº¦æŸé™åˆ¶ã€‚<br>
  <strong>ç‰©ç†æµ</strong>ï¼ˆDynami-CALï¼‰ä¿è¯é¢„æµ‹ç¬¦åˆç‰©ç†å®šå¾‹ï¼Œæä¾›å¯é çš„åŠ¨åŠ›å­¦ä¿¡æ¯ã€‚<br>
  <strong>èåˆæ¨¡å—</strong> è®© PPO è‡ªåŠ¨å­¦ä¹ å¦‚ä½•æƒè¡¡ä¸¤è€…â€”â€”å½“ç‰©ç†é¢„æµ‹å¯é æ—¶ä¾èµ–ç‰©ç†æµï¼Œå½“éœ€è¦éç‰©ç†çš„å†³ç­–ï¼ˆå¦‚é€‰æ‹©ç›®æ ‡ï¼‰æ—¶ä¾èµ–ç­–ç•¥æµã€‚</p>
</div>

<!-- ===== 6.4 ===== -->
<h3 id="ch6-train">6.4 è®­ç»ƒæµç¨‹</h3>

<p>GNS + PPO çš„å®Œæ•´è®­ç»ƒå¾ªç¯ï¼š</p>

<div class="code-container">
  <div class="code-header"><span>Python â€” è®­ç»ƒè„šæœ¬ (train.py æ‘˜å½•)</span><button class="copy-btn" onclick="copyCode(this)">å¤åˆ¶</button></div>
  <pre><code><span class="kw">from</span> stable_baselines3 <span class="kw">import</span> PPO
<span class="kw">from</span> stable_baselines3.common.vec_env <span class="kw">import</span> DummyVecEnv
<span class="kw">from</span> environments.push_box_env <span class="kw">import</span> make_push_box_env
<span class="kw">from</span> baselines.gns_baseline <span class="kw">import</span> GNSFeaturesExtractor

<span class="cmt"># 1. åˆ›å»ºå¹¶è¡Œç¯å¢ƒ</span>
n_envs = <span class="num">4</span>
env = DummyVecEnv([make_push_box_env(box_mass=<span class="num">1.0</span>) <span class="kw">for</span> _ <span class="kw">in</span> <span class="bi">range</span>(n_envs)])

<span class="cmt"># 2. é…ç½® PPO + GNS ç‰¹å¾æå–å™¨</span>
policy_kwargs = <span class="bi">dict</span>(
    features_extractor_class=GNSFeaturesExtractor,
    features_extractor_kwargs=<span class="bi">dict</span>(features_dim=<span class="num">128</span>),
)

model = PPO(
    <span class="str">"MlpPolicy"</span>,
    env,
    learning_rate=<span class="num">3e-4</span>,
    n_steps=<span class="num">2048</span>,
    batch_size=<span class="num">64</span>,
    n_epochs=<span class="num">10</span>,
    gamma=<span class="num">0.99</span>,
    policy_kwargs=policy_kwargs,
    verbose=<span class="num">1</span>,
)

<span class="cmt"># 3. è®­ç»ƒï¼</span>
model.learn(total_timesteps=<span class="num">80_000</span>)  <span class="cmt"># GNS åªéœ€ 80K æ­¥</span>

<span class="cmt"># 4. ä¿å­˜æ¨¡å‹</span>
model.save(<span class="str">"models/gns_pushbox"</span>)</code></pre>
</div>

<div class="box warning">
  <div class="box-title">âš ï¸ å…³é”®ç»†èŠ‚</div>
  <p>GNS ç‰¹å¾æå–å™¨æ˜¯ <strong>ç«¯åˆ°ç«¯</strong> å’Œ PPO ä¸€èµ·è®­ç»ƒçš„ï¼GNS çš„å‚æ•°é€šè¿‡ PPO çš„ç­–ç•¥æ¢¯åº¦åŒæ—¶æ›´æ–°ã€‚è¿™æ„å‘³ç€ GNS ä¸éœ€è¦å•ç‹¬çš„ç›‘ç£æ•°æ®â€”â€”å®ƒé€šè¿‡å¼ºåŒ–å­¦ä¹ çš„ä¿¡å·è‡ªåŠ¨å­¦ä¹ æœ‰ç”¨çš„ç‰©ç†è¡¨ç¤ºã€‚</p>
</div>

<!-- ===== 6.5 ===== -->
<h3 id="ch6-compare">6.5 ä¸çº¯ PPO çš„å¯¹æ¯”</h3>

<table>
  <thead>
    <tr><th>æ–¹æ³•</th><th>è®­ç»ƒæ­¥æ•°</th><th>é¦–æ¬¡æˆåŠŸ (episodes)</th><th>æ ·æœ¬æ•ˆç‡æå‡</th></tr>
  </thead>
  <tbody>
    <tr><td>çº¯ PPO</td><td>200,000</td><td>~2000</td><td>1Ã— (åŸºå‡†)</td></tr>
    <tr><td>GNS + PPO</td><td>80,000</td><td>~800</td><td>~2.5Ã—</td></tr>
    <tr><td>PhysRobot (Ours)</td><td>16,000</td><td>~160</td><td>~12.5Ã—</td></tr>
  </tbody>
</table>

<div class="box theorem">
  <div class="box-title">ğŸ“— ä¸ºä»€ä¹ˆ GNS æ›´æ ·æœ¬é«˜æ•ˆï¼Ÿ</div>
  <ol>
    <li><strong>å½’çº³åç½®</strong>ï¼šå›¾ç»“æ„ç¼–ç äº† "ç‰©ä½“é€šè¿‡äº¤äº’å½±å“å½¼æ­¤" çš„å…ˆéªŒçŸ¥è¯†ï¼ŒMLP éœ€è¦ä»é›¶å­¦èµ·</li>
    <li><strong>å‚æ•°å…±äº«</strong>ï¼šåŒä¸€ä¸ªæ¶ˆæ¯å‡½æ•°ä½œç”¨äºæ‰€æœ‰è¾¹ â†’ æ›´å°‘å‚æ•° â†’ æ›´å°‘æ•°æ®</li>
    <li><strong>ç½®æ¢ç­‰å˜æ€§</strong>ï¼šäº¤æ¢ç‰©ä½“é¡ºåºä¸å½±å“é¢„æµ‹ â†’ è‡ªåŠ¨æ•°æ®å¢å¼ºæ•ˆæœ</li>
    <li><strong>ç‰©ç†çº¦æŸï¼ˆPhysRobotï¼‰</strong>ï¼šå®ˆæ’å¾‹æ’é™¤äº†å¤§é‡éç‰©ç†è§£ â†’ æœç´¢ç©ºé—´æ›´å°</li>
  </ol>
</div>


<!-- ================================================================ -->
<!-- ç¬¬ä¸ƒç«  -->
<!-- ================================================================ -->
<h2 id="ch7">ç¬¬ä¸ƒç« ï¼šé«˜çº§ä¸»é¢˜</h2>

<h3 id="ch7-multi">7.1 å¤šä½“ç³»ç»Ÿ</h3>

<p>PushBox åªæœ‰ 2 ä¸ªèŠ‚ç‚¹ã€‚æ‰©å±•åˆ°å¤šä½“ç³»ç»Ÿåªéœ€è¦å¢åŠ èŠ‚ç‚¹å’Œè¾¹ï¼š</p>

<div class="code-container">
  <div class="code-header"><span>Python â€” å¤šç‰©ä½“å›¾æ„å»º</span><button class="copy-btn" onclick="copyCode(this)">å¤åˆ¶</button></div>
  <pre><code><span class="kw">def</span> <span class="fn">build_multi_object_graph</span>(robot_joints, objects):
    <span class="str">"""
    å¤šå…³èŠ‚æœºå™¨äºº + å¤šç‰©ä½“åœºæ™¯
    robot_joints: list of (pos, vel) for each joint
    objects: list of (pos, vel, mass) for each object
    """</span>
    nodes = []
    
    <span class="cmt"># æœºå™¨äººå…³èŠ‚èŠ‚ç‚¹</span>
    <span class="kw">for</span> pos, vel <span class="kw">in</span> robot_joints:
        nodes.append(torch.cat([pos, vel, torch.tensor([<span class="num">0</span>])]))  <span class="cmt"># type=0: joint</span>
    
    <span class="cmt"># ç‰©ä½“èŠ‚ç‚¹</span>
    <span class="kw">for</span> pos, vel, mass <span class="kw">in</span> objects:
        nodes.append(torch.cat([pos, vel, torch.tensor([<span class="num">1</span>])]))  <span class="cmt"># type=1: object</span>
    
    N = <span class="bi">len</span>(nodes)
    x = torch.stack(nodes)
    
    <span class="cmt"># å…¨è¿æ¥å›¾ (æˆ–åŸºäºè·ç¦»é˜ˆå€¼)</span>
    sources, targets = [], []
    <span class="kw">for</span> i <span class="kw">in</span> <span class="bi">range</span>(N):
        <span class="kw">for</span> j <span class="kw">in</span> <span class="bi">range</span>(N):
            <span class="kw">if</span> i != j:
                sources.append(i)
                targets.append(j)
    
    edge_index = torch.tensor([sources, targets], dtype=torch.long)
    <span class="kw">return</span> Data(x=x, edge_index=edge_index)</code></pre>
</div>

<div class="box example">
  <div class="box-title">ğŸ’¡ ä¾‹å­ï¼š7-DOF æœºæ¢°è‡‚æ¨ 3 ä¸ªç›’å­</div>
  <p>èŠ‚ç‚¹ï¼š7ï¼ˆå…³èŠ‚ï¼‰+ 3ï¼ˆç›’å­ï¼‰= 10 ä¸ªèŠ‚ç‚¹<br>
  è¾¹ï¼š$10 \times 9 = 90$ æ¡è¾¹ï¼ˆå…¨è¿æ¥ï¼‰æˆ–æŒ‰è·ç¦»é˜ˆå€¼ç­›é€‰<br>
  <strong>GNS çš„å‚æ•°é‡å®Œå…¨ä¸å˜</strong>â€”â€”å› ä¸ºæ¶ˆæ¯å‡½æ•°æ˜¯å…±äº«çš„ï¼åªæ˜¯è®¡ç®—é‡éšè¾¹æ•°å¢åŠ ã€‚</p>
</div>

<!-- ===== 7.2 ===== -->
<h3 id="ch7-dynamic">7.2 åŠ¨æ€å›¾</h3>

<p>åœ¨è®¸å¤šç‰©ç†åœºæ™¯ä¸­ï¼Œäº¤äº’å…³ç³»ä¼šéšæ—¶é—´å˜åŒ–ï¼š</p>
<ul>
  <li><strong>æ¥è§¦/åˆ†ç¦»</strong>ï¼šä¸¤ä¸ªç‰©ä½“ç¢°æ’æ—¶äº§ç”Ÿè¾¹ï¼Œåˆ†ç¦»åè¾¹æ¶ˆå¤±</li>
  <li><strong>è·ç¦»é˜ˆå€¼</strong>ï¼šåªåœ¨è·ç¦» $d_{ij} < r$ æ—¶æ·»åŠ è¾¹</li>
  <li><strong>æ‹“æ‰‘å˜åŒ–</strong>ï¼šç»³ç´¢æ–­è£‚ã€ç‰©ä½“ç ´ç¢</li>
</ul>

<div class="code-container">
  <div class="code-header"><span>Python â€” åŸºäºè·ç¦»çš„åŠ¨æ€è¾¹</span><button class="copy-btn" onclick="copyCode(this)">å¤åˆ¶</button></div>
  <pre><code><span class="kw">def</span> <span class="fn">radius_graph</span>(positions, radius=<span class="num">0.5</span>):
    <span class="str">"""æ ¹æ®è·ç¦»é˜ˆå€¼åŠ¨æ€æ„å»ºè¾¹"""</span>
    N = positions.shape[<span class="num">0</span>]
    sources, targets = [], []
    <span class="kw">for</span> i <span class="kw">in</span> <span class="bi">range</span>(N):
        <span class="kw">for</span> j <span class="kw">in</span> <span class="bi">range</span>(N):
            <span class="kw">if</span> i != j:
                dist = torch.norm(positions[i] - positions[j])
                <span class="kw">if</span> dist < radius:
                    sources.append(i)
                    targets.append(j)
    <span class="kw">return</span> torch.tensor([sources, targets], dtype=torch.long)

<span class="cmt"># PyG æä¾›äº†é«˜æ•ˆçš„å®ç°:</span>
<span class="kw">from</span> torch_geometric.nn <span class="kw">import</span> radius_graph
edge_index = radius_graph(positions, r=<span class="num">0.5</span>)</code></pre>
</div>

<!-- ===== 7.3 ===== -->
<h3 id="ch7-hier">7.3 å±‚æ¬¡åŒ–å›¾</h3>

<p>å¯¹äºå¤æ‚ç³»ç»Ÿï¼Œå¯ä»¥ä½¿ç”¨å¤šå°ºåº¦/å±‚æ¬¡åŒ–å›¾ï¼š</p>
<ul>
  <li><strong>ç»†ç²’åº¦</strong>ï¼šæ¯ä¸ªç²’å­ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆè¯¦ç»†ä½†è®¡ç®—é‡å¤§ï¼‰</li>
  <li><strong>ç²—ç²’åº¦</strong>ï¼šä¸€ç»„ç²’å­èšåˆä¸ºä¸€ä¸ª "è¶…çº§èŠ‚ç‚¹"ï¼ˆå¿«é€Ÿä½†ä¸¢å¤±ç»†èŠ‚ï¼‰</li>
  <li><strong>å±‚æ¬¡åŒ–</strong>ï¼šä¸¤å±‚éƒ½æœ‰ï¼Œé€šè¿‡æ± åŒ–æ“ä½œè¿æ¥</li>
</ul>

<div class="flow-diagram">
  <div class="flow-box">ç»†ç²’åº¦å›¾<br><small>100 ä¸ªç²’å­èŠ‚ç‚¹</small></div>
  <span class="flow-arrow">â†• æ± åŒ–/åæ± åŒ–</span>
  <div class="flow-box">ç²—ç²’åº¦å›¾<br><small>10 ä¸ªè¶…çº§èŠ‚ç‚¹</small></div>
</div>

<!-- ===== 7.4 ===== -->
<h3 id="ch7-attn">7.4 æ³¨æ„åŠ› + GNN</h3>

<p>å°†æ³¨æ„åŠ›æœºåˆ¶å¼•å…¥ GNS çš„æ¶ˆæ¯ä¼ é€’ï¼Œè®©ç½‘ç»œå­¦ä¹ è¾¹çš„é‡è¦æ€§ï¼š</p>

$$
\alpha_{ij} = \text{softmax}_j\left(\frac{\mathbf{q}_i^T \mathbf{k}_j}{\sqrt{d}}\right), \quad
\mathbf{m}_i = \sum_{j \in \mathcal{N}(i)} \alpha_{ij} \mathbf{v}_j
$$

<p>åœ¨ç‰©ç†æ¨¡æ‹Ÿä¸­ï¼Œæ³¨æ„åŠ›å¯ä»¥å­¦ä¹ åˆ°ï¼šè·ç¦»è¿‘çš„ç²’å­æƒé‡é«˜ï¼Œè¿œçš„æƒé‡ä½â€”â€”è¿™ä¸ç‰©ç†åŠ›çš„è¡°å‡ä¸€è‡´ã€‚</p>

<!-- ===== 7.5 ===== -->
<h3 id="ch7-limit">7.5 GNN çš„å±€é™æ€§</h3>

<div class="box warning">
  <div class="box-title">âš ï¸ å·²çŸ¥é—®é¢˜</div>
  <ul>
    <li><strong>è¿‡å¹³æ»‘ (Over-Smoothing)</strong>ï¼šå±‚æ•°å¤ªå¤šæ—¶ï¼Œæ‰€æœ‰èŠ‚ç‚¹ç‰¹å¾è¶‹åŒã€‚è§£å†³æ–¹æ¡ˆï¼šæ®‹å·®è¿æ¥ã€Jumping Knowledgeã€DropEdge</li>
    <li><strong>è¿‡å‹ç¼© (Over-Squashing)</strong>ï¼šè¿œè·ç¦»ä¿¡æ¯éœ€ç»è¿‡å¤šæ¬¡èšåˆï¼Œä¿¡æ¯è¢« "å‹ç¼©" ä¸¢å¤±ã€‚è§£å†³æ–¹æ¡ˆï¼šå…¨å±€èŠ‚ç‚¹ã€å›¾Transformer</li>
    <li><strong>è¡¨è¾¾åŠ›é™åˆ¶</strong>ï¼šæ ‡å‡† MPNN çš„è¡¨è¾¾åŠ›ç­‰ä»·äº 1-WL æµ‹è¯•ï¼Œæ— æ³•åŒºåˆ†æŸäº›éåŒæ„å›¾ã€‚è§£å†³æ–¹æ¡ˆï¼šé«˜é˜¶ GNNã€å­å›¾æ–¹æ³•</li>
    <li><strong>å¤§å›¾å¯æ‰©å±•æ€§</strong>ï¼šå…¨è¿æ¥å›¾çš„è¾¹æ•°ä¸º $O(N^2)$ï¼Œå¯¹å¤§ç³»ç»Ÿä¸å¯è¡Œã€‚è§£å†³æ–¹æ¡ˆï¼šç¨€ç–å›¾ã€é‡‡æ ·</li>
  </ul>
</div>

<!-- ===== 7.6 ===== -->
<h3 id="ch7-recent">7.6 æœ€æ–°è¿›å±•</h3>

<table>
  <thead>
    <tr><th>æ–¹æ³•</th><th>æ ¸å¿ƒåˆ›æ–°</th><th>ä¼˜åŠ¿</th></tr>
  </thead>
  <tbody>
    <tr><td><strong>SEGNN</strong> (Steerable E(3) Equivariant GNN)</td><td>çƒè°å‡½æ•°è¡¨ç¤ºï¼Œä¸¥æ ¼ E(3) ç­‰å˜</td><td>å®Œç¾çš„æ—‹è½¬/å¹³ç§»/åå°„ä¸å˜æ€§</td></tr>
    <tr><td><strong>Equivariant GNN</strong></td><td>ç­‰å˜çº¿æ€§å±‚ + éçº¿æ€§</td><td>ä¸éœ€è¦æ•°æ®å¢å¼ºå³å¯æ³›åŒ–åˆ°ä»»æ„æœå‘</td></tr>
    <tr><td><strong>Geometric Algebra GNN</strong></td><td>ç”¨å‡ ä½•ä»£æ•°æ›¿ä»£å‘é‡è¿ç®—</td><td>ç»Ÿä¸€æ ‡é‡/å‘é‡/åŒå‘é‡çš„å¤„ç†</td></tr>
    <tr><td><strong>Graph Transformer</strong></td><td>å…¨å±€æ³¨æ„åŠ›å–ä»£å±€éƒ¨æ¶ˆæ¯ä¼ é€’</td><td>è§£å†³è¿‡å‹ç¼©ï¼Œæ•è·é•¿è·ç¦»ä¾èµ–</td></tr>
    <tr><td><strong>Neural ODE + GNN</strong></td><td>è¿ç»­æ—¶é—´æ¶ˆæ¯ä¼ é€’</td><td>è‡ªé€‚åº”æ—¶é—´æ­¥é•¿ï¼Œæ›´ç‰©ç†</td></tr>
  </tbody>
</table>


<!-- ================================================================ -->
<!-- ç¬¬å…«ç«  -->
<!-- ================================================================ -->
<h2 id="ch8">ç¬¬å…«ç« ï¼šå®è·µç»ƒä¹ </h2>

<h3 id="ch8-scratch">8.1 ä»é›¶æ„å»ºä¸€ä¸ªç®€å•çš„ GNNï¼ˆçº¯ PyTorchï¼‰</h3>

<div class="code-container">
  <div class="code-header"><span>Python â€” ä»é›¶å®ç° GNNï¼ˆä¸ç”¨ PyGï¼‰</span><button class="copy-btn" onclick="copyCode(this)">å¤åˆ¶</button></div>
  <pre><code><span class="kw">import</span> torch
<span class="kw">import</span> torch.nn <span class="kw">as</span> nn

<span class="kw">class</span> <span class="cls">SimpleGNN</span>(nn.Module):
    <span class="str">"""
    ä»é›¶å®ç°çš„ç®€å• GNNï¼ˆä¸ä¾èµ– PyGï¼‰
    ç”¨äºç†è§£æ¶ˆæ¯ä¼ é€’çš„æœ¬è´¨
    """</span>
    <span class="kw">def</span> <span class="fn">__init__</span>(<span class="sf">self</span>, node_dim, edge_dim, hidden_dim, output_dim, n_layers=<span class="num">3</span>):
        <span class="bi">super</span>().__init__()
        <span class="sf">self</span>.n_layers = n_layers
        
        <span class="cmt"># èŠ‚ç‚¹ç¼–ç å™¨</span>
        <span class="sf">self</span>.node_encoder = nn.Linear(node_dim, hidden_dim)
        
        <span class="cmt"># æ¶ˆæ¯å‡½æ•° (æ¯å±‚å…±äº«æˆ–ç‹¬ç«‹)</span>
        <span class="sf">self</span>.message_mlps = nn.ModuleList([
            nn.Sequential(
                nn.Linear(<span class="num">2</span> * hidden_dim + edge_dim, hidden_dim),
                nn.ReLU(),
                nn.Linear(hidden_dim, hidden_dim)
            ) <span class="kw">for</span> _ <span class="kw">in</span> <span class="bi">range</span>(n_layers)
        ])
        
        <span class="cmt"># æ›´æ–°å‡½æ•°</span>
        <span class="sf">self</span>.update_mlps = nn.ModuleList([
            nn.Sequential(
                nn.Linear(<span class="num">2</span> * hidden_dim, hidden_dim),
                nn.ReLU(),
                nn.Linear(hidden_dim, hidden_dim)
            ) <span class="kw">for</span> _ <span class="kw">in</span> <span class="bi">range</span>(n_layers)
        ])
        
        <span class="cmt"># è§£ç å™¨</span>
        <span class="sf">self</span>.decoder = nn.Linear(hidden_dim, output_dim)
    
    <span class="kw">def</span> <span class="fn">forward</span>(<span class="sf">self</span>, x, edge_index, edge_attr):
        <span class="str">"""
        x: èŠ‚ç‚¹ç‰¹å¾ [N, node_dim]
        edge_index: [2, E]
        edge_attr: [E, edge_dim]
        """</span>
        N = x.shape[<span class="num">0</span>]
        src, tgt = edge_index[<span class="num">0</span>], edge_index[<span class="num">1</span>]
        
        <span class="cmt"># ç¼–ç </span>
        h = torch.relu(<span class="sf">self</span>.node_encoder(x))
        
        <span class="cmt"># å¤šè½®æ¶ˆæ¯ä¼ é€’</span>
        <span class="kw">for</span> l <span class="kw">in</span> <span class="bi">range</span>(<span class="sf">self</span>.n_layers):
            <span class="cmt"># Step 1: è®¡ç®—æ¶ˆæ¯ (å¯¹æ¯æ¡è¾¹)</span>
            h_src = h[src]  <span class="cmt"># [E, hidden_dim]</span>
            h_tgt = h[tgt]  <span class="cmt"># [E, hidden_dim]</span>
            msg_input = torch.cat([h_tgt, h_src, edge_attr], dim=-<span class="num">1</span>)
            messages = <span class="sf">self</span>.message_mlps[l](msg_input)  <span class="cmt"># [E, hidden_dim]</span>
            
            <span class="cmt"># Step 2: èšåˆ (scatter_add â€” å¯¹åŒä¸€ç›®æ ‡èŠ‚ç‚¹çš„æ¶ˆæ¯æ±‚å’Œ)</span>
            aggregated = torch.zeros(N, messages.shape[<span class="num">1</span>], device=x.device)
            aggregated.scatter_add_(<span class="num">0</span>, tgt.unsqueeze(<span class="num">1</span>).expand_as(messages), messages)
            
            <span class="cmt"># Step 3: æ›´æ–° (å¸¦æ®‹å·®)</span>
            upd_input = torch.cat([h, aggregated], dim=-<span class="num">1</span>)
            h = h + <span class="sf">self</span>.update_mlps[l](upd_input)  <span class="cmt"># æ®‹å·®è¿æ¥</span>
        
        <span class="cmt"># è§£ç </span>
        <span class="kw">return</span> <span class="sf">self</span>.decoder(h)


<span class="cmt"># ===== æµ‹è¯• =====</span>
<span class="kw">if</span> __name__ == <span class="str">"__main__"</span>:
    <span class="cmt"># PushBox é…ç½®</span>
    model = SimpleGNN(
        node_dim=<span class="num">6</span>,       <span class="cmt"># pos(3) + vel(3)</span>
        edge_dim=<span class="num">4</span>,       <span class="cmt"># rel_pos(3) + dist(1)</span>
        hidden_dim=<span class="num">64</span>,
        output_dim=<span class="num">3</span>,     <span class="cmt"># åŠ é€Ÿåº¦(3)</span>
        n_layers=<span class="num">3</span>,
    )
    
    <span class="cmt"># æ„å»º PushBox å›¾</span>
    x = torch.randn(<span class="num">2</span>, <span class="num">6</span>)         <span class="cmt"># 2 ä¸ªèŠ‚ç‚¹</span>
    edge_index = torch.tensor([[<span class="num">0</span>,<span class="num">1</span>],[<span class="num">1</span>,<span class="num">0</span>]])
    edge_attr = torch.randn(<span class="num">2</span>, <span class="num">4</span>)  <span class="cmt"># 2 æ¡è¾¹</span>
    
    acc = model(x, edge_index, edge_attr)
    <span class="bi">print</span>(f<span class="str">"Input: {x.shape}, Output: {acc.shape}"</span>)
    <span class="bi">print</span>(f<span class="str">"Predicted accelerations:\n{acc}"</span>)
    <span class="bi">print</span>(f<span class="str">"Parameters: {sum(p.numel() for p in model.parameters()):,}"</span>)</code></pre>
</div>

<div class="box theorem">
  <div class="box-title">ğŸ“— æ ¸å¿ƒè¦ç‚¹</div>
  <p><code>scatter_add_</code> æ˜¯æ¶ˆæ¯ä¼ é€’çš„æ ¸å¿ƒæ“ä½œï¼šå®ƒå°†æ¯æ¡è¾¹çš„æ¶ˆæ¯æ ¹æ® <strong>ç›®æ ‡èŠ‚ç‚¹ç¼–å·</strong> ç´¯åŠ åˆ°å¯¹åº”ä½ç½®ã€‚è¿™æ­£æ˜¯ PyG çš„ <code>propagate()</code> å†…éƒ¨åšçš„äº‹ã€‚</p>
</div>

<!-- ===== 8.2 ===== -->
<h3 id="ch8-pyg">8.2 ç”¨ PyG æ„å»ºå®Œæ•´çš„ GNS</h3>

<div class="code-container">
  <div class="code-header"><span>Python â€” å®Œæ•´ GNS å®ç° (PyG)</span><button class="copy-btn" onclick="copyCode(this)">å¤åˆ¶</button></div>
  <pre><code><span class="kw">import</span> torch
<span class="kw">import</span> torch.nn <span class="kw">as</span> nn
<span class="kw">from</span> torch_geometric.nn <span class="kw">import</span> MessagePassing
<span class="kw">from</span> torch_geometric.data <span class="kw">import</span> Data, Batch

<span class="kw">class</span> <span class="cls">GNSLayer</span>(MessagePassing):
    <span class="str">"""ä¸€å±‚ GNS æ¶ˆæ¯ä¼ é€’"""</span>
    <span class="kw">def</span> <span class="fn">__init__</span>(<span class="sf">self</span>, node_dim, edge_dim):
        <span class="bi">super</span>().__init__(aggr=<span class="str">'add'</span>)
        <span class="sf">self</span>.msg = nn.Sequential(
            nn.Linear(<span class="num">2</span> * node_dim + edge_dim, node_dim),
            nn.LayerNorm(node_dim), nn.ReLU(),
            nn.Linear(node_dim, node_dim),
        )
        <span class="sf">self</span>.upd = nn.Sequential(
            nn.Linear(<span class="num">2</span> * node_dim, node_dim),
            nn.LayerNorm(node_dim), nn.ReLU(),
            nn.Linear(node_dim, node_dim),
        )
    
    <span class="kw">def</span> <span class="fn">forward</span>(<span class="sf">self</span>, x, edge_index, edge_attr):
        <span class="kw">return</span> <span class="sf">self</span>.propagate(edge_index, x=x, edge_attr=edge_attr)
    
    <span class="kw">def</span> <span class="fn">message</span>(<span class="sf">self</span>, x_i, x_j, edge_attr):
        <span class="kw">return</span> <span class="sf">self</span>.msg(torch.cat([x_i, x_j, edge_attr], dim=-<span class="num">1</span>))
    
    <span class="kw">def</span> <span class="fn">update</span>(<span class="sf">self</span>, aggr_out, x):
        <span class="kw">return</span> <span class="sf">self</span>.upd(torch.cat([x, aggr_out], dim=-<span class="num">1</span>)) + x  <span class="cmt"># æ®‹å·®</span>


<span class="kw">class</span> <span class="cls">GNS</span>(nn.Module):
    <span class="str">"""å®Œæ•´çš„ Graph Network Simulator"""</span>
    <span class="kw">def</span> <span class="fn">__init__</span>(<span class="sf">self</span>, node_in=<span class="num">6</span>, edge_in=<span class="num">8</span>, hidden=<span class="num">128</span>, layers=<span class="num">5</span>, out=<span class="num">3</span>):
        <span class="bi">super</span>().__init__()
        <span class="cmt"># Encoder</span>
        <span class="sf">self</span>.node_enc = nn.Sequential(nn.Linear(node_in, hidden), nn.ReLU())
        <span class="sf">self</span>.edge_enc = nn.Sequential(nn.Linear(edge_in, hidden), nn.ReLU())
        <span class="cmt"># Processor</span>
        <span class="sf">self</span>.layers = nn.ModuleList([GNSLayer(hidden, hidden) <span class="kw">for</span> _ <span class="kw">in</span> <span class="bi">range</span>(layers)])
        <span class="cmt"># Decoder</span>
        <span class="sf">self</span>.decoder = nn.Sequential(
            nn.Linear(hidden, hidden), nn.ReLU(),
            nn.Linear(hidden, out)
        )
    
    <span class="kw">def</span> <span class="fn">forward</span>(<span class="sf">self</span>, data):
        x = <span class="sf">self</span>.node_enc(data.x)
        e = <span class="sf">self</span>.edge_enc(data.edge_attr)
        <span class="kw">for</span> layer <span class="kw">in</span> <span class="sf">self</span>.layers:
            x = layer(x, data.edge_index, e)
        <span class="kw">return</span> <span class="sf">self</span>.decoder(x)

<span class="cmt"># ä½¿ç”¨</span>
model = GNS(node_in=<span class="num">6</span>, edge_in=<span class="num">8</span>, hidden=<span class="num">128</span>, layers=<span class="num">5</span>, out=<span class="num">3</span>)
<span class="bi">print</span>(f<span class="str">"Parameters: {sum(p.numel() for p in model.parameters()):,}"</span>)</code></pre>
</div>

<!-- ===== 8.3 ===== -->
<h3 id="ch8-pushbox">8.3 åœ¨ PushBox ä¸Šè®­ç»ƒçš„å®Œæ•´è„šæœ¬</h3>

<div class="code-container">
  <div class="code-header"><span>Python â€” å®Œæ•´è®­ç»ƒè„šæœ¬</span><button class="copy-btn" onclick="copyCode(this)">å¤åˆ¶</button></div>
  <pre><code><span class="str">"""å®Œæ•´çš„ GNS + PPO PushBox è®­ç»ƒè„šæœ¬"""</span>
<span class="kw">import</span> sys, os
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

<span class="kw">from</span> stable_baselines3 <span class="kw">import</span> PPO
<span class="kw">from</span> stable_baselines3.common.vec_env <span class="kw">import</span> DummyVecEnv
<span class="kw">from</span> stable_baselines3.common.callbacks <span class="kw">import</span> BaseCallback
<span class="kw">from</span> environments.push_box_env <span class="kw">import</span> make_push_box_env
<span class="kw">from</span> baselines.gns_baseline <span class="kw">import</span> GNSFeaturesExtractor
<span class="kw">import</span> numpy <span class="kw">as</span> np

<span class="kw">class</span> <span class="cls">SuccessTracker</span>(BaseCallback):
    <span class="str">"""è·Ÿè¸ªé¦–æ¬¡æˆåŠŸçš„ episode"""</span>
    <span class="kw">def</span> <span class="fn">__init__</span>(<span class="sf">self</span>):
        <span class="bi">super</span>().__init__()
        <span class="sf">self</span>.episode_count = <span class="num">0</span>
        <span class="sf">self</span>.first_success = <span class="kw">None</span>
    
    <span class="kw">def</span> <span class="fn">_on_step</span>(<span class="sf">self</span>):
        <span class="kw">if</span> <span class="sf">self</span>.locals.get(<span class="str">'dones'</span>, [<span class="kw">False</span>])[<span class="num">0</span>]:
            <span class="sf">self</span>.episode_count += <span class="num">1</span>
            info = <span class="sf">self</span>.locals.get(<span class="str">'infos'</span>, [{}])[<span class="num">0</span>]
            <span class="kw">if</span> info.get(<span class="str">'success'</span>) <span class="kw">and</span> <span class="sf">self</span>.first_success <span class="kw">is</span> <span class="kw">None</span>:
                <span class="sf">self</span>.first_success = <span class="sf">self</span>.episode_count
                <span class="bi">print</span>(f<span class="str">"\nğŸ‰ é¦–æ¬¡æˆåŠŸ! Episode {self.episode_count}"</span>)
        <span class="kw">return</span> <span class="kw">True</span>

<span class="cmt"># é…ç½®</span>
N_ENVS = <span class="num">4</span>
TOTAL_TIMESTEPS = <span class="num">80_000</span>

<span class="cmt"># åˆ›å»ºç¯å¢ƒ</span>
env = DummyVecEnv([make_push_box_env(box_mass=<span class="num">1.0</span>) <span class="kw">for</span> _ <span class="kw">in</span> <span class="bi">range</span>(N_ENVS)])

<span class="cmt"># åˆ›å»ºæ¨¡å‹ (PPO + GNS)</span>
model = PPO(
    <span class="str">"MlpPolicy"</span>, env,
    learning_rate=<span class="num">3e-4</span>,
    n_steps=<span class="num">2048</span>,
    batch_size=<span class="num">64</span>,
    n_epochs=<span class="num">10</span>,
    gamma=<span class="num">0.99</span>,
    policy_kwargs=<span class="bi">dict</span>(
        features_extractor_class=GNSFeaturesExtractor,
        features_extractor_kwargs=<span class="bi">dict</span>(features_dim=<span class="num">128</span>),
    ),
    verbose=<span class="num">1</span>,
)

<span class="cmt"># è®­ç»ƒ</span>
tracker = SuccessTracker()
model.learn(total_timesteps=TOTAL_TIMESTEPS, callback=tracker)

<span class="bi">print</span>(f<span class="str">"\nè®­ç»ƒå®Œæˆ! é¦–æ¬¡æˆåŠŸ episode: {tracker.first_success}"</span>)
model.save(<span class="str">"models/gns_pushbox_final"</span>)</code></pre>
</div>

<!-- ===== 8.4 ===== -->
<h3 id="ch8-viz">8.4 å¯è§†åŒ–æ¶ˆæ¯ä¼ é€’</h3>

<div class="code-container">
  <div class="code-header"><span>Python â€” å¯è§†åŒ–æ¶ˆæ¯å¼ºåº¦</span><button class="copy-btn" onclick="copyCode(this)">å¤åˆ¶</button></div>
  <pre><code><span class="kw">import</span> matplotlib.pyplot <span class="kw">as</span> plt
<span class="kw">import</span> networkx <span class="kw">as</span> nx
<span class="kw">import</span> torch

<span class="kw">def</span> <span class="fn">visualize_messages</span>(model, graph, layer_idx=<span class="num">0</span>):
    <span class="str">"""å¯è§†åŒ–æ¶ˆæ¯ä¼ é€’ä¸­çš„æ¶ˆæ¯å¼ºåº¦"""</span>
    <span class="cmt"># Hook è·å–æ¶ˆæ¯</span>
    messages_captured = []
    
    <span class="kw">def</span> <span class="fn">hook_fn</span>(module, input, output):
        messages_captured.append(output.detach())
    
    <span class="cmt"># æ³¨å†Œ hook</span>
    handle = model.gn_layers[layer_idx].edge_mlp.register_forward_hook(hook_fn)
    
    <span class="cmt"># å‰å‘ä¼ æ’­</span>
    <span class="kw">with</span> torch.no_grad():
        _ = model(graph)
    
    handle.remove()
    
    <span class="cmt"># è®¡ç®—æ¶ˆæ¯å¼ºåº¦ (L2 èŒƒæ•°)</span>
    msg = messages_captured[<span class="num">0</span>]
    msg_strength = torch.norm(msg, dim=-<span class="num">1</span>).numpy()
    
    <span class="cmt"># ç»˜åˆ¶å›¾</span>
    G = nx.DiGraph()
    edge_index = graph.edge_index.numpy()
    pos_dict = {}
    
    <span class="kw">for</span> i <span class="kw">in</span> <span class="bi">range</span>(graph.num_nodes):
        G.add_node(i)
        pos_dict[i] = graph.x[i, :<span class="num">2</span>].numpy()
    
    edge_colors = []
    <span class="kw">for</span> e <span class="kw">in</span> <span class="bi">range</span>(edge_index.shape[<span class="num">1</span>]):
        s, t = edge_index[<span class="num">0</span>, e], edge_index[<span class="num">1</span>, e]
        G.add_edge(s, t)
        edge_colors.append(msg_strength[e])
    
    fig, ax = plt.subplots(<span class="num">1</span>, <span class="num">1</span>, figsize=(<span class="num">8</span>, <span class="num">6</span>))
    nx.draw(G, pos_dict, ax=ax,
            edge_color=edge_colors, edge_cmap=plt.cm.Reds,
            node_color=<span class="str">'lightblue'</span>, node_size=<span class="num">500</span>,
            width=<span class="num">3</span>, with_labels=<span class="kw">True</span>, font_weight=<span class="str">'bold'</span>)
    plt.colorbar(plt.cm.ScalarMappable(cmap=plt.cm.Reds), ax=ax, label=<span class="str">'æ¶ˆæ¯å¼ºåº¦'</span>)
    plt.title(f<span class="str">'ç¬¬ {layer_idx} å±‚æ¶ˆæ¯ä¼ é€’å¯è§†åŒ–'</span>)
    plt.show()</code></pre>
</div>

<!-- ===== 8.5 ===== -->
<h3 id="ch8-hyper">8.5 è¶…å‚æ•°å®éªŒ</h3>

<table>
  <thead>
    <tr><th>è¶…å‚æ•°</th><th>å»ºè®®èŒƒå›´</th><th>å½±å“</th></tr>
  </thead>
  <tbody>
    <tr><td>æ¶ˆæ¯ä¼ é€’å±‚æ•°</td><td>1 ~ 10</td><td>å¢å¤§æ„Ÿå—é‡ï¼Œä½†è¿‡å¤šå¯¼è‡´è¿‡å¹³æ»‘</td></tr>
    <tr><td>éšè—ç»´åº¦</td><td>64 ~ 256</td><td>å¢å¤§è¡¨è¾¾åŠ›ï¼Œä½†å¢åŠ è®¡ç®—é‡å’Œè¿‡æ‹Ÿåˆé£é™©</td></tr>
    <tr><td>èšåˆæ–¹å¼</td><td>sum / mean / max</td><td>sum ä¿ç•™é‚»å±…æ•°é‡ä¿¡æ¯ï¼ˆç‰©ç†å¸¸ç”¨ï¼‰</td></tr>
    <tr><td>æ®‹å·®è¿æ¥</td><td>æœ‰ / æ— </td><td>æ·±å±‚ç½‘ç»œå¿…éœ€ï¼Œé˜²æ­¢æ¢¯åº¦æ¶ˆå¤±</td></tr>
    <tr><td>å½’ä¸€åŒ–</td><td>LayerNorm / BatchNorm / æ— </td><td>ç¨³å®šè®­ç»ƒï¼ŒLayerNorm å¯¹å›¾æ›´å‹å¥½</td></tr>
    <tr><td>å­¦ä¹ ç‡</td><td>1e-4 ~ 3e-3</td><td>PPO ä¸ GNS è”åˆè®­ç»ƒï¼Œé€šå¸¸ 3e-4 é€‚ä¸­</td></tr>
  </tbody>
</table>

<div class="code-container">
  <div class="code-header"><span>Python â€” è¶…å‚æ•°æ‰«ææ¡†æ¶</span><button class="copy-btn" onclick="copyCode(this)">å¤åˆ¶</button></div>
  <pre><code><span class="kw">import</span> itertools

configs = {
    <span class="str">'n_layers'</span>: [<span class="num">1</span>, <span class="num">3</span>, <span class="num">5</span>, <span class="num">10</span>],
    <span class="str">'hidden_dim'</span>: [<span class="num">64</span>, <span class="num">128</span>, <span class="num">256</span>],
    <span class="str">'aggr'</span>: [<span class="str">'add'</span>, <span class="str">'mean'</span>],
}

results = []
<span class="kw">for</span> n_layers, hidden, aggr <span class="kw">in</span> itertools.product(
    configs[<span class="str">'n_layers'</span>], configs[<span class="str">'hidden_dim'</span>], configs[<span class="str">'aggr'</span>]
):
    <span class="bi">print</span>(f<span class="str">"Testing: layers={n_layers}, hidden={hidden}, aggr={aggr}"</span>)
    <span class="cmt"># ... è®­ç»ƒå¹¶è¯„ä¼° ...</span>
    <span class="cmt"># results.append({'config': ..., 'success_rate': ..., 'episodes_to_success': ...})</span></code></pre>
</div>


<!-- ================================================================ -->
<!-- é™„å½• -->
<!-- ================================================================ -->
<h2 id="appendix">é™„å½•</h2>

<h3 id="appendix-formula">A. GNS æ ¸å¿ƒå…¬å¼é€ŸæŸ¥è¡¨</h3>

<table>
  <thead>
    <tr><th>å…¬å¼</th><th>åç§°</th><th>è¯´æ˜</th></tr>
  </thead>
  <tbody>
    <tr>
      <td>$\mathbf{m}_{ij} = \phi(\mathbf{x}_i, \mathbf{x}_j, \mathbf{e}_{ij})$</td>
      <td>æ¶ˆæ¯å‡½æ•°</td>
      <td>è¾¹ä¸Šçš„ä¿¡æ¯è®¡ç®—</td>
    </tr>
    <tr>
      <td>$\mathbf{M}_i = \sum_{j \in \mathcal{N}(i)} \mathbf{m}_{ij}$</td>
      <td>èšåˆ</td>
      <td>é‚»å±…æ¶ˆæ¯æ±‚å’Œ</td>
    </tr>
    <tr>
      <td>$\mathbf{x}_i' = \gamma(\mathbf{x}_i, \mathbf{M}_i)$</td>
      <td>æ›´æ–°å‡½æ•°</td>
      <td>èŠ‚ç‚¹ç‰¹å¾æ›´æ–°</td>
    </tr>
    <tr>
      <td>$\mathbf{r}_{ij} = \mathbf{x}_j - \mathbf{x}_i$</td>
      <td>ä½ç§»å‘é‡</td>
      <td>åå¯¹ç§°: $\mathbf{r}_{ij} = -\mathbf{r}_{ji}$</td>
    </tr>
    <tr>
      <td>$\ddot{\mathbf{x}}_i = \text{Decode}(\mathbf{h}_i^{(L)})$</td>
      <td>åŠ é€Ÿåº¦é¢„æµ‹</td>
      <td>GNS æœ€ç»ˆè¾“å‡º</td>
    </tr>
    <tr>
      <td>$\mathbf{v}_{t+1} = \mathbf{v}_t + \Delta t \cdot \ddot{\mathbf{x}}$</td>
      <td>Euler ç§¯åˆ†</td>
      <td>é€Ÿåº¦æ›´æ–°</td>
    </tr>
    <tr>
      <td>$\hat{\mathbf{A}} = \hat{D}^{-1/2} \hat{A} \hat{D}^{-1/2}$</td>
      <td>GCN å½’ä¸€åŒ–</td>
      <td>å¯¹ç§°å½’ä¸€åŒ–é‚»æ¥çŸ©é˜µ</td>
    </tr>
    <tr>
      <td>$\alpha_{ij} = \text{softmax}_j(a^T [Wx_i \| Wx_j])$</td>
      <td>GAT æ³¨æ„åŠ›</td>
      <td>å¯å­¦ä¹ è¾¹æƒé‡</td>
    </tr>
  </tbody>
</table>

<h3 id="appendix-pyg">B. PyTorch Geometric å¸¸ç”¨ API</h3>

<table>
  <thead>
    <tr><th>ç±»/å‡½æ•°</th><th>ç”¨é€”</th><th>ç¤ºä¾‹</th></tr>
  </thead>
  <tbody>
    <tr><td><code>Data(x, edge_index, ...)</code></td><td>å•å›¾æ•°æ®</td><td><code>Data(x=feats, edge_index=edges)</code></td></tr>
    <tr><td><code>Batch.from_data_list()</code></td><td>æ‰¹é‡å›¾</td><td><code>Batch.from_data_list([g1, g2])</code></td></tr>
    <tr><td><code>MessagePassing</code></td><td>æ¶ˆæ¯ä¼ é€’åŸºç±»</td><td>å­ç±»åŒ–ï¼Œå®šä¹‰ message/update</td></tr>
    <tr><td><code>GCNConv</code></td><td>GCN å±‚</td><td><code>GCNConv(16, 32)(x, edge_index)</code></td></tr>
    <tr><td><code>GATConv</code></td><td>GAT å±‚</td><td><code>GATConv(16, 32, heads=4)</code></td></tr>
    <tr><td><code>SAGEConv</code></td><td>GraphSAGE å±‚</td><td><code>SAGEConv(16, 32)</code></td></tr>
    <tr><td><code>radius_graph</code></td><td>è·ç¦»é˜ˆå€¼å»ºå›¾</td><td><code>radius_graph(pos, r=0.5)</code></td></tr>
    <tr><td><code>knn_graph</code></td><td>KNN å»ºå›¾</td><td><code>knn_graph(pos, k=6)</code></td></tr>
    <tr><td><code>global_mean_pool</code></td><td>å›¾çº§æ± åŒ–</td><td><code>global_mean_pool(x, batch)</code></td></tr>
  </tbody>
</table>

<h3 id="appendix-papers">C. å…³é”®è®ºæ–‡åˆ—è¡¨</h3>

<table>
  <thead>
    <tr><th>è®ºæ–‡</th><th>å¹´ä»½</th><th>æ ¸å¿ƒè´¡çŒ®</th></tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>Learning to Simulate Complex Physics with Graph Networks</strong><br>Sanchez-Gonzalez et al.</td>
      <td>2020</td>
      <td>GNS åŸå§‹è®ºæ–‡ï¼ŒEncode-Process-Decode æ¶æ„</td>
    </tr>
    <tr>
      <td><strong>Interaction Networks for Learning about Objects, Relations and Physics</strong><br>Battaglia et al.</td>
      <td>2016</td>
      <td>äº¤äº’ç½‘ç»œï¼ŒGNS çš„å‰èº«</td>
    </tr>
    <tr>
      <td><strong>Relational inductive biases, deep learning, and graph networks</strong><br>Battaglia et al.</td>
      <td>2018</td>
      <td>å›¾ç½‘ç»œçš„ç»Ÿä¸€æ¡†æ¶ (GN Block)</td>
    </tr>
    <tr>
      <td><strong>Neural Message Passing for Quantum Chemistry</strong><br>Gilmer et al.</td>
      <td>2017</td>
      <td>æ¶ˆæ¯ä¼ é€’ç¥ç»ç½‘ç»œ (MPNN) ç»Ÿä¸€æ¡†æ¶</td>
    </tr>
    <tr>
      <td><strong>Semi-Supervised Classification with Graph Convolutional Networks</strong><br>Kipf & Welling</td>
      <td>2017</td>
      <td>GCN åŸå§‹è®ºæ–‡</td>
    </tr>
    <tr>
      <td><strong>Graph Attention Networks</strong><br>VeliÄkoviÄ‡ et al.</td>
      <td>2018</td>
      <td>GAT åŸå§‹è®ºæ–‡</td>
    </tr>
    <tr>
      <td><strong>Inductive Representation Learning on Large Graphs</strong><br>Hamilton et al.</td>
      <td>2017</td>
      <td>GraphSAGE</td>
    </tr>
    <tr>
      <td><strong>Hamiltonian Graph Networks with ODE Integrators</strong><br>Sanchez-Gonzalez et al.</td>
      <td>2019</td>
      <td>å“ˆå¯†é¡¿åŠ›å­¦ + GNN</td>
    </tr>
  </tbody>
</table>

<h3 id="appendix-compare">D. æ–¹æ³•å¯¹æ¯”è¡¨</h3>

<table>
  <thead>
    <tr>
      <th>æ–¹æ³•</th>
      <th>è¾“å…¥ç»“æ„</th>
      <th>ç‰©ç†çº¦æŸ</th>
      <th>æ³›åŒ–æ€§</th>
      <th>æ ·æœ¬æ•ˆç‡</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>çº¯ MLP</td>
      <td>æ‰å¹³å‘é‡</td>
      <td>æ— </td>
      <td>å·®</td>
      <td>ä½</td>
    </tr>
    <tr>
      <td>GCN + RL</td>
      <td>å›¾ï¼ˆå›ºå®šæƒé‡ï¼‰</td>
      <td>æ— </td>
      <td>ä¸­</td>
      <td>ä¸­</td>
    </tr>
    <tr>
      <td>GNS (æ ‡å‡†)</td>
      <td>å›¾ï¼ˆå­¦ä¹ æ¶ˆæ¯ï¼‰</td>
      <td>æ— </td>
      <td>å¥½</td>
      <td>é«˜</td>
    </tr>
    <tr>
      <td>GNS + Edge Frame</td>
      <td>å›¾ï¼ˆå±€éƒ¨åæ ‡ï¼‰</td>
      <td>å¹³ç§»ä¸å˜</td>
      <td>å¾ˆå¥½</td>
      <td>å¾ˆé«˜</td>
    </tr>
    <tr>
      <td>Dynami-CAL GNN</td>
      <td>å›¾ï¼ˆç‰©ç†å¸§ï¼‰</td>
      <td>åŠ¨é‡+èƒ½é‡</td>
      <td>æå¥½</td>
      <td>æé«˜</td>
    </tr>
    <tr>
      <td>PhysRobot (Ours)</td>
      <td>åŒæµï¼ˆå›¾+MLPï¼‰</td>
      <td>å®Œæ•´å®ˆæ’å¾‹</td>
      <td>æœ€å¥½</td>
      <td>æœ€é«˜ (~12.5Ã—)</td>
    </tr>
  </tbody>
</table>


<!-- Footer -->
<div style="margin-top: 80px; padding: 30px 0; border-top: 2px solid var(--border-color); text-align: center; color: var(--text-muted); font-size: 14px;">
  <p>ğŸ“Š GNS å›¾ç½‘ç»œæ¨¡æ‹Ÿå™¨ â€” è¶…è¯¦ç»†å­¦ä¹ æ•™ç¨‹</p>
  <p>Medical Robotics Simulation Project Â· 2025</p>
  <p>Built with â¤ï¸ for physics-informed machine learning</p>
</div>

</div><!-- end main-content -->

<!-- Back to Top -->
<button class="back-to-top" id="backToTop" onclick="window.scrollTo({top:0,behavior:'smooth'})">â†‘</button>

<!-- ===== JavaScript ===== -->
<script>
// Theme toggle
function toggleTheme() {
  const html = document.documentElement;
  const current = html.getAttribute('data-theme');
  const next = current === 'dark' ? 'light' : 'dark';
  html.setAttribute('data-theme', next);
  localStorage.setItem('theme', next);
}

// Load saved theme
(function() {
  const saved = localStorage.getItem('theme');
  if (saved) document.documentElement.setAttribute('data-theme', saved);
  else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
    document.documentElement.setAttribute('data-theme', 'dark');
  }
})();

// Copy code button
function copyCode(btn) {
  const pre = btn.closest('.code-container').querySelector('pre');
  const text = pre.textContent || pre.innerText;
  navigator.clipboard.writeText(text).then(() => {
    btn.textContent = 'å·²å¤åˆ¶ âœ“';
    setTimeout(() => btn.textContent = 'å¤åˆ¶', 2000);
  });
}

// Progress bar
window.addEventListener('scroll', function() {
  const scrollTop = window.scrollY;
  const docHeight = document.documentElement.scrollHeight - window.innerHeight;
  const progress = (scrollTop / docHeight) * 100;
  document.getElementById('progress-fill').style.width = progress + '%';
  
  // Back to top button
  const btn = document.getElementById('backToTop');
  if (scrollTop > 400) btn.classList.add('visible');
  else btn.classList.remove('visible');
});

// Active sidebar link
const observer = new IntersectionObserver((entries) => {
  entries.forEach(entry => {
    if (entry.isIntersecting) {
      const id = entry.target.id;
      document.querySelectorAll('#sidebar-nav a').forEach(a => {
        a.classList.remove('active');
        if (a.getAttribute('href') === '#' + id) a.classList.add('active');
      });
    }
  });
}, { rootMargin: '-80px 0px -80% 0px' });

document.querySelectorAll('h2[id], h3[id]').forEach(h => observer.observe(h));

// Close sidebar on mobile when clicking a link
document.querySelectorAll('#sidebar-nav a').forEach(a => {
  a.addEventListener('click', () => {
    if (window.innerWidth <= 960) {
      document.getElementById('sidebar').classList.remove('open');
    }
  });
});
</script>

</body>
</html>